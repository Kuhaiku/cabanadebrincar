<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 p-6">

    <div class="max-w-6xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <a href="painel.html" class="text-slate-400 hover:text-pink-500"><i data-lucide="arrow-left"></i></a>
            Gest√£o de Pedidos
        </h1>
        <button onclick="carregarPedidos()" class="bg-white p-2 rounded-lg text-slate-500 hover:text-pink-500 shadow-sm transition-colors">
            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <table class="w-full text-left text-sm text-slate-600">
            <thead class="bg-slate-50 border-b border-slate-200 text-slate-400 uppercase font-bold text-xs">
                <tr>
                    <th class="p-4">Data Festa</th>
                    <th class="p-4">Cliente</th>
                    <th class="p-4">Estrutura</th>
                    <th class="p-4 text-center">Status</th>
                    <th class="p-4 text-center">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="lista-pedidos" class="divide-y divide-slate-100">
                </tbody>
        </table>
        <div id="loading" class="p-10 text-center text-slate-400">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
            Carregando pedidos...
        </div>
    </div>

    <div id="modal-detalhes" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative shadow-2xl flex flex-col md:flex-row overflow-hidden">
            
            <div class="w-full md:w-3/5 p-6 md:p-8 bg-white overflow-y-auto">
                <button onclick="fecharModal()" class="md:hidden absolute top-4 right-4 text-slate-400 hover:text-red-500 bg-slate-100 p-2 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>

                <h3 class="text-xl font-bold text-pink-600 mb-6 flex items-center gap-2 border-b pb-4 border-pink-100">
                    <i data-lucide="file-text"></i> Ficha do Evento
                </h3>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Cliente</p>
                            <p class="font-bold text-slate-800 text-lg" id="det-nome"></p>
                            <a id="det-whatsapp-link" href="#" target="_blank" class="flex items-center gap-1 text-xs text-green-600 font-bold hover:underline mt-1">
                                <i data-lucide="message-circle" class="w-3 h-3"></i> <span id="det-whatsapp"></span>
                            </a>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Data & Hora</p>
                            <p class="font-bold text-slate-800" id="det-data"></p>
                            <p class="text-sm text-slate-500" id="det-horario"></p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Endere√ßo Completo</p>
                        <p class="text-sm text-slate-600 font-medium mt-1" id="det-endereco"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-pink-50/50 p-4 rounded-xl border border-pink-100">
                        <p class="text-[10px] font-bold text-pink-400 uppercase tracking-wider mb-2">Estrutura</p>
                        <p class="text-sm text-slate-700"><strong>Modelo:</strong> <span id="det-modelo"></span></p>
                        <p class="text-sm text-slate-700"><strong>Qtd:</strong> <span id="det-qtd-barracas"></span> barracas</p>
                        <div class="mt-3 flex gap-2">
                            <div class="bg-white px-2 py-1 rounded border border-pink-200 text-xs text-pink-700 font-bold">
                                <span id="det-criancas"></span> Crian√ßas
                            </div>
                            <div class="bg-white px-2 py-1 rounded border border-pink-200 text-xs text-pink-700 font-bold">
                                <span id="det-faixa"></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100">
                        <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mb-2">Decora√ß√£o</p>
                        <p class="text-sm text-slate-700 mb-1"><strong>Tema:</strong> <span id="det-tema"></span></p>
                        <p class="text-xs text-slate-500 leading-relaxed bg-white p-2 rounded border border-indigo-100">
                            <strong>Cores:</strong> <span id="det-cores"></span>
                        </p>
                    </div>
                </div>

                <div class="mb-4">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Composi√ß√£o do Pacote</p>
                    <div class="flex flex-wrap gap-2 mb-3" id="det-itens-tags"></div>
                    <div class="flex flex-wrap gap-2" id="det-comida-tags"></div>
                </div>

                <div class="space-y-3">
                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        <p class="text-[10px] font-bold text-yellow-600 uppercase mb-1 flex items-center gap-1">
                            <i data-lucide="alert-circle" class="w-3 h-3"></i> Observa√ß√µes / Adicionais
                        </p>
                        <p class="text-xs text-slate-700 italic" id="det-obs"></p>
                    </div>
                    <div id="box-alergias" class="bg-red-50 p-3 rounded-lg border border-red-200 hidden">
                        <p class="text-[10px] font-bold text-red-600 uppercase mb-1 flex items-center gap-1">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i> Alergias / Restri√ß√µes
                        </p>
                        <p class="text-xs text-red-800 font-bold" id="det-alergias"></p>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-2/5 bg-slate-50 border-l border-slate-200 p-6 md:p-8 flex flex-col h-full">
                <button onclick="fecharModal()" class="hidden md:block absolute top-4 right-4 text-slate-400 hover:text-red-500">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <h4 class="font-bold text-slate-700 mb-6 uppercase text-xs tracking-widest flex items-center gap-2">
                    <i data-lucide="calculator" class="w-4 h-4"></i> Or√ßamento
                </h4>
                
                <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                    <div class="space-y-2 mb-6" id="container-taxas"></div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Ajustes / Descontos / Extras</label>
                        <input type="text" id="desc-extra" placeholder="Descri√ß√£o (ex: Desconto Cupom)" class="w-full mb-2 p-2 text-xs border rounded bg-slate-50 focus:bg-white transition-colors">
                        <div class="flex items-center">
                            <span class="p-2 bg-slate-100 rounded-l border-y border-l border-slate-200 text-slate-500 text-xs font-bold">R$</span>
                            <input type="number" id="valor-extra" value="0.00" step="0.01" oninput="calcularTotal()" class="w-full p-2 border border-slate-200 rounded-r text-sm font-bold text-slate-700 focus:outline-none focus:border-pink-300">
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">* Use valor negativo para descontos (ex: -60.00)</p>
                    </div>

                    <div id="resumo-valores" class="space-y-1 text-xs text-slate-500 font-mono border-t border-slate-200 pt-4"></div>
                </div>

                <div class="mt-4 pt-4 border-t border-slate-200 bg-slate-50">
                    <div class="flex justify-between items-end mb-4">
                        <span class="font-bold text-slate-600 text-sm">TOTAL ESTIMADO</span>
                        <span id="valor-total-display" class="font-bold text-3xl text-green-600 tracking-tight">R$ 0,00</span>
                    </div>

                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="copiarOrcamento()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-900 flex items-center justify-center gap-2 transition-all shadow-lg shadow-slate-200">
                            <i data-lucide="copy" class="w-4 h-4"></i> Copiar Resumo
                        </button>
                        <button onclick="enviarParaAgenda()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 flex items-center justify-center gap-2 transition-all shadow-lg shadow-green-200">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i> Aprovar & Agendar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const ADMIN_TOKEN = localStorage.getItem('cabana_admin_token');
        if(!ADMIN_TOKEN) window.location.href = 'painel.html';

        let pedidos = [];
        let precos = [];
        let pedidoAtual = null;

        async function init() {
            lucide.createIcons();
            await Promise.all([carregarPrecos(), carregarPedidos()]);
        }

        async function carregarPrecos() {
            try {
                const res = await fetch(`${API_URL}/admin/precos`, { headers: { 'x-admin-password': ADMIN_TOKEN } });
                precos = await res.json();
            } catch(e) { console.error(e); }
        }

        async function carregarPedidos() {
            const loading = document.getElementById('loading');
            const tbody = document.getElementById('lista-pedidos');
            
            try {
                loading.classList.remove('hidden');
                tbody.innerHTML = '';
                
                const res = await fetch(`${API_URL}/admin/pedidos`, { headers: { 'x-admin-password': ADMIN_TOKEN } });
                pedidos = await res.json();
                
                const pendentes = pedidos.filter(p => p.status_agenda === 'pendente' || !p.status_agenda);

                if(pendentes.length === 0) {
                    loading.innerHTML = '<p class="text-slate-400">Nenhum pedido pendente!</p>';
                    return;
                }
                loading.classList.add('hidden');

                pendentes.forEach(p => {
                    const dataFesta = new Date(p.data_festa).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition-colors border-b group">
                            <td class="p-4">
                                <div class="font-bold text-slate-700 text-lg">${dataFesta}</div>
                                <div class="text-xs text-slate-400 font-bold bg-slate-100 inline-block px-2 py-1 rounded mt-1">${p.horario}</div>
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-pink-600">${p.nome}</div>
                                <div class="text-xs text-slate-400">${p.whatsapp}</div>
                            </td>
                            <td class="p-4">
                                <div class="text-sm text-slate-600 font-medium">${p.qtd_barracas}x ${p.modelo_barraca}</div>
                                <div class="text-xs text-slate-400 mt-1">${p.tema || 'Sem tema'}</div>
                            </td>
                            <td class="p-4 text-center">
                                <span class="bg-yellow-100 text-yellow-700 text-xs font-bold px-2 py-1 rounded-full border border-yellow-200">Pendente</span>
                            </td>
                            <td class="p-4 text-center">
                                <button onclick="abrirModal(${p.id})" class="bg-white border-2 border-indigo-100 text-indigo-600 px-4 py-2 rounded-xl hover:bg-indigo-600 hover:text-white hover:border-indigo-600 font-bold text-sm transition-all shadow-sm">
                                    Ver Detalhes
                                </button>
                            </td>
                        </tr>
                    `;
                });
                lucide.createIcons();
            } catch(e) {
                loading.innerText = "Erro ao carregar pedidos.";
                console.error(e);
            }
        }

        function safeParse(json) {
            try { return JSON.parse(json) || []; } catch { return []; }
        }

        function abrirModal(id) {
            pedidoAtual = pedidos.find(p => p.id === id);
            if(!pedidoAtual) return;

            // Preencher Ficha T√©cnica
            document.getElementById('det-nome').innerText = pedidoAtual.nome;
            document.getElementById('det-whatsapp').innerText = pedidoAtual.whatsapp;
            document.getElementById('det-whatsapp-link').href = `https://wa.me/55${pedidoAtual.whatsapp.replace(/\D/g,'')}`;
            
            const dataFesta = new Date(pedidoAtual.data_festa).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            document.getElementById('det-data').innerText = dataFesta;
            document.getElementById('det-horario').innerText = pedidoAtual.horario;
            document.getElementById('det-endereco').innerText = pedidoAtual.endereco;

            document.getElementById('det-modelo').innerText = pedidoAtual.modelo_barraca;
            document.getElementById('det-qtd-barracas').innerText = pedidoAtual.qtd_barracas;
            document.getElementById('det-criancas').innerText = pedidoAtual.qtd_criancas;
            document.getElementById('det-faixa').innerText = pedidoAtual.faixa_etaria;

            document.getElementById('det-tema').innerText = pedidoAtual.tema || '-';
            document.getElementById('det-cores').innerText = pedidoAtual.cores || '-';
            document.getElementById('det-obs').innerText = pedidoAtual.itens_adicionais || 'Nenhuma observa√ß√£o extra.';

            // Alergias
            const boxAlergias = document.getElementById('box-alergias');
            if(pedidoAtual.alergias) {
                document.getElementById('det-alergias').innerText = pedidoAtual.alergias;
                boxAlergias.classList.remove('hidden');
            } else {
                boxAlergias.classList.add('hidden');
            }

            // Tags de Itens e Comida
            const divItens = document.getElementById('det-itens-tags');
            const divComida = document.getElementById('det-comida-tags');
            divItens.innerHTML = '';
            divComida.innerHTML = '';

            const itens = safeParse(pedidoAtual.itens_padrao);
            itens.forEach(i => {
                divItens.innerHTML += `<span class="bg-indigo-50 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded border border-indigo-100">${i}</span>`;
            });

            const comida = safeParse(pedidoAtual.alimentacao);
            comida.forEach(c => {
                divComida.innerHTML += `<span class="bg-pink-50 text-pink-700 text-[10px] font-bold px-2 py-1 rounded border border-pink-100 flex items-center gap-1"><i data-lucide="utensils" class="w-3 h-3"></i> ${c}</span>`;
            });

            // Preencher Calculadora
            const divTaxas = document.getElementById('container-taxas');
            divTaxas.innerHTML = '<p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Taxas Adicionais</p>';
            
            const taxasSistema = precos.filter(p => p.categoria === 'sistema');
            taxasSistema.forEach(t => {
                divTaxas.innerHTML += `
                    <label class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 cursor-pointer border border-transparent hover:border-slate-200 transition-all">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" class="chk-taxa w-4 h-4 text-pink-600 rounded focus:ring-pink-500 border-gray-300" 
                                   value="${t.valor}" data-nome="${t.descricao}" onchange="calcularTotal()">
                            <span class="text-xs text-slate-700 font-medium">${t.descricao}</span>
                        </div>
                        <span class="text-xs font-bold text-slate-500">+R$ ${t.valor}</span>
                    </label>
                `;
            });

            // Valores Extras Salvos
            document.getElementById('valor-extra').value = pedidoAtual.valor_itens_extras || 0;
            document.getElementById('desc-extra').value = pedidoAtual.descricao_itens_extras || '';

            calcularTotal();
            document.getElementById('modal-detalhes').classList.remove('hidden');
            lucide.createIcons();
        }

        function calcularTotal() {
            if(!pedidoAtual) return;
            let total = 0;
            let htmlResumo = '';

            // 1. Barracas
            const precoBarracaObj = precos.find(p => p.descricao === pedidoAtual.modelo_barraca);
            const precoBarraca = parseFloat(precoBarracaObj ? precoBarracaObj.valor : 0);
            const subBarraca = precoBarraca * pedidoAtual.qtd_barracas;
            total += subBarraca;
            htmlResumo += `<div class="flex justify-between"><span>${pedidoAtual.qtd_barracas}x ${pedidoAtual.modelo_barraca}</span> <span>R$ ${subBarraca.toFixed(2)}</span></div>`;

            // 2. Itens Fixos (Itens + Comida)
            const itensLista = [...safeParse(pedidoAtual.itens_padrao), ...safeParse(pedidoAtual.alimentacao)];
            
            itensLista.forEach(nome => {
                const itemDb = precos.find(p => p.descricao === nome);
                if(itemDb) {
                    const valorUnit = parseFloat(itemDb.valor);
                    let subItem = valorUnit;
                    let label = nome;

                    // Se for alimenta√ß√£o, multiplica por crian√ßas? (Regra de neg√≥cio: assumindo unit√°rio por crian√ßa se for categoria 'alimentacao')
                    if(itemDb.categoria === 'alimentacao') {
                        subItem = valorUnit * pedidoAtual.qtd_criancas;
                        label = `${pedidoAtual.qtd_criancas}x ${nome}`;
                    }

                    total += subItem;
                    htmlResumo += `<div class="flex justify-between text-slate-600"><span>${label}</span> <span>R$ ${subItem.toFixed(2)}</span></div>`;
                }
            });

            // 3. Taxas Selecionadas
            document.querySelectorAll('.chk-taxa:checked').forEach(chk => {
                const v = parseFloat(chk.value);
                total += v;
                htmlResumo += `<div class="flex justify-between text-indigo-600 font-medium"><span>Taxa: ${chk.dataset.nome}</span> <span>R$ ${v.toFixed(2)}</span></div>`;
            });

            // 4. Extras Manuais (Pode ser negativo)
            const extra = parseFloat(document.getElementById('valor-extra').value) || 0;
            total += extra;
            if(extra !== 0) {
                const cor = extra < 0 ? 'text-red-500' : 'text-green-600';
                htmlResumo += `<div class="flex justify-between ${cor} font-bold"><span>Ajuste Manual</span> <span>R$ ${extra.toFixed(2)}</span></div>`;
            }

            document.getElementById('resumo-valores').innerHTML = htmlResumo;
            document.getElementById('valor-total-display').innerText = `R$ ${total.toFixed(2)}`;
            pedidoAtual.totalCalculado = total.toFixed(2);
        }

        async function enviarParaAgenda() {
            if(!confirm(`Confirmar e Agendar festa de ${pedidoAtual.nome}?`)) return;

            const btn = document.querySelector("button[onclick='enviarParaAgenda()']");
            const txtOriginal = btn.innerHTML;
            btn.innerHTML = "Processando...";
            btn.disabled = true;

            const extraVal = document.getElementById('valor-extra').value;
            const extraDesc = document.getElementById('desc-extra').value;

            try {
                // 1. Salvar Financeiro
                await fetch(`${API_URL}/admin/pedidos/${pedidoAtual.id}/financeiro`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-password': ADMIN_TOKEN },
                    body: JSON.stringify({
                        valor_final: pedidoAtual.totalCalculado,
                        valor_itens_extras: extraVal,
                        descricao_itens_extras: extraDesc
                    })
                });

                // 2. Mover para Agenda
                await fetch(`${API_URL}/admin/agenda/aprovar/${pedidoAtual.id}`, {
                    method: 'PUT',
                    headers: { 'x-admin-password': ADMIN_TOKEN }
                });

                alert("‚úÖ Pedido Aprovado e Agendado!");
                fecharModal();
                init();
            } catch(e) {
                alert("Erro ao processar.");
                btn.innerHTML = txtOriginal;
                btn.disabled = false;
            }
        }

        async function copiarOrcamento() {
            const itens = [...safeParse(pedidoAtual.itens_padrao), ...safeParse(pedidoAtual.alimentacao)];
            const dataFesta = new Date(pedidoAtual.data_festa).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            
            let txt = `Ol√° *${pedidoAtual.nome}*! Tudo bem? ‚ú®\nSegue o resumo do seu pedido na *Cabana de Brincar*:\n\n`;
            txt += `üìÖ *Data:* ${dataFesta} √†s ${pedidoAtual.horario}\n`;
            txt += `‚õ∫ *Estrutura:* ${pedidoAtual.qtd_barracas}x ${pedidoAtual.modelo_barraca} (Tema: ${pedidoAtual.tema})\n`;
            txt += `üé® *Cores:* ${pedidoAtual.cores}\n`;
            txt += `üìã *Itens:* ${itens.join(', ') || 'Padr√£o'}\n`;
            
            const extraDesc = document.getElementById('desc-extra').value;
            if(extraDesc) txt += `üîñ *Obs:* ${extraDesc}\n`;
            
            txt += `\nüí∞ *Valor Total: R$ ${pedidoAtual.totalCalculado}*\n\nPodemos confirmar?`;

            await navigator.clipboard.writeText(txt);
            alert("Resumo copiado para a √°rea de transfer√™ncia!");
        }

        function fecharModal() {
            document.getElementById('modal-detalhes').classList.add('hidden');
        }

        init();
    </script>
</body>
</html>