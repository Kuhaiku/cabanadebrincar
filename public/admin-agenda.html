<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; }
        .fc-event { cursor: pointer; border: none !important; }
        .fc-daygrid-day.fc-day-today { background-color: #fdf2f8 !important; }
    </style>
</head>
<body class="bg-slate-50 p-6">

    <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <a href="painel.html" class="text-slate-400 hover:text-pink-500"><i data-lucide="arrow-left"></i></a>
            Agenda de Festas
        </h1>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <div id='calendar'></div>
    </div>

    <div id="modal-agenda" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 relative shadow-2xl">
            <button onclick="fecharModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500">
                <i data-lucide="x"></i>
            </button>

            <div class="text-center mb-6">
                <div class="bg-pink-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3 text-pink-600">
                    <i data-lucide="party-popper" class="w-8 h-8"></i>
                </div>
                <h3 id="agenda-cliente" class="text-xl font-bold text-slate-800">Cliente</h3>
                <p id="agenda-data" class="text-pink-500 font-bold text-sm">Data</p>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm space-y-3 mb-6">
                <p><strong>üìç Endere√ßo:</strong> <span id="agenda-endereco" class="text-slate-600"></span></p>
                <p><strong>‚õ∫ Barracas:</strong> <span id="agenda-barracas" class="text-slate-600"></span></p>
                <p><strong>üí∞ Valor Final:</strong> <span id="agenda-valor" class="text-green-600 font-bold"></span></p>
            </div>

            <div class="space-y-3">
                <button id="btn-gerar-link" onclick="gerarLinkAvaliacao()" class="w-full bg-indigo-50 text-indigo-600 font-bold py-3 rounded-xl hover:bg-indigo-100 flex items-center justify-center gap-2 transition-colors">
                    <i data-lucide="star"></i> Gerar Link Avalia√ß√£o
                </button>
                <div id="box-link" class="hidden bg-slate-800 p-3 rounded-lg text-center">
                    <p class="text-slate-400 text-xs mb-1">Link para o cliente:</p>
                    <input type="text" id="input-link" class="w-full bg-transparent text-white text-center text-sm font-mono border-none focus:ring-0" readonly>
                    <button onclick="copiarLink()" class="mt-2 text-xs bg-indigo-500 text-white px-3 py-1 rounded">Copiar</button>
                </div>

                <button onclick="concluirServico()" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 shadow-lg shadow-green-200 flex items-center justify-center gap-2 transition-transform active:scale-95">
                    <i data-lucide="check-circle-2"></i> Concluir Servi√ßo (Lan√ßar Custos)
                </button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_TOKEN = localStorage.getItem('cabana_admin_token');
        if(!ADMIN_TOKEN) window.location.href = 'painel.html';

        let eventoSelecionado = null;

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                events: function(info, successCallback, failureCallback) {
                    fetch('/api/admin/agenda', {
                        headers: { 'x-admin-password': ADMIN_TOKEN }
                    })
                    .then(res => res.json())
                    .then(data => {
                        const events = data.map(d => {
                            // Corre√ß√£o da data para garantir formato ISO
                            let dataFesta = d.data_festa;
                            if(dataFesta && dataFesta.includes('T')) {
                                dataFesta = dataFesta.split('T')[0];
                            }
                            const hora = d.horario ? d.horario : '12:00:00';
                            
                            return {
                                id: d.id,
                                title: `${d.nome} (${d.modelo_barraca})`,
                                start: `${dataFesta}T${hora}`,
                                backgroundColor: '#ec4899',
                                extendedProps: d
                            };
                        });
                        successCallback(events);
                    })
                    .catch(err => {
                        console.error(err);
                        failureCallback(err);
                    });
                },
                eventClick: function(info) {
                    abrirModalAgenda(info.event.extendedProps);
                }
            });
            calendar.render();
            lucide.createIcons();
        });

        function abrirModalAgenda(dados) {
            eventoSelecionado = dados;
            document.getElementById('agenda-cliente').innerText = dados.nome;
            const dataFesta = new Date(dados.data_festa).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            document.getElementById('agenda-data').innerText = `${dataFesta} √†s ${dados.horario}`;
            document.getElementById('agenda-endereco').innerText = dados.endereco;
            document.getElementById('agenda-barracas').innerText = `${dados.qtd_barracas}x ${dados.modelo_barraca}`;
            document.getElementById('agenda-valor').innerText = `R$ ${dados.valor_final || dados.totalCalculado || '0,00'}`;
            
            document.getElementById('box-link').classList.add('hidden');
            document.getElementById('btn-gerar-link').classList.remove('hidden');
            document.getElementById('modal-agenda').classList.remove('hidden');
        }

        async function gerarLinkAvaliacao() {
            try {
                const res = await fetch(`/api/admin/gerar-token/${eventoSelecionado.id}`, {
                    method: 'POST',
                    headers: { 'x-admin-password': ADMIN_TOKEN }
                });
                const data = await res.json();
                
                document.getElementById('btn-gerar-link').classList.add('hidden');
                document.getElementById('box-link').classList.remove('hidden');
                document.getElementById('input-link').value = data.link;
            } catch(e) {
                alert("Erro ao gerar link");
            }
        }

        function copiarLink() {
            const input = document.getElementById('input-link');
            input.select();
            document.execCommand("copy");
            alert("Link copiado!");
        }

        async function concluirServico() {
            if(!confirm("Deseja marcar esta festa como CONCLU√çDA? Ela sair√° da agenda.")) return;

            await fetch(`/api/admin/agenda/concluir/${eventoSelecionado.id}`, {
                method: 'PUT',
                headers: { 'x-admin-password': ADMIN_TOKEN }
            });
            
            alert("Festa conclu√≠da!");
            location.reload();
        }

        function fecharModal() {
            document.getElementById('modal-agenda').classList.add('hidden');
        }
    </script>
</body>
</html>