<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciador de Contratos | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        body { background-color: #f8fafc; font-family: 'Quicksand', sans-serif; overflow-x: hidden; }
        
        /* Folha A4 */
        .a4-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 20px auto;
            padding: 20mm;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            font-family: 'Arial', sans-serif;
            font-size: 11pt;
            line-height: 1.6;
            color: #000;
            outline: none;
        }

        /* Tags dinâmicas (visuais) */
        .variavel-tag {
            background: #fef08a;
            color: #ca8a04;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px dashed #eab308;
            transition: all 0.2s;
        }
        .variavel-tag:hover { background: #fde047; }

        /* Botões da Toolbar */
        .toolbar-btn {
            padding: 6px;
            border-radius: 6px;
            color: #475569;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .toolbar-btn:hover { background-color: #e2e8f0; color: #0f172a; }
        .toolbar-divider { width: 1px; height: 24px; background-color: #cbd5e1; margin: 0 4px; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .a4-page { margin: 0; padding: 10mm; box-shadow: none; width: 100%; min-height: auto; }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <div class="no-print bg-slate-900 border-b border-slate-800 p-4 shrink-0 shadow-md z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <a href="painel.html" class="p-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h1 class="text-white font-bold text-lg hidden md:block">Central de Contratos</h1>
            </div>

            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="mudarAba('emitir')" id="aba_emitir" class="px-4 py-2 rounded-md text-sm font-bold bg-blue-600 text-white transition-all">Emitir Contrato</button>
                <button onclick="mudarAba('modelos')" id="aba_modelos" class="px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:text-white transition-all">Meus Modelos</button>
            </div>
            
            <button onclick="window.print()" id="btnImprimir" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 transition-colors">
                <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
            </button>
        </div>
    </div>

    <div class="no-print bg-slate-50 border-b border-slate-200 p-2 shrink-0 z-40 flex justify-center shadow-sm">
        <div class="flex items-center gap-1 bg-white border border-slate-200 rounded-lg p-1 shadow-sm">
            <button class="toolbar-btn" onclick="formatar('bold')" title="Negrito (Ctrl+B)"><i data-lucide="bold" class="w-4 h-4"></i></button>
            <button class="toolbar-btn" onclick="formatar('italic')" title="Itálico (Ctrl+I)"><i data-lucide="italic" class="w-4 h-4"></i></button>
            <button class="toolbar-btn" onclick="formatar('underline')" title="Sublinhado (Ctrl+U)"><i data-lucide="underline" class="w-4 h-4"></i></button>
            
            <div class="toolbar-divider"></div>
            
            <button class="toolbar-btn" onclick="formatar('justifyLeft')" title="Alinhar à Esquerda"><i data-lucide="align-left" class="w-4 h-4"></i></button>
            <button class="toolbar-btn" onclick="formatar('justifyCenter')" title="Centralizar"><i data-lucide="align-center" class="w-4 h-4"></i></button>
            <button class="toolbar-btn" onclick="formatar('justifyRight')" title="Alinhar à Direita"><i data-lucide="align-right" class="w-4 h-4"></i></button>
            <button class="toolbar-btn" onclick="formatar('justifyFull')" title="Justificar"><i data-lucide="align-justify" class="w-4 h-4"></i></button>
            
            <div class="toolbar-divider"></div>
            
            <button class="toolbar-btn" onclick="formatar('insertUnorderedList')" title="Lista com Marcadores"><i data-lucide="list" class="w-4 h-4"></i></button>
            <button class="toolbar-btn" onclick="formatar('insertOrderedList')" title="Lista Numerada"><i data-lucide="list-ordered" class="w-4 h-4"></i></button>
            
            <div class="toolbar-divider"></div>
            
            <select onchange="formatar('formatBlock', this.value); this.selectedIndex=0;" class="p-1.5 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600 outline-none cursor-pointer hover:bg-slate-100">
                <option value="">Formato...</option>
                <option value="H1">Título 1 (Gigante)</option>
                <option value="H2">Título 2 (Grande)</option>
                <option value="H3">Título 3 (Médio)</option>
                <option value="P">Parágrafo Normal</option>
            </select>
            
            <div class="toolbar-divider"></div>

            <button class="toolbar-btn text-red-500 hover:text-red-700 hover:bg-red-50" onclick="formatar('removeFormat')" title="Limpar Formatação"><i data-lucide="eraser" class="w-4 h-4"></i></button>
        </div>
    </div>

    <div id="view_emitir" class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <aside class="no-print w-full md:w-80 bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-lg z-10 overflow-y-auto">
            <div class="p-5 space-y-6">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-2">1. Escolha o Modelo</label>
                    <select id="selectModeloEmitir" onchange="gerarContrato()" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 font-bold text-slate-700 outline-none focus:border-blue-500">
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-2">2. Selecione o Cliente (Pedido)</label>
                    <select id="selectPedido" onchange="gerarContrato()" class="w-full p-2.5 rounded-lg border border-slate-300 bg-slate-50 font-bold text-slate-700 outline-none focus:border-blue-500">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm text-blue-800">
                    <i data-lucide="edit-3" class="w-5 h-5 mb-2 text-blue-500"></i>
                    O contrato gerado pode ser editado. Use a barra de ferramentas no topo para formatar o texto antes de imprimir!
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-slate-200 overflow-y-auto p-4 md:p-8 flex justify-center items-start">
            <div id="contratoPreview" class="a4-page shadow-xl" contenteditable="true" spellcheck="false">
                <div class="text-center text-slate-400 mt-32 no-print" contenteditable="false">
                    Selecione um Modelo e um Cliente ao lado para gerar o documento.
                </div>
            </div>
        </main>
    </div>

    <div id="view_modelos" class="flex-1 flex flex-col md:flex-row overflow-hidden hidden">
        
        <aside class="no-print w-full md:w-80 bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-lg z-10">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h2 class="font-bold text-slate-800">Modelos Salvos</h2>
                <button onclick="novoModelo()" class="bg-blue-100 text-blue-700 p-2 rounded-lg hover:bg-blue-200" title="Criar Novo Modelo">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2" id="listaModelosSalvos">
            </div>
        </aside>

        <main class="flex-1 bg-slate-50 overflow-y-auto p-4 md:p-8 flex flex-col gap-4">
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full">
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">Nome do Modelo</label>
                    <input type="text" id="nomeModelo" class="w-full p-2.5 rounded-lg border border-slate-300 font-bold text-slate-800 outline-none focus:border-blue-500" placeholder="Ex: Contrato Permuta">
                </div>
                <button onclick="salvarModelo()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2.5 rounded-lg font-bold flex items-center gap-2 w-full md:w-auto justify-center shadow-md">
                    <i data-lucide="save" class="w-4 h-4"></i> Salvar Modelo
                </button>
                <button onclick="excluirModelo()" id="btnExcluirModelo" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2.5 rounded-lg font-bold flex items-center gap-2 w-full md:w-auto justify-center hidden">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Excluir
                </button>
            </div>

            <div class="flex flex-col xl:flex-row gap-4 flex-1 min-h-[500px]">
                <div class="w-full xl:w-64 bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-y-auto h-max shrink-0">
                    <h3 class="font-bold text-slate-800 text-sm mb-3">Variáveis Dinâmicas</h3>
                    <p class="text-xs text-slate-500 mb-4">Clique para copiar e cole no texto. O sistema substituirá na emissão.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Cliente</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="variavel-tag" onclick="copiarVar('[[NOME_CLIENTE]]')">[[NOME_CLIENTE]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[WHATSAPP]]')">[[WHATSAPP]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[EMAIL]]')">[[EMAIL]]</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Evento</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="variavel-tag" onclick="copiarVar('[[DATA_FESTA]]')">[[DATA_FESTA]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[HORARIO]]')">[[HORARIO]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[ENDERECO]]')">[[ENDERECO]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[QTD_CRIANCAS]]')">[[QTD_CRIANCAS]]</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Serviço & Valores</p>
                            <div class="flex flex-wrap gap-2">
                                <span class="variavel-tag" onclick="copiarVar('[[MODELO_BARRACA]]')">[[MODELO_BARRACA]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[TEMA]]')">[[TEMA]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[LISTA_BENS]]')">[[LISTA_BENS]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[LISTA_ALIMENTACAO]]')">[[LISTA_ALIMENTACAO]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[ALERGIAS]]')">[[ALERGIAS]]</span>
                                <span class="variavel-tag" onclick="copiarVar('[[VALOR_TOTAL]]')">[[VALOR_TOTAL]]</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto flex justify-center pb-10">
                    <div id="editorModelo" class="a4-page shadow-xl border border-slate-200" contenteditable="true" spellcheck="false"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3 z-50 pointer-events-none">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
        <span id="toastMsg" class="font-bold text-sm"></span>
    </div>

    <script>
        const ADMIN_TOKEN = localStorage.getItem("cabana_admin_token");
        if (!ADMIN_TOKEN) window.location.href = "painel.html";

        let listaPedidos = [];
        let modelos = [];
        let modeloEditandoId = null;

        // Função WYSIWYG (O Segredo da Barra de Ferramentas)
        function formatar(comando, valor = null) {
            document.execCommand(comando, false, valor);
            
            // Tenta manter o foco na div correta dependendo de qual aba está aberta
            if (document.getElementById('view_emitir').classList.contains('hidden')) {
                document.getElementById('editorModelo').focus();
            } else {
                document.getElementById('contratoPreview').focus();
            }
        }

        const modeloPadraoDefault = `
<div style="text-align: center;"><b><span style="font-size: 18pt;">CONTRATO DE PRESTAÇÃO DE SERVIÇOS</span></b></div><br>
<div><b>1. PARTES</b></div>
<div>CONTRATANTE: <b>[[NOME_CLIENTE]]</b>, telefone [[WHATSAPP]].</div>
<div>CONTRATADA: Cabana de Brincar.</div><br>
<div><b>2. EVENTO</b></div>
<ul>
    <li>Data: [[DATA_FESTA]] às [[HORARIO]]</li>
    <li>Local: [[ENDERECO]]</li>
    <li>Público: [[QTD_CRIANCAS]] crianças.</li>
</ul><br>
<div><b>3. BENS LOCADOS E ESTRUTURA</b></div>
<div>Modelo: [[MODELO_BARRACA]] / Tema: [[TEMA]]</div>
<ul>[[LISTA_BENS]]</ul><br>
<div><b>4. ALIMENTAÇÃO E ISENÇÃO</b></div>
<ul>[[LISTA_ALIMENTACAO]]</ul>
<div>Restrições e Alergias declaradas: <span style="background-color: rgb(255, 255, 0);"><b>[[ALERGIAS]]</b></span>.</div>
<div>O CONTRATANTE atesta ciência e assume responsabilidade sobre o consumo dos itens acima descritos.</div><br>
<div><b>5. REMUNERAÇÃO</b></div>
<div>Valor Total: <b>[[VALOR_TOTAL]]</b>.</div>
<br><br><br>
<div style="text-align: center;">____________________________________________________</div>
<div style="text-align: center;">[[NOME_CLIENTE]]</div>
        `.trim();

        // INICIALIZAÇÃO E ABAS
        async function iniciar() {
            carregarModelosLocais();
            await carregarPedidos();
            mudarAba('emitir');
        }

        function mudarAba(aba) {
            document.getElementById('view_emitir').classList.add('hidden');
            document.getElementById('view_modelos').classList.add('hidden');
            document.getElementById('aba_emitir').className = 'px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:text-white transition-all';
            document.getElementById('aba_modelos').className = 'px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:text-white transition-all';
            
            document.getElementById(`view_${aba}`).classList.remove('hidden');
            document.getElementById(`aba_${aba}`).className = 'px-4 py-2 rounded-md text-sm font-bold bg-blue-600 text-white transition-all';
            
            if (aba === 'emitir') {
                document.getElementById('btnImprimir').style.display = 'flex';
                atualizarSelectModelos();
            } else {
                document.getElementById('btnImprimir').style.display = 'none';
                renderizarListaModelos();
            }
        }

        // LÓGICA DE MODELOS
        function carregarModelosLocais() {
            const salvos = localStorage.getItem('cabana_modelos_contrato');
            if (salvos) {
                modelos = JSON.parse(salvos);
            } else {
                modelos = [{ id: Date.now().toString(), nome: "Contrato Padrão Jurídico", conteudo: modeloPadraoDefault }];
                salvarNoStorage();
            }
        }

        function salvarNoStorage() { localStorage.setItem('cabana_modelos_contrato', JSON.stringify(modelos)); }

        function renderizarListaModelos() {
            const container = document.getElementById('listaModelosSalvos');
            container.innerHTML = modelos.map(m => `
                <div onclick="carregarModeloParaEdicao('${m.id}')" class="p-3 bg-white border border-slate-200 rounded-lg cursor-pointer hover:border-blue-500 hover:shadow-md transition-all group">
                    <p class="font-bold text-sm text-slate-700 group-hover:text-blue-600">${m.nome}</p>
                </div>
            `).join('');
        }

        function atualizarSelectModelos() {
            const select = document.getElementById('selectModeloEmitir');
            select.innerHTML = '<option value="">Selecione um Modelo...</option>' + modelos.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
        }

        function novoModelo() {
            modeloEditandoId = null;
            document.getElementById('nomeModelo').value = '';
            document.getElementById('editorModelo').innerHTML = '<div>Comece a digitar aqui ou cole suas variáveis...</div>';
            document.getElementById('btnExcluirModelo').classList.add('hidden');
        }

        function carregarModeloParaEdicao(id) {
            const m = modelos.find(x => x.id === id);
            if (!m) return;
            modeloEditandoId = m.id;
            document.getElementById('nomeModelo').value = m.nome;
            document.getElementById('editorModelo').innerHTML = m.conteudo;
            document.getElementById('btnExcluirModelo').classList.remove('hidden');
        }

        function salvarModelo() {
            const nome = document.getElementById('nomeModelo').value.trim();
            const conteudo = document.getElementById('editorModelo').innerHTML;
            if (!nome) return alert("Dê um nome ao modelo!");

            if (modeloEditandoId) {
                const index = modelos.findIndex(m => m.id === modeloEditandoId);
                modelos[index] = { id: modeloEditandoId, nome, conteudo };
            } else {
                const novoId = Date.now().toString();
                modelos.push({ id: novoId, nome, conteudo });
                modeloEditandoId = novoId;
            }

            salvarNoStorage();
            renderizarListaModelos();
            document.getElementById('btnExcluirModelo').classList.remove('hidden');
            mostrarToast("Modelo salvo com sucesso!");
        }

        function excluirModelo() {
            if (!modeloEditandoId) return;
            if (modelos.length <= 1) return alert("Você precisa ter pelo menos 1 modelo no sistema.");
            if (confirm("Excluir este modelo permanentemente?")) {
                modelos = modelos.filter(m => m.id !== modeloEditandoId);
                salvarNoStorage();
                novoModelo();
                renderizarListaModelos();
                mostrarToast("Modelo excluído!");
            }
        }

        // EMISSÃO DE CONTRATO (Lendo do Banco)
        async function carregarPedidos() {
            try {
                const res = await fetch("/api/admin/pedidos", { headers: { "x-admin-password": ADMIN_TOKEN } });
                listaPedidos = (await res.json()).filter(p => p.status !== 'cancelado');
                const select = document.getElementById("selectPedido");
                listaPedidos.forEach(p => {
                    let dFesta = p.data_festa ? new Date(p.data_festa.split('T')[0] + 'T00:00:00').toLocaleDateString("pt-BR") : "N/I";
                    select.insertAdjacentHTML('beforeend', `<option value="${p.id}">Pedido #${p.id} - ${p.nome} (${dFesta})</option>`);
                });
            } catch (e) { console.error(e); }
        }

        function parseSeguro(dado) {
            if (!dado) return null;
            if (typeof dado === "object") return dado;
            try { return JSON.parse(dado); } catch (e) { return [dado]; }
        }

        function gerarContrato() {
            const modeloId = document.getElementById('selectModeloEmitir').value;
            const pedidoId = document.getElementById('selectPedido').value;
            const preview = document.getElementById('contratoPreview');

            if (!modeloId || !pedidoId) {
                preview.innerHTML = '<div class="text-center text-slate-400 mt-32 no-print" contenteditable="false">Selecione um Modelo e um Cliente ao lado para gerar o documento.</div>';
                return;
            }

            const modelo = modelos.find(m => m.id === modeloId);
            const pedido = listaPedidos.find(p => p.id == pedidoId);
            if(!modelo || !pedido) return;

            // Formatação do Banco de Dados
            let dataFesta = pedido.data_festa ? new Date(pedido.data_festa.split('T')[0] + 'T00:00:00').toLocaleDateString("pt-BR") : "A definir";
            const total = (parseFloat(pedido.valor_final || 0) + parseFloat(pedido.valor_itens_extras || 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const itensPadrao = parseSeguro(pedido.itens_padrao);
            let htmlBens = Array.isArray(itensPadrao) && itensPadrao.length > 0 ? itensPadrao.map(i => `<li>${i}</li>`).join('') : "<li>Estrutura padrão do modelo.</li>";
            if (pedido.itens_adicionais || pedido.descricao_itens_extras) {
                htmlBens += `<li><strong>Extras/Logística:</strong> ${pedido.itens_adicionais || ""} ${pedido.descricao_itens_extras || ""}</li>`;
            }

            const alim = parseSeguro(pedido.alimentacao);
            let htmlAlim = "<li>Nenhuma alimentação contratada no sistema.</li>";
            if (alim) {
                if (Array.isArray(alim) && alim.length > 0) htmlAlim = alim.map(i => `<li>${i}</li>`).join('');
                else if (alim.combo || (alim.extras && alim.extras.length > 0)) {
                    htmlAlim = "";
                    if (alim.combo) htmlAlim += `<li>${alim.combo.titulo}</li>`;
                    if (alim.extras) alim.extras.forEach(e => htmlAlim += `<li>${e.qtd}x ${e.nome}</li>`);
                }
            }

            // Substituição de Tags
            let resultado = modelo.conteudo;
            const mapaVariaveis = {
                '[[NOME_CLIENTE]]': pedido.nome.toUpperCase(),
                '[[WHATSAPP]]': pedido.whatsapp,
                '[[EMAIL]]': pedido.email || "Não informado",
                '[[DATA_FESTA]]': dataFesta,
                '[[HORARIO]]': pedido.horario || "A combinar",
                '[[ENDERECO]]': pedido.endereco || "Não informado",
                '[[QTD_CRIANCAS]]': pedido.qtd_criancas || "N/I",
                '[[MODELO_BARRACA]]': pedido.modelo_barraca || "N/A",
                '[[TEMA]]': pedido.tema || "A definir",
                '[[LISTA_BENS]]': htmlBens,
                '[[LISTA_ALIMENTACAO]]': htmlAlim,
                '[[ALERGIAS]]': pedido.alergias ? pedido.alergias.toUpperCase() : "NENHUMA",
                '[[VALOR_TOTAL]]': total
            };

            for (const [chave, valor] of Object.entries(mapaVariaveis)) {
                const regex = new RegExp(chave.replace(/\[/g, '\\[').replace(/\]/g, '\\]'), 'g');
                resultado = resultado.replace(regex, valor);
            }

            preview.innerHTML = resultado;
        }

        // UTILITÁRIOS
        function copiarVar(texto) {
            navigator.clipboard.writeText(texto);
            mostrarToast("Variável copiada! Cole (Ctrl+V) no texto.");
        }

        function mostrarToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        iniciar();
        lucide.createIcons();
    </script>
</body>
</html>