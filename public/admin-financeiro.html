<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap'); body{font-family:'Quicksand',sans-serif}</style>
</head>
<body class="bg-slate-50 p-6">

    <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <a href="painel.html" class="text-slate-400 hover:text-green-600"><i data-lucide="arrow-left"></i></a>
            Controle Financeiro
        </h1>
        <button onclick="abrirModalGasto()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 flex gap-2 shadow-lg shadow-indigo-200">
            <i data-lucide="plus-circle"></i> Novo Lan√ßamento
        </button>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase">Faturamento Total</p>
            <p id="total-faturamento" class="text-3xl font-bold text-green-600">R$ 0,00</p>
            <p class="text-[10px] text-slate-400 mt-1">Festas Realizadas + Entradas</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase">Despesas Totais</p>
            <p id="total-despesas" class="text-3xl font-bold text-red-500">R$ 0,00</p>
            <p class="text-[10px] text-slate-400 mt-1">Custos Festas + Gerais</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase">Lucro L√≠quido</p>
            <p id="total-lucro" class="text-3xl font-bold text-indigo-600">R$ 0,00</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-green-50 font-bold text-green-700 flex items-center gap-2">
                    <i data-lucide="party-popper" class="w-4 h-4"></i> Receita de Festas Conclu√≠das
                </div>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <tbody id="lista-receita-festas" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">Outras Entradas / Sa√≠das</div>
                <div class="max-h-64 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                        <tbody id="lista-gerais" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden h-fit">
            <div class="p-4 border-b border-slate-100 bg-red-50 font-bold text-red-700 flex items-center gap-2">
                <i data-lucide="shopping-bag" class="w-4 h-4"></i> Custos por Festa
            </div>
            <div class="max-h-[600px] overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <tbody id="lista-custos-festas" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-gasto" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4 text-slate-700">Novo Lan√ßamento</h3>
            
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Tipo</label>
            <select id="input-tipo" class="w-full mb-3 p-3 border rounded-lg bg-white text-slate-700 font-bold">
                <option value="saida">üî¥ Despesa (Sa√≠da)</option>
                <option value="entrada">üü¢ Receita Extra (Entrada)</option>
            </select>

            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Descri√ß√£o</label>
            <input id="input-titulo" type="text" placeholder="Ex: Energia, Venda de Ativo..." class="w-full mb-3 p-3 border rounded-lg">
            
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor</label>
            <input id="input-valor" type="number" step="0.01" placeholder="0,00" class="w-full mb-4 p-3 border rounded-lg">
            
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-gasto').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-lg font-bold text-slate-500">Cancelar</button>
                <button onclick="salvarGasto()" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_TOKEN = localStorage.getItem('cabana_admin_token');
        if(!ADMIN_TOKEN) window.location.href = 'painel.html';

        async function carregarFinanceiro() {
            try {
                const res = await fetch('/api/admin/financeiro/relatorio', {
                    headers: { 'x-admin-password': ADMIN_TOKEN }
                });
                const data = await res.json();
                
                // --- C√ÅLCULOS ---
                let fatFestas = data.faturamento.reduce((acc, i) => acc + Number(i.valor_final || 0), 0);
                let receitasExtras = data.gerais.filter(i => i.tipo === 'entrada').reduce((acc, i) => acc + Number(i.valor), 0);
                let despesasGerais = data.gerais.filter(i => i.tipo === 'saida').reduce((acc, i) => acc + Number(i.valor), 0);
                let despesasFestas = data.festas.reduce((acc, i) => acc + Number(i.valor), 0);

                let totalFaturamento = fatFestas + receitasExtras;
                let totalDespesas = despesasGerais + despesasFestas;

                document.getElementById('total-faturamento').innerText = `R$ ${totalFaturamento.toFixed(2)}`;
                document.getElementById('total-despesas').innerText = `R$ ${totalDespesas.toFixed(2)}`;
                document.getElementById('total-lucro').innerText = `R$ ${(totalFaturamento - totalDespesas).toFixed(2)}`;

                // --- TABELAS ---

                // 1. Receitas de Festas (Listar festas conclu√≠das)
                const listaReceita = document.getElementById('lista-receita-festas');
                if(data.faturamento.length === 0) {
                    listaReceita.innerHTML = '<tr><td class="p-4 text-slate-400 text-xs italic">Nenhuma festa conclu√≠da ainda.</td></tr>';
                } else {
                    listaReceita.innerHTML = data.faturamento.map(f => `
                        <tr class="hover:bg-green-50 transition-colors">
                            <td class="p-3">
                                <div class="font-bold text-slate-700">${f.nome}</div>
                                <div class="text-[10px] text-slate-400">${new Date(f.data_festa).toLocaleDateString('pt-BR')}</div>
                            </td>
                            <td class="p-3 text-right font-bold text-green-600">+ R$ ${Number(f.valor_final).toFixed(2)}</td>
                        </tr>
                    `).join('');
                }

                // 2. Gerais (Extras e Despesas)
                const listaGerais = document.getElementById('lista-gerais');
                listaGerais.innerHTML = data.gerais.map(i => {
                    const isEntrada = i.tipo === 'entrada';
                    const cor = isEntrada ? 'text-green-600' : 'text-red-500';
                    const sinal = isEntrada ? '+ ' : '- ';
                    return `
                    <tr class="hover:bg-slate-50 border-b border-slate-50">
                        <td class="p-3 text-slate-600">
                            ${i.titulo}
                            <span class="text-[10px] ml-2 px-2 py-0.5 rounded ${isEntrada ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${isEntrada ? 'Receita' : 'Despesa'}</span>
                        </td>
                        <td class="p-3 font-bold ${cor} text-right">${sinal}R$ ${Number(i.valor).toFixed(2)}</td>
                    </tr>
                    `;
                }).join('');

                // 3. Custos das Festas
                const listaCustos = document.getElementById('lista-custos-festas');
                listaCustos.innerHTML = data.festas.map(i => `
                    <tr class="hover:bg-slate-50 border-b border-slate-50">
                        <td class="p-3">
                            <div class="text-slate-600 font-bold">${i.nome_cliente}</div>
                            <div class="text-xs text-slate-400">${i.descricao}</div>
                        </td>
                        <td class="p-3 font-bold text-red-500 text-right">- R$ ${Number(i.valor).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                lucide.createIcons();
            } catch (e) {
                console.error("Erro financeiro:", e);
            }
        }

        function abrirModalGasto() { document.getElementById('modal-gasto').classList.remove('hidden'); }

        async function salvarGasto() {
            const titulo = document.getElementById('input-titulo').value;
            const valor = document.getElementById('input-valor').value;
            const tipo = document.getElementById('input-tipo').value;

            if(!titulo || !valor) return alert("Preencha todos os campos!");

            await fetch('/api/admin/financeiro/geral', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': ADMIN_TOKEN },
                body: JSON.stringify({ titulo, tipo, valor })
            });
            
            document.getElementById('modal-gasto').classList.add('hidden');
            document.getElementById('input-titulo').value = '';
            document.getElementById('input-valor').value = '';
            carregarFinanceiro();
        }

        carregarFinanceiro();
    </script>
</body>
</html>