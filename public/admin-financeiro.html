<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financeiro Inteligente | Cabana de Brincar</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap");
      body {
        font-family: "Quicksand", sans-serif;
      }
      .tab-active {
        border-bottom: 2px solid #ec4899; /* pink-500 */
        color: #ec4899;
      }
      .tab-inactive {
        color: #94a3b8; /* slate-400 */
      }
      .tab-inactive:hover {
        color: #475569; /* slate-600 */
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen p-4 md:p-6 pb-20">
    <div
      class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4"
    >
      <div>
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
          <a
            href="painel.html"
            class="text-slate-400 hover:text-pink-500 transition-colors"
            ><i data-lucide="arrow-left"></i
          ></a>
          Gest√£o Financeira
        </h1>
        <p class="text-xs text-slate-400 mt-1 ml-8">
          Fluxo de caixa e lucratividade
        </p>
      </div>

      <div
        class="bg-white p-2 rounded-xl shadow-sm border border-slate-200 flex flex-wrap items-center gap-2"
      >
        <div class="flex items-center gap-1 px-2">
          <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
          <span class="text-xs font-bold text-slate-500 uppercase"
            >Filtrar:</span
          >
        </div>
        <input
          type="date"
          id="filtro-inicio"
          class="border border-slate-200 rounded-lg px-2 py-1 text-sm text-slate-600 focus:outline-pink-500 bg-slate-50"
        />
        <span class="text-slate-300">at√©</span>
        <input
          type="date"
          id="filtro-fim"
          class="border border-slate-200 rounded-lg px-2 py-1 text-sm text-slate-600 focus:outline-pink-500 bg-slate-50"
        />
        <button
          onclick="aplicarFiltros()"
          class="bg-slate-800 text-white p-1.5 rounded-lg hover:bg-slate-700 transition shadow-lg shadow-slate-200"
          title="Filtrar"
        >
          <i data-lucide="search" class="w-4 h-4"></i>
        </button>
        <button
          onclick="limparFiltros()"
          class="bg-slate-100 text-slate-500 p-1.5 rounded-lg hover:bg-slate-200 transition"
          title="Hoje"
        >
          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        </button>
      </div>

      <button
        onclick="abrirModalDespesaGeral()"
        class="bg-pink-500 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-pink-600 transition flex items-center gap-2 shadow-lg shadow-pink-200 hover:-translate-y-1 transform duration-200"
      >
        <i data-lucide="plus-circle" class="w-4 h-4"></i> Lan√ßamento Avulso
      </button>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div
        class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group"
      >
        <div
          class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
        >
          <i data-lucide="trending-up" class="w-16 h-16 text-green-500"></i>
        </div>
        <p
          class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1"
        >
          Entradas (Receita)
        </p>
        <h3 class="text-3xl font-bold text-green-600" id="card-receitas">
          R$ 0,00
        </h3>
        <p class="text-[10px] text-slate-400 mt-2">
          Festas + Lan√ßamentos Avulsos
        </p>
      </div>

      <div
        class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group"
      >
        <div
          class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
        >
          <i data-lucide="trending-down" class="w-16 h-16 text-red-500"></i>
        </div>
        <p
          class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1"
        >
          Sa√≠das (Despesas)
        </p>
        <h3 class="text-3xl font-bold text-red-500" id="card-despesas">
          R$ 0,00
        </h3>
        <p class="text-[10px] text-slate-400 mt-2">Custos de Festas + Fixos</p>
      </div>

      <div
        class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group"
      >
        <div
          class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
        >
          <i data-lucide="pie-chart" class="w-16 h-16 text-blue-500"></i>
        </div>
        <p
          class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1"
        >
          Balan√ßo L√≠quido
        </p>
        <h3 class="text-3xl font-bold text-slate-800" id="card-lucro">
          R$ 0,00
        </h3>
        <div
          id="indicador-lucro"
          class="mt-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500"
        >
          Neutro
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div
        class="bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[600px]"
      >
        <div
          class="p-5 border-b border-slate-100 bg-gradient-to-r from-pink-50 to-white flex justify-between items-center"
        >
          <h3 class="font-bold text-slate-700 flex items-center gap-2">
            <div class="bg-pink-100 p-1.5 rounded-lg text-pink-600">
              <i data-lucide="party-popper" class="w-4 h-4"></i>
            </div>
            Fluxo de Festas
          </h3>
          <span
            class="text-[10px] font-bold uppercase text-slate-400 tracking-wide"
            >Toque para detalhes</span
          >
        </div>
        <div
          class="overflow-y-auto flex-1 p-3 space-y-3 bg-slate-50/50"
          id="lista-festas"
        ></div>
      </div>

      <div
        class="bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[600px]"
      >
        <div class="p-5 border-b border-slate-100 bg-white">
          <h3 class="font-bold text-slate-700 flex items-center gap-2">
            <div class="bg-slate-100 p-1.5 rounded-lg text-slate-600">
              <i data-lucide="arrow-left-right" class="w-4 h-4"></i>
            </div>
            Movimenta√ß√µes Gerais
          </h3>
        </div>
        <div
          class="overflow-y-auto flex-1 p-3 space-y-2"
          id="lista-gerais"
        ></div>
      </div>
    </div>

    <div
      id="modal-festa"
      class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4 transition-opacity"
    >
      <div
        class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade-in-up"
      >
        <div
          class="p-6 border-b border-slate-100 bg-white flex justify-between items-start"
        >
          <div>
            <h2
              class="text-xl font-bold text-slate-800 leading-tight"
              id="modal-festa-nome"
            >
              Carregando...
            </h2>
            <div class="flex items-center gap-2 mt-1">
              <i data-lucide="calendar" class="w-3 h-3 text-slate-400"></i>
              <p
                class="text-sm text-slate-500 font-medium"
                id="modal-festa-data"
              >
                00/00/0000
              </p>
              <span
                id="modal-status-badge"
                class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ml-2"
                >Status</span
              >
            </div>
          </div>
          <button
            onclick="fecharModalFesta()"
            class="bg-slate-50 p-2 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="flex border-b border-slate-100 px-6">
          <button
            onclick="mudarAba('pagamentos')"
            id="tab-pagamentos"
            class="py-3 px-4 text-sm font-bold tab-active transition-colors flex items-center gap-2"
          >
            <i data-lucide="dollar-sign" class="w-4 h-4"></i> Recebimentos
          </button>
          <button
            onclick="mudarAba('custos')"
            id="tab-custos"
            class="py-3 px-4 text-sm font-bold tab-inactive transition-colors flex items-center gap-2"
          >
            <i data-lucide="shopping-bag" class="w-4 h-4"></i> Despesas da Festa
          </button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 bg-slate-50/50">
          <div id="content-pagamentos">
            <div
              class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6"
            >
              <label
                class="block text-xs font-bold text-slate-400 uppercase mb-2"
                >Valor Total do Contrato</label
              >
              <div class="flex gap-2">
                <div class="relative flex-1">
                  <span
                    class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold"
                    >R$</span
                  >
                  <input
                    type="number"
                    id="modal-festa-valor"
                    step="0.01"
                    class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-lg font-bold text-slate-700 focus:outline-pink-500 transition-colors"
                  />
                </div>
                <button
                  onclick="atualizarValorFesta()"
                  class="bg-slate-800 text-white px-4 rounded-lg font-bold hover:bg-slate-900 transition text-sm"
                >
                  Atualizar
                </button>
              </div>
            </div>

            <div class="mb-4 flex justify-between items-center">
              <h3
                class="font-bold text-slate-700 text-sm flex items-center gap-2"
              >
                <i data-lucide="history" class="w-4 h-4 text-green-500"></i>
                Hist√≥rico de Pagamentos
              </h3>
            </div>

            <div id="lista-pagamentos-realizados" class="space-y-2 mb-6">
              <p class="text-center text-xs text-slate-400 py-4">
                Buscando hist√≥rico...
              </p>
            </div>

            <div
              class="grid grid-cols-2 gap-4 mt-4 border-t border-slate-200 pt-4"
            >
              <div>
                <p class="text-xs text-slate-400">Total Pago</p>
                <p class="text-lg font-bold text-green-600" id="resumo-pago">
                  R$ 0,00
                </p>
              </div>
              <div class="text-right">
                <p class="text-xs text-slate-400">Restante</p>
                <p class="text-lg font-bold text-red-500" id="resumo-restante">
                  R$ 0,00
                </p>
              </div>
            </div>
          </div>

          <div id="content-custos" class="hidden">
            <div
              class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6"
            >
              <p class="text-xs font-bold text-slate-400 uppercase mb-3">
                Adicionar Despesa (Uber, Ajudante, Gelo, etc)
              </p>
              <form
                onsubmit="adicionarCustoFesta(event)"
                class="flex gap-2 items-center"
              >
                <input
                  type="text"
                  id="novo-custo-desc"
                  placeholder="Descri√ß√£o"
                  required
                  class="flex-[2] p-2 border border-slate-200 bg-slate-50 rounded-lg text-sm focus:outline-pink-500"
                />
                <input
                  type="number"
                  id="novo-custo-valor"
                  placeholder="R$"
                  step="0.01"
                  required
                  class="flex-1 p-2 border border-slate-200 bg-slate-50 rounded-lg text-sm focus:outline-pink-500"
                />
                <button
                  type="submit"
                  class="bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition"
                >
                  <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
              </form>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-3">
              Lista de Custos
            </h3>
            <div class="space-y-2" id="modal-lista-custos"></div>
          </div>
        </div>

        <div class="p-4 bg-white border-t border-slate-100 flex justify-end">
          <button
            onclick="fecharModalFesta()"
            class="px-6 py-2 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>

    <div
      id="modal-geral"
      class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4"
    >
      <div
        class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl animate-zoom-in"
      >
        <h3 class="font-bold text-lg mb-1 text-slate-800">Novo Lan√ßamento</h3>
        <p class="text-xs text-slate-400 mb-6">
          Receitas ou despesas n√£o atreladas a festas (Ex: Luz, Internet, Venda
          de ativos).
        </p>

        <form onsubmit="salvarDespesaGeral(event)" class="space-y-4">
          <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1"
              >Descri√ß√£o</label
            >
            <input
              type="text"
              id="geral-titulo"
              placeholder="Ex: Pagamento de Internet"
              required
              class="w-full p-3 border border-slate-200 bg-slate-50 rounded-xl text-sm focus:outline-pink-500"
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                class="block text-xs font-bold text-slate-400 uppercase mb-1"
                >Tipo</label
              >
              <select
                id="geral-tipo"
                class="w-full p-3 border border-slate-200 bg-slate-50 rounded-xl text-sm font-bold text-slate-600 focus:outline-pink-500"
              >
                <option value="saida">üî¥ Sa√≠da</option>
                <option value="entrada">üü¢ Entrada</option>
              </select>
            </div>
            <div>
              <label
                class="block text-xs font-bold text-slate-400 uppercase mb-1"
                >Valor</label
              >
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xs"
                  >R$</span
                >
                <input
                  type="number"
                  id="geral-valor"
                  step="0.01"
                  placeholder="0,00"
                  required
                  class="w-full pl-8 p-3 border border-slate-200 bg-slate-50 rounded-xl text-sm focus:outline-pink-500"
                />
              </div>
            </div>
          </div>

          <div class="flex gap-2 mt-6 pt-2">
            <button
              type="button"
              onclick="
                document.getElementById('modal-geral').classList.add('hidden')
              "
              class="flex-1 p-3 rounded-xl border border-slate-200 font-bold text-slate-500 hover:bg-slate-50 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="flex-1 p-3 rounded-xl bg-pink-500 text-white font-bold hover:bg-pink-600 transition shadow-lg shadow-pink-200"
            >
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const API_URL = "/api";
      const ADMIN_TOKEN = localStorage.getItem("cabana_admin_token");
      if (!ADMIN_TOKEN) window.location.href = "painel.html";

      let DADOS_ORIGINAIS = {
        festas: [],
        gerais: [],
        custosFestas: [],
        pagamentos: [],
      };
      let FESTA_SELECIONADA_ID = null;

      // --- SETUP E INICIALIZA√á√ÉO ---
      function init() {
        lucide.createIcons();
        configurarDatasPadrao();
        carregarDadosCompletos();
      }

      function configurarDatasPadrao() {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, "0");
        const dia = String(hoje.getDate()).padStart(2, "0");

        // Padr√£o: M√™s atual
        document.getElementById("filtro-inicio").value = `${ano}-${mes}-01`;
        document.getElementById("filtro-fim").value = `${ano}-${mes}-${dia}`;
      }

      // --- L√ìGICA DE DADOS ---
      async function carregarDadosCompletos() {
        try {
          // 1. Busca Dados Financeiros Gerais
          const resFin = await fetch(`${API_URL}/admin/financeiro/relatorio`, {
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          const dadosFin = await resFin.json();

          // 2. Busca TODAS as festas para ter o panorama completo (Agenda + Concluidos)
          const resPedidos = await fetch(`${API_URL}/admin/pedidos`, {
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          const todosPedidos = await resPedidos.json();

          DADOS_ORIGINAIS.festas = todosPedidos; // Usamos a lista completa de pedidos
          DADOS_ORIGINAIS.gerais = dadosFin.gerais || [];
          DADOS_ORIGINAIS.custosFestas = dadosFin.festas || [];

          aplicarFiltros();
        } catch (e) {
          console.error(e);
          // Fallback silencioso ou alerta
        }
      }

      function aplicarFiltros() {
        const strInicio = document.getElementById("filtro-inicio").value;
        const strFim = document.getElementById("filtro-fim").value;
        const dataInicio = new Date(strInicio + "T00:00:00");
        const dataFim = new Date(strFim + "T23:59:59.999");

        // Filtra festas pela data da festa
        const festasFiltradas = DADOS_ORIGINAIS.festas.filter((f) => {
          const d = new Date(f.data_festa);
          return d >= dataInicio && d <= dataFim;
        });

        // Filtra despesas gerais pela data de registro
        const geraisFiltradas = DADOS_ORIGINAIS.gerais.filter((g) => {
          const d = new Date(g.data_registro || new Date());
          return d >= dataInicio && d <= dataFim;
        });

        renderizarDashboard(festasFiltradas, geraisFiltradas);
      }

      function limparFiltros() {
        configurarDatasPadrao();
        aplicarFiltros();
      }

      // --- RENDERIZA√á√ÉO DASHBOARD ---
      function renderizarDashboard(festas, gerais) {
        let totalReceita = 0;
        let totalDespesas = 0;

        // 1. Processar Festas
        const containerFestas = document.getElementById("lista-festas");
        containerFestas.innerHTML = "";

        if (festas.length === 0) {
          containerFestas.innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                    <i data-lucide="calendar-off" class="w-10 h-10 mb-2 opacity-50"></i>
                    <p class="text-sm">Nenhuma festa neste per√≠odo.</p>
                </div>`;
        }

        // Ordenar por data (mais recente no topo)
        festas.sort((a, b) => new Date(b.data_festa) - new Date(a.data_festa));

        festas.forEach((festa) => {
          // C√°lculos da Festa
          const valorTotalContrato = parseFloat(festa.valor_final || 0);

          // L√≥gica de Receita Estimada (Enquanto n√£o migramos 100% para tabela de pagamentos)
          // Se status = concluido ou pago, conta tudo. Se status = agendado/aprovado, conta 50% (Sinal)
          let receitaRealizada = 0;
          let statusLabel = "";
          let statusClass = "";

          if (festa.status_pagamento === "pago") {
            receitaRealizada = valorTotalContrato;
            statusLabel = "Quitado";
            statusClass = "bg-green-100 text-green-700";
          } else if (
            festa.status_agenda === "agendado" ||
            festa.status === "aprovado"
          ) {
            // Assume SINAL (50%)
            receitaRealizada = valorTotalContrato * 0.5;
            statusLabel = "Sinal (Est.)";
            statusClass = "bg-orange-100 text-orange-700";
          } else if (festa.status === "pendente") {
            statusLabel = "Pendente";
            statusClass = "bg-slate-100 text-slate-500";
          } else {
            // Conclu√≠do geralmente √© quitado
            receitaRealizada = valorTotalContrato;
            statusLabel = "Conclu√≠do";
            statusClass = "bg-blue-100 text-blue-700";
          }

          // Somar custos espec√≠ficos
          const custosDestaFesta = DADOS_ORIGINAIS.custosFestas
            .filter((c) => c.orcamento_id === festa.id)
            .reduce((acc, curr) => acc + parseFloat(curr.valor), 0);

          totalReceita += receitaRealizada;
          totalDespesas += custosDestaFesta;

          // Renderizar Card da Festa
          containerFestas.innerHTML += `
                <div onclick="abrirDetalhesFesta(${festa.id})" class="p-4 rounded-xl border border-slate-100 hover:border-pink-300 hover:shadow-md transition cursor-pointer bg-white group relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2 relative z-10">
                        <div class="flex items-start gap-3">
                            <div class="bg-pink-50 text-pink-500 font-bold text-xs p-2 rounded-lg text-center min-w-[50px]">
                                <span class="block text-lg">${new Date(festa.data_festa).getDate()}</span>
                                <span class="uppercase">${new Date(festa.data_festa).toLocaleDateString("pt-BR", { month: "short" }).replace(".", "")}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-700 group-hover:text-pink-600 transition leading-tight">${festa.nome.split(" ")[0]}</h4>
                                <span class="text-[10px] text-slate-400 block mt-1">${festa.tema || "Sem tema"}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block text-[10px] font-bold px-2 py-0.5 rounded mb-1 ${statusClass}">${statusLabel}</span>
                            <div class="font-bold text-slate-700 text-sm">
                                ${receitaRealizada.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-slate-100 h-1.5 rounded-full mt-2 overflow-hidden">
                        <div class="h-full ${festa.status_pagamento === "pago" ? "bg-green-500" : "bg-orange-400"}" style="width: ${(receitaRealizada / valorTotalContrato) * 100}%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                        <span>Contrato: R$ ${valorTotalContrato}</span>
                        ${custosDestaFesta > 0 ? `<span class="text-red-400 font-bold">Custos: -R$ ${custosDestaFesta}</span>` : ""}
                    </div>
                </div>
            `;
        });

        // 2. Processar Gerais
        const containerGerais = document.getElementById("lista-gerais");
        containerGerais.innerHTML = "";

        if (gerais.length === 0) {
          containerGerais.innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 text-slate-400">
                    <i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-50"></i>
                    <p class="text-sm">Sem movimenta√ß√µes extras.</p>
                </div>`;
        }

        gerais.forEach((item) => {
          const valor = parseFloat(item.valor);
          const isEntrada = item.tipo === "entrada";
          if (isEntrada) totalReceita += valor;
          else totalDespesas += valor;

          containerGerais.innerHTML += `
                <div class="flex justify-between items-center p-3 hover:bg-slate-50 rounded-xl group border-b border-slate-50 last:border-0 transition">
                    <div class="flex items-center gap-3">
                        <div class="${isEntrada ? "bg-green-100 text-green-600" : "bg-red-100 text-red-500"} p-2 rounded-lg">
                            <i data-lucide="${isEntrada ? "arrow-up" : "arrow-down"}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm line-clamp-1">${item.titulo}</p>
                            <p class="text-[10px] text-slate-400 capitalize">${new Date(item.data_registro).toLocaleDateString("pt-BR")}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-sm ${isEntrada ? "text-green-600" : "text-red-500"}">
                            ${isEntrada ? "+" : "-"} ${valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}
                        </span>
                        <button onclick="excluirDespesaGeral(${item.id})" class="text-slate-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `;
        });

        // 3. Atualizar Totais
        const lucroTotal = totalReceita - totalDespesas;

        atualizarCard("card-receitas", totalReceita);
        atualizarCard("card-despesas", totalDespesas);

        const elLucro = document.getElementById("card-lucro");
        elLucro.innerText = lucroTotal.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
        elLucro.className = `text-3xl font-bold ${lucroTotal >= 0 ? "text-green-600" : "text-red-500"}`;

        const elIndicador = document.getElementById("indicador-lucro");
        if (lucroTotal > 0) {
          elIndicador.className =
            "mt-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-green-100 text-green-700";
          elIndicador.innerText = "Lucrativo";
        } else if (lucroTotal < 0) {
          elIndicador.className =
            "mt-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700";
          elIndicador.innerText = "D√©ficit";
        } else {
          elIndicador.className =
            "mt-2 inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-500";
          elIndicador.innerText = "Neutro";
        }

        lucide.createIcons();
      }

      function atualizarCard(id, valor) {
        // Efeito de contagem simples poderia ser adicionado aqui
        document.getElementById(id).innerText = valor.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      // --- MODAL DA FESTA ---

      async function abrirDetalhesFesta(id) {
        FESTA_SELECIONADA_ID = id;
        const festa = DADOS_ORIGINAIS.festas.find((f) => f.id === id);
        if (!festa) return;

        // Resetar UI do Modal
        document.getElementById("modal-festa-nome").innerText = festa.nome;
        document.getElementById("modal-festa-data").innerText = new Date(
          festa.data_festa,
        ).toLocaleDateString("pt-BR");
        document.getElementById("modal-festa-valor").value = festa.valor_final;

        // Status Badge
        const badge = document.getElementById("modal-status-badge");
        badge.innerText =
          festa.status_pagamento === "pago"
            ? "QUITADO"
            : festa.status_agenda === "agendado"
              ? "SINAL PAGO"
              : "PENDENTE";
        badge.className = `text-[10px] px-2 py-0.5 rounded-full font-bold uppercase ml-2 ${festa.status_pagamento === "pago" ? "bg-green-100 text-green-600" : "bg-orange-100 text-orange-600"}`;

        mudarAba("pagamentos"); // Aba padr√£o
        document.getElementById("modal-festa").classList.remove("hidden");

        // Carregar Sub-dados
        renderizarListaCustos(id);

        // Tentar carregar hist√≥rico de pagamentos real da API
        await carregarHistoricoPagamentos(id, festa.valor_final);
      }

      async function carregarHistoricoPagamentos(id, valorTotal) {
        const container = document.getElementById(
          "lista-pagamentos-realizados",
        );
        container.innerHTML =
          '<div class="flex justify-center p-4"><i data-lucide="loader-2" class="animate-spin text-pink-500"></i></div>';
        lucide.createIcons();

        try {
          // Verifica se a rota existe (implementada no server.js sugerido)
          const res = await fetch(`${API_URL}/admin/pedidos/${id}/pagamentos`, {
            headers: { "x-admin-password": ADMIN_TOKEN },
          });

          if (res.ok) {
            const pagamentos = await res.json();
            container.innerHTML = "";

            let totalPago = 0;

            if (pagamentos.length === 0) {
              container.innerHTML =
                '<p class="text-xs text-slate-400 italic text-center py-2">Nenhum pagamento registrado via sistema ainda.</p>';
            }

            pagamentos.forEach((pg) => {
              totalPago += parseFloat(pg.valor);
              const isSinal = pg.tipo === "SINAL";
              container.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center ${isSinal ? "bg-orange-100 text-orange-600" : "bg-green-100 text-green-600"}">
                                    <i data-lucide="${isSinal ? "bookmark" : "check-circle"}" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-700">${isSinal ? "Sinal / Reserva" : "Pagamento Restante"}</p>
                                    <p class="text-[10px] text-slate-400">${new Date(pg.data_pagamento).toLocaleDateString("pt-BR")} via ${pg.metodo || "Sistema"}</p>
                                </div>
                            </div>
                            <span class="font-bold text-slate-700">R$ ${parseFloat(pg.valor).toFixed(2)}</span>
                        </div>
                      `;
            });

            // Atualizar Resumo
            const restante = parseFloat(valorTotal) - totalPago;
            document.getElementById("resumo-pago").innerText =
              totalPago.toLocaleString("pt-BR", {
                style: "currency",
                currency: "BRL",
              });
            document.getElementById("resumo-restante").innerText =
              restante <= 0.1
                ? "QUITADO"
                : restante.toLocaleString("pt-BR", {
                    style: "currency",
                    currency: "BRL",
                  });

            if (restante <= 0.1) {
              document.getElementById("resumo-restante").className =
                "text-lg font-bold text-green-500";
            } else {
              document.getElementById("resumo-restante").className =
                "text-lg font-bold text-red-500";
            }
          } else {
            throw new Error("API n√£o dispon√≠vel");
          }
        } catch (e) {
          // Fallback se a API de pagamentos n√£o existir
          container.innerHTML =
            '<p class="text-xs text-red-300 italic text-center">Hist√≥rico detalhado indispon√≠vel.</p>';
        }
        lucide.createIcons();
      }

      function renderizarListaCustos(id) {
        const lista = DADOS_ORIGINAIS.custosFestas.filter(
          (c) => c.orcamento_id === id,
        );
        const container = document.getElementById("modal-lista-custos");
        container.innerHTML = "";

        if (lista.length === 0)
          container.innerHTML =
            '<div class="text-center py-4 bg-slate-50 rounded-lg border border-dashed border-slate-200"><p class="text-xs text-slate-400">Nenhum custo lan√ßado para esta festa.</p></div>';

        lista.forEach((custo) => {
          container.innerHTML += `
            <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-100 shadow-sm group">
                <span class="text-sm text-slate-600 font-medium">${custo.descricao}</span>
                <div class="flex items-center gap-3">
                    <span class="text-sm font-bold text-red-500">- R$ ${parseFloat(custo.valor).toFixed(2)}</span>
                    <button onclick="excluirCustoFesta(${custo.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
          `;
        });
        lucide.createIcons();
      }

      // --- A√á√ïES DO MODAL ---
      function mudarAba(aba) {
        const contentPag = document.getElementById("content-pagamentos");
        const contentCus = document.getElementById("content-custos");
        const tabPag = document.getElementById("tab-pagamentos");
        const tabCus = document.getElementById("tab-custos");

        if (aba === "pagamentos") {
          contentPag.classList.remove("hidden");
          contentCus.classList.add("hidden");
          tabPag.classList.add("tab-active");
          tabPag.classList.remove("tab-inactive");
          tabCus.classList.remove("tab-active");
          tabCus.classList.add("tab-inactive");
        } else {
          contentPag.classList.add("hidden");
          contentCus.classList.remove("hidden");
          tabPag.classList.remove("tab-active");
          tabPag.classList.add("tab-inactive");
          tabCus.classList.add("tab-active");
          tabCus.classList.remove("tab-inactive");
        }
      }

      function fecharModalFesta() {
        document.getElementById("modal-festa").classList.add("hidden");
        FESTA_SELECIONADA_ID = null;
      }

      function abrirModalDespesaGeral() {
        document.getElementById("modal-geral").classList.remove("hidden");
      }

      async function atualizarValorFesta() {
        const novoValor = document.getElementById("modal-festa-valor").value;
        const btn = event.target;
        const textoOriginal = btn.innerText;
        btn.innerText = "...";

        try {
          await fetch(
            `${API_URL}/admin/pedidos/${FESTA_SELECIONADA_ID}/financeiro`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "x-admin-password": ADMIN_TOKEN,
              },
              body: JSON.stringify({ valor_final: novoValor }), // Envia apenas o que mudou
            },
          );

          btn.innerText = "OK!";
          setTimeout(() => (btn.innerText = textoOriginal), 1000);
          carregarDadosCompletos(); // Atualiza dashboard
        } catch (err) {
          alert("Erro ao atualizar.");
          btn.innerText = textoOriginal;
        }
      }

      async function adicionarCustoFesta(e) {
        e.preventDefault();
        const desc = document.getElementById("novo-custo-desc").value;
        const val = document.getElementById("novo-custo-valor").value;
        try {
          await fetch(
            `${API_URL}/admin/financeiro/festa/${FESTA_SELECIONADA_ID}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-admin-password": ADMIN_TOKEN,
              },
              body: JSON.stringify({ descricao: desc, valor: val }),
            },
          );
          document.getElementById("novo-custo-desc").value = "";
          document.getElementById("novo-custo-valor").value = "";
          carregarDadosCompletos(); // Atualiza dashboard
          renderizarListaCustos(FESTA_SELECIONADA_ID);
        } catch (err) {
          alert("Erro ao salvar custo");
        }
      }

      async function excluirCustoFesta(id) {
        if (!confirm("Remover este custo?")) return;
        await fetch(`${API_URL}/admin/financeiro/festa/${id}`, {
          method: "DELETE",
          headers: { "x-admin-password": ADMIN_TOKEN },
        });
        carregarDadosCompletos();
        renderizarListaCustos(FESTA_SELECIONADA_ID);
      }

      async function salvarDespesaGeral(e) {
        e.preventDefault();
        const titulo = document.getElementById("geral-titulo").value;
        const tipo = document.getElementById("geral-tipo").value;
        const valor = parseFloat(document.getElementById("geral-valor").value);
        try {
          const res = await fetch(`${API_URL}/admin/financeiro/geral`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": ADMIN_TOKEN,
            },
            body: JSON.stringify({ titulo, tipo, valor }),
          });
          if (res.ok) {
            document.getElementById("modal-geral").classList.add("hidden");
            e.target.reset();
            carregarDadosCompletos();
          } else {
            alert("Erro ao salvar.");
          }
        } catch (err) {
          alert("Erro de conex√£o.");
        }
      }

      async function excluirDespesaGeral(id) {
        if (!confirm("Excluir esta movimenta√ß√£o?")) return;
        try {
          await fetch(`${API_URL}/admin/financeiro/geral/${id}`, {
            method: "DELETE",
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          carregarDadosCompletos();
        } catch (err) {
          alert("Erro ao excluir.");
        }
      }

      init();
    </script>
  </body>
</html>
