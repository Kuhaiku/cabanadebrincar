<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap'); body{font-family:'Quicksand',sans-serif}</style>
</head>
<body class="bg-slate-50 p-6">

    <div class="max-w-7xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <a href="painel.html" class="text-slate-400 hover:text-green-600"><i data-lucide="arrow-left"></i></a>
            Controle Financeiro
        </h1>
        <button onclick="abrirModalGasto()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600 flex gap-2 shadow-lg shadow-red-200">
            <i data-lucide="minus-circle"></i> Lançar Despesa
        </button>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase">Faturamento (Festas)</p>
            <p id="total-faturamento" class="text-3xl font-bold text-green-600">R$ 0,00</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase">Despesas Totais</p>
            <p id="total-despesas" class="text-3xl font-bold text-red-500">R$ 0,00</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase">Lucro Líquido</p>
            <p id="total-lucro" class="text-3xl font-bold text-indigo-600">R$ 0,00</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">Despesas Gerais</div>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <tbody id="lista-gerais" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50 font-bold text-slate-700">Custos por Festa</div>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full text-sm text-left">
                    <tbody id="lista-festas" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-gasto" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4 text-slate-700">Lançar Despesa Geral</h3>
            <input id="input-titulo" type="text" placeholder="Descrição (ex: Energia)" class="w-full mb-3 p-3 border rounded-lg">
            <input id="input-valor" type="number" step="0.01" placeholder="Valor (R$)" class="w-full mb-4 p-3 border rounded-lg">
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-gasto').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-lg font-bold text-slate-500">Cancelar</button>
                <button onclick="salvarGasto()" class="flex-1 bg-red-500 text-white py-3 rounded-lg font-bold hover:bg-red-600">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_TOKEN = localStorage.getItem('cabana_admin_token');
        if(!ADMIN_TOKEN) window.location.href = 'painel.html';

        async function carregarFinanceiro() {
            const res = await fetch('/api/admin/financeiro/relatorio', {
                headers: { 'x-admin-password': ADMIN_TOKEN }
            });
            const data = await res.json();
            
            // Cálculos
            let faturamento = data.faturamento.reduce((acc, i) => acc + Number(i.valor_final || 0), 0);
            let despesasGerais = data.gerais.filter(i => i.tipo === 'saida').reduce((acc, i) => acc + Number(i.valor), 0);
            let despesasFestas = data.festas.reduce((acc, i) => acc + Number(i.valor), 0);
            let totalDespesas = despesasGerais + despesasFestas;

            document.getElementById('total-faturamento').innerText = `R$ ${faturamento.toFixed(2)}`;
            document.getElementById('total-despesas').innerText = `R$ ${totalDespesas.toFixed(2)}`;
            document.getElementById('total-lucro').innerText = `R$ ${(faturamento - totalDespesas).toFixed(2)}`;

            // Renderizar Listas
            const listaGerais = document.getElementById('lista-gerais');
            listaGerais.innerHTML = data.gerais.map(i => `
                <tr class="hover:bg-slate-50">
                    <td class="p-3 text-slate-600">${i.titulo}</td>
                    <td class="p-3 font-bold text-red-500 text-right">- R$ ${Number(i.valor).toFixed(2)}</td>
                </tr>
            `).join('');

            const listaFestas = document.getElementById('lista-festas');
            listaFestas.innerHTML = data.festas.map(i => `
                <tr class="hover:bg-slate-50">
                    <td class="p-3">
                        <div class="text-slate-600 font-bold">${i.nome_cliente}</div>
                        <div class="text-xs text-slate-400">${i.descricao}</div>
                    </td>
                    <td class="p-3 font-bold text-red-500 text-right">- R$ ${Number(i.valor).toFixed(2)}</td>
                </tr>
            `).join('');
            
            lucide.createIcons();
        }

        function abrirModalGasto() { document.getElementById('modal-gasto').classList.remove('hidden'); }

        async function salvarGasto() {
            const titulo = document.getElementById('input-titulo').value;
            const valor = document.getElementById('input-valor').value;
            if(!titulo || !valor) return alert("Preencha tudo!");

            await fetch('/api/admin/financeiro/geral', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': ADMIN_TOKEN },
                body: JSON.stringify({ titulo, tipo: 'saida', valor })
            });
            
            document.getElementById('modal-gasto').classList.add('hidden');
            carregarFinanceiro();
        }

        carregarFinanceiro();
    </script>
</body>
</html>