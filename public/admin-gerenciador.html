<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Pre√ßos | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        body { font-family: 'Quicksand', sans-serif; }
        /* Toggle Switch CSS */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10B981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10B981;
        }
    </style>
</head>
<body class="bg-slate-50 p-6 min-h-screen">

    <div class="max-w-6xl mx-auto mb-8 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <a href="painel.html" class="text-slate-400 hover:text-pink-500 transition-colors"><i data-lucide="arrow-left"></i></a>
            Gerenciador de Itens
        </h1>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 sticky top-6">
                <h2 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <div class="bg-green-100 p-2 rounded-lg text-green-600"><i data-lucide="plus" class="w-4 h-4"></i></div>
                    Novo Item
                </h2>
                
                <form id="form-novo-item" onsubmit="adicionarItem(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Descri√ß√£o</label>
                        <input type="text" id="nova-descricao" required placeholder="Ex: Cabana √çndio" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-pink-500 transition-colors">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Categoria</label>
                        <div class="relative">
                            <select id="nova-categoria" required class="w-full p-3 border border-slate-200 rounded-xl text-sm appearance-none bg-white focus:outline-none focus:border-pink-500 transition-colors cursor-pointer">
                                <option value="" disabled selected>Selecione...</option>
                                <option value="tendas">üèïÔ∏è Barracas</option>
                                <option value="padrao">üì¶ Item Padr√£o</option>
                                <option value="alimentacao">üçΩÔ∏è Alimenta√ß√£o</option>
                                <option value="sistema">‚öôÔ∏è Taxa / Sistema</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Valor (R$)</label>
                        <input type="number" id="novo-valor" required step="0.01" placeholder="0.00" class="w-full p-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:border-pink-500 transition-colors">
                    </div>

                    <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-900 transition-all shadow-lg shadow-slate-200 flex justify-center items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Salvar
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-3 space-y-6" id="container-listas">
            <div class="text-center py-10 text-slate-400">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                Carregando tabela...
            </div>
        </div>

    </div>

    <script>
        const API_URL = '/api';
        const ADMIN_TOKEN = localStorage.getItem('cabana_admin_token');
        if(!ADMIN_TOKEN) window.location.href = 'painel.html';

        const CATEGORIAS = {
            'tendas': { titulo: 'Modelos de Barracas', icon: 'tent', color: 'text-indigo-600', bg: 'bg-indigo-50' },
            'padrao': { titulo: 'Itens do Pacote', icon: 'package', color: 'text-blue-600', bg: 'bg-blue-50' },
            'alimentacao': { titulo: 'Alimenta√ß√£o', icon: 'utensils', color: 'text-pink-600', bg: 'bg-pink-50' },
            'sistema': { titulo: 'Taxas e Extras', icon: 'settings', color: 'text-slate-600', bg: 'bg-slate-100' }
        };

        const OPCOES_SELECT = [
            {val: 'tendas', label: 'Barraca'},
            {val: 'padrao', label: 'Item Padr√£o'},
            {val: 'alimentacao', label: 'Alimenta√ß√£o'},
            {val: 'sistema', label: 'Taxa'}
        ];

        async function init() {
            lucide.createIcons();
            carregarItens();
        }

        async function carregarItens() {
            try {
                const res = await fetch(`${API_URL}/admin/precos`, { headers: { 'x-admin-password': ADMIN_TOKEN } });
                const itens = await res.json();
                renderizarListas(itens);
            } catch (error) { console.error(error); }
        }

        function renderizarListas(itens) {
            const container = document.getElementById('container-listas');
            container.innerHTML = '';

            const grupos = { tendas: [], padrao: [], alimentacao: [], sistema: [], outros: [] };
            itens.forEach(item => {
                const cat = grupos[item.categoria] ? item.categoria : 'outros';
                grupos[cat].push(item);
            });

            for (const [key, lista] of Object.entries(grupos)) {
                if (lista.length === 0) continue;
                const config = CATEGORIAS[key] || { titulo: 'Outros', icon: 'list', color: 'text-gray-600', bg: 'bg-gray-50' };

                let htmlItens = lista.map(item => {
                    const isChecked = (item.disponivel === 1 || item.disponivel === true) ? 'checked' : '';
                    const opacityClass = isChecked ? '' : 'opacity-50 grayscale bg-slate-50'; // Visual de desativado

                    // Gera o select de categorias dinamicamente
                    let selectCatHtml = `<select onchange="atualizarCampo(${item.id}, 'categoria', this.value)" class="text-xs bg-transparent border-none text-slate-500 focus:text-indigo-600 font-bold cursor-pointer focus:outline-none">`;
                    OPCOES_SELECT.forEach(opt => {
                        selectCatHtml += `<option value="${opt.val}" ${item.categoria === opt.val ? 'selected' : ''}>${opt.label}</option>`;
                    });
                    selectCatHtml += `</select>`;

                    return `
                    <div class="flex flex-col md:flex-row md:items-center gap-3 p-4 hover:bg-slate-50 rounded-lg group transition-all border-b border-slate-50 last:border-0 ${opacityClass}">
                        
                        <div class="flex items-center gap-2">
                             <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle-${item.id}" ${isChecked} 
                                       class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 ease-in-out top-0 left-0"
                                       onchange="atualizarCampo(${item.id}, 'disponivel', this.checked ? 1 : 0)"/>
                                <label for="toggle-${item.id}" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                            </div>
                        </div>

                        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="text" value="${item.descricao}" 
                                   class="bg-transparent border border-transparent hover:border-slate-200 focus:border-indigo-300 focus:bg-white rounded px-2 py-1 text-sm font-medium text-slate-700 w-full transition-all"
                                   onchange="atualizarCampo(${item.id}, 'descricao', this.value)">
                            
                            <div class="flex items-center gap-2">
                                ${selectCatHtml}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 justify-end mt-2 md:mt-0">
                            <div class="relative w-24">
                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-slate-400 font-bold">R$</span>
                                <input type="number" step="0.01" value="${item.valor}" 
                                       class="w-full pl-6 pr-2 py-1 border border-slate-200 rounded text-sm text-right font-bold text-slate-600 focus:border-green-500 focus:text-green-600 focus:outline-none transition-colors"
                                       onchange="atualizarCampo(${item.id}, 'valor', this.value)">
                            </div>
                            
                            <button onclick="deletarItem(${item.id})" class="text-slate-300 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-all" title="Excluir Definitivamente">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `}).join('');

                container.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                        <div class="p-4 border-b border-slate-100 flex items-center gap-3 ${config.bg}">
                            <i data-lucide="${config.icon}" class="w-5 h-5 ${config.color}"></i>
                            <h3 class="font-bold text-slate-700">${config.titulo}</h3>
                        </div>
                        <div class="p-2">${htmlItens}</div>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        async function adicionarItem(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '...';

            const payload = {
                descricao: document.getElementById('nova-descricao').value,
                categoria: document.getElementById('nova-categoria').value,
                valor: document.getElementById('novo-valor').value,
                disponivel: 1
            };

            await fetch(`${API_URL}/admin/precos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-password': ADMIN_TOKEN },
                body: JSON.stringify(payload)
            });

            document.getElementById('form-novo-item').reset();
            btn.innerHTML = originalHtml;
            carregarItens();
        }

        async function atualizarCampo(id, campo, valor) {
            // Se mudou a categoria, recarrega a lista para mover o item visualmente
            const recarregar = campo === 'categoria' || campo === 'disponivel';
            
            try {
                await fetch(`${API_URL}/admin/precos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-password': ADMIN_TOKEN },
                    body: JSON.stringify({ [campo]: valor })
                });
                
                if(recarregar) carregarItens();

            } catch(e) { alert("Erro ao salvar."); }
        }

        async function deletarItem(id) {
            if(!confirm("Excluir permanentemente?")) return;
            await fetch(`${API_URL}/admin/precos/${id}`, {
                method: 'DELETE',
                headers: { 'x-admin-password': ADMIN_TOKEN }
            });
            carregarItens();
        }

        init();
    </script>
</body>
</html>