<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pedidos | Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap");
      body {
        font-family: "Quicksand", sans-serif;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
      <header class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-4">
          <a
            href="painel.html"
            class="p-2 bg-white rounded-xl hover:bg-slate-100 transition-colors"
            ><i data-lucide="arrow-left" class="text-slate-600"></i
          ></a>
          <h1 class="text-2xl font-bold text-slate-800">
            Pedidos & Or√ßamentos
          </h1>
        </div>
        <button
          onclick="carregarDados()"
          class="bg-white text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-100 flex items-center gap-2"
        >
          <i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualizar
        </button>
      </header>

      <div class="flex gap-4 mb-6 overflow-x-auto pb-2">
        <button
          onclick="filtrar('todos')"
          class="bg-white px-4 py-2 rounded-full text-sm font-bold text-slate-600 shadow-sm hover:shadow-md border border-slate-100"
        >
          Todos
        </button>
        <button
          onclick="filtrar('pendente')"
          class="bg-yellow-100 px-4 py-2 rounded-full text-sm font-bold text-yellow-700 hover:bg-yellow-200"
        >
          Pendentes
        </button>
        <button
          onclick="filtrar('aprovado')"
          class="bg-blue-100 px-4 py-2 rounded-full text-sm font-bold text-blue-700 hover:bg-blue-200"
        >
          Aprovados
        </button>
        <button
          onclick="filtrar('concluido')"
          class="bg-green-100 px-4 py-2 rounded-full text-sm font-bold text-green-700 hover:bg-green-200"
        >
          Conclu√≠dos
        </button>
      </div>

      <div
        id="gridPedidos"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <div class="col-span-full text-center py-20 text-slate-400">
          <i
            data-lucide="loader-2"
            class="w-8 h-8 animate-spin mx-auto mb-4"
          ></i>
          Carregando pedidos...
        </div>
      </div>
    </div>

    <div
      id="modalDetalhes"
      class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto"
      >
        <div
          class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10"
        >
          <h2 class="text-xl font-bold text-slate-800">Detalhes do Pedido</h2>
          <button
            onclick="fecharModal()"
            class="p-2 hover:bg-slate-100 rounded-full"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div id="conteudoModal" class="p-6 space-y-6">
          </div>

        <div class="p-6 bg-slate-50 border-t border-slate-200">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700 flex items-center gap-2">
              <i data-lucide="dollar-sign" class="text-green-500 w-5 h-5"></i>
              Financeiro (Autom√°tico via IDs)
            </h3>
            <button
              onclick="aplicarSugestaoCalculo()"
              class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold hover:bg-blue-200 transition-colors flex items-center gap-1"
              title="For√ßar rec√°lculo autom√°tico usando pre√ßos atuais"
            >
              <i data-lucide="calculator" class="w-3 h-3"></i> Recalcular
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Valor Pacote + Comida</label
              >
              <div class="relative">
                <span
                  class="absolute left-3 top-2 text-slate-400 font-bold text-sm"
                  >R$</span
                >
                <input
                  type="number"
                  step="0.01"
                  id="fin_valor_final"
                  class="w-full pl-10 p-2 rounded border border-slate-300 font-mono font-bold text-slate-700"
                  placeholder="0.00"
                />
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Extras (Frete/Adic.)</label
              >
              <div class="relative">
                <span
                  class="absolute left-3 top-2 text-slate-400 font-bold text-sm"
                  >R$</span
                >
                <input
                  type="number"
                  step="0.01"
                  id="fin_valor_extras"
                  class="w-full pl-10 p-2 rounded border border-slate-300 font-mono font-bold text-slate-700"
                  placeholder="0.00"
                />
              </div>
            </div>
            <div class="col-span-full">
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Descri√ß√£o dos Extras</label
              >
              <input
                type="text"
                id="fin_desc_extras"
                class="w-full p-2 rounded border border-slate-300"
                placeholder="Ex: Frete + Lembrancinhas"
              />
            </div>
          </div>

          <div class="flex justify-between items-center mb-6 text-sm px-1">
            <span class="text-slate-500">Total Geral do Evento:</span>
            <span class="text-2xl font-bold text-green-600" id="displayTotal"
              >R$ 0,00</span
            >
          </div>

          <button
            onclick="executarFluxoCompleto()"
            id="btnFluxo"
            class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]"
          >
            <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i>
            <span>Salvar, Gerar Links e Copiar</span>
          </button>
          <p class="text-center text-xs text-slate-400 mt-2">
            Salva no banco, cria os links do Mercado Pago e copia o resumo para
            o WhatsApp.
          </p>

          <div id="areaLinks" class="hidden">
            <a id="link_reserva" href="#"></a>
            <a id="link_integral" href="#"></a>
          </div>
        </div>

        <div
          class="p-6 border-t border-slate-100 flex gap-3 justify-end bg-white sticky bottom-0"
        >
          <button
            onclick="acaoPedido('excluir')"
            class="px-4 py-2 text-red-500 font-bold hover:bg-red-50 rounded-lg text-sm"
          >
            Excluir Pedido
          </button>
          <button
            onclick="acaoPedido('aprovar')"
            id="btnAprovar"
            class="px-4 py-2 bg-blue-50 text-blue-700 font-bold rounded-lg hover:bg-blue-100 text-sm"
          >
            Marcar como Agendado
          </button>
          <button
            onclick="acaoPedido('concluir')"
            id="btnConcluir"
            class="px-4 py-2 bg-green-50 text-green-700 font-bold rounded-lg hover:bg-green-100 text-sm hidden"
          >
            Marcar como Conclu√≠do
          </button>
        </div>
      </div>
    </div>

    <script>
      const ADMIN_TOKEN = localStorage.getItem("cabana_admin_token");
      if (!ADMIN_TOKEN) window.location.href = "painel.html";

      let todosPedidos = [];
      let tabelaPrecos = []; // Hardware (Barracas)
      let listaCardapios = []; // Combos de Comida
      let listaAlimentos = []; // Itens individuais de Comida
      let pedidoAtual = null;

      // --- 1. CARREGAMENTO GERAL ---
      async function carregarDados() {
        try {
          // Carrega TUDO de uma vez para ter refer√™ncia de pre√ßos e IDs
          const [resPedidos, resPrecos, resCardapios, resAlimentos] =
            await Promise.all([
              fetch("/api/admin/pedidos", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/admin/precos", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/cardapios", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/alimentos", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
            ]);

          todosPedidos = await resPedidos.json();
          tabelaPrecos = await resPrecos.json();
          listaCardapios = await resCardapios.json();
          listaAlimentos = await resAlimentos.json();

          filtrar("todos");
        } catch (e) {
          console.error(e);
          alert("Erro de conex√£o. Verifique se o servidor est√° rodando.");
        }
      }

      function filtrar(status) {
        const grid = document.getElementById("gridPedidos");
        let filtrados = todosPedidos;

        if (status === "pendente")
          filtrados = todosPedidos.filter(
            (p) => p.status === "pendente" || !p.status,
          );
        if (status === "aprovado")
          filtrados = todosPedidos.filter(
            (p) => p.status === "aprovado" && p.status_agenda !== "concluido",
          );
        if (status === "concluido")
          filtrados = todosPedidos.filter(
            (p) => p.status_agenda === "concluido",
          );

        if (filtrados.length === 0) {
          grid.innerHTML =
            '<div class="col-span-full text-center py-20 text-slate-400">Nenhum pedido encontrado.</div>';
          return;
        }

        grid.innerHTML = filtrados
          .map((p) => {
            const dataFesta = new Date(p.data_festa).toLocaleDateString(
              "pt-BR",
            );
            let statusColor = "bg-yellow-100 text-yellow-700";
            let statusText = "Pendente";
            if (p.status === "aprovado") {
              statusColor = "bg-blue-100 text-blue-700";
              statusText = "Agendado";
            }
            if (p.status_agenda === "concluido") {
              statusColor = "bg-green-100 text-green-700";
              statusText = "Conclu√≠do";
            }

            return `
                <div onclick="abrirDetalhes(${p.id})" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all cursor-pointer group relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">${p.nome}</h3>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">${dataFesta} √†s ${p.horario}</p>
                        </div>
                        <span class="${statusColor} px-3 py-1 rounded-full text-xs font-bold">${statusText}</span>
                    </div>
                    <div class="space-y-1 text-sm text-slate-600 mb-4">
                        <p class="flex items-center gap-2"><i data-lucide="tent" class="w-4 h-4 text-pink-400"></i> ${p.modelo_barraca}</p>
                        <p class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-pink-400"></i> ${p.qtd_criancas} Crian√ßas</p>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-xs text-slate-400">Ver detalhes -></span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-pink-500 transition-colors"></i>
                    </div>
                </div>
            `;
          })
          .join("");
        lucide.createIcons();
      }

      // --- UTILIT√ÅRIOS ---
      function parseSeguro(dado) {
        if (!dado) return null;
        if (typeof dado === "object") return dado;
        try {
          return JSON.parse(dado);
        } catch (e) {
          return [dado];
        }
      }

      function normalizar(texto) {
        if (!texto) return "";
        return texto
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      }

      // --- CALCULADORA POR ID (INTELIGENTE) ---
      function calcularSugestaoFinanceira(pedido) {
        let totalBarracas = 0;
        let totalAlimentacao = 0;

        // 1. Barracas (Hardware)
        // L√≥gica: Tenta achar ID direto. Se falhar, normaliza nome.
        let itemHardware = tabelaPrecos.find(
          (t) => t.id == pedido.modelo_barraca,
        );
        if (!itemHardware) {
          const nomeModelo = normalizar(pedido.modelo_barraca);
          itemHardware = tabelaPrecos.find(
            (t) => normalizar(t.descricao) === nomeModelo,
          );
        }

        const valorUnitarioBarraca = itemHardware
          ? parseFloat(itemHardware.valor)
          : 0;
        const qtdBarracas = parseInt(pedido.qtd_barracas) || 0;
        totalBarracas = valorUnitarioBarraca * qtdBarracas;

        // 2. Alimenta√ß√£o (Combos e Extras via ID)
        const alim = parseSeguro(pedido.alimentacao);
        if (alim) {
          // A) COMBO
          if (alim.combo && alim.combo.id) {
            // Busca o pre√ßo ATUALIZADO na lista de card√°pios pelo ID
            const cardapioReal = listaCardapios.find(
              (c) => c.id == alim.combo.id,
            );
            if (cardapioReal) {
              const precoCombo = parseFloat(cardapioReal.valor_final); // valor calculado no backend
              if (cardapioReal.modo_cobranca === "por_pessoa") {
                totalAlimentacao +=
                  precoCombo * (parseInt(pedido.qtd_criancas) || 0);
              } else {
                totalAlimentacao += precoCombo; // pre√ßo fixo
              }
            } else {
              // Fallback: Se n√£o achar o ID (ex: deletado), usa o valor salvo no JSON do pedido
              const valorSalvo = parseFloat(alim.combo.valor_unitario) || 0;
              if (alim.combo.modo === "por_pessoa") {
                totalAlimentacao +=
                  valorSalvo * (parseInt(pedido.qtd_criancas) || 0);
              } else {
                totalAlimentacao += valorSalvo;
              }
            }
          }

          // B) EXTRAS
          if (alim.extras && Array.isArray(alim.extras)) {
            alim.extras.forEach((ext) => {
              // Busca pre√ßo ATUALIZADO na lista de alimentos pelo ID
              const alimentoReal = listaAlimentos.find((a) => a.id == ext.id);
              const qtd = parseInt(ext.qtd) || 0;
              if (alimentoReal) {
                totalAlimentacao += parseFloat(alimentoReal.valor) * qtd;
              } else {
                // Fallback
                totalAlimentacao += (parseFloat(ext.valor) || 0) * qtd;
              }
            });
          }
        }

        return {
          totalBase: totalBarracas + totalAlimentacao,
          totalExtras: 0,
        };
      }

      // --- ABRIR DETALHES ---
      function abrirDetalhes(id) {
        pedidoAtual = todosPedidos.find((p) => p.id === id);
        if (!pedidoAtual) return;

        // Renderiza√ß√£o Visual da Alimenta√ß√£o
        let htmlAlimentacao =
          '<span class="text-slate-400 italic">Nenhuma.</span>';
        const alim = parseSeguro(pedidoAtual.alimentacao);
        if (alim) {
          if (Array.isArray(alim) && alim.length > 0) {
            htmlAlimentacao = `<ul class="list-disc pl-4 text-slate-600">${alim.map((i) => `<li>${i}</li>`).join("")}</ul>`;
          } else if (alim.combo || (alim.extras && alim.extras.length > 0)) {
            let partes = [];
            if (alim.combo) {
              // Tenta mostrar nome atualizado se tiver ID
              const cardapioReal = alim.combo.id
                ? listaCardapios.find((c) => c.id == alim.combo.id)
                : null;
              const nomeCombo = cardapioReal
                ? cardapioReal.titulo
                : alim.combo.titulo;
              const valorCombo = parseFloat(
                alim.combo.valor_unitario,
              ).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

              partes.push(`
                            <div class="bg-pink-50 p-2 rounded mb-2 border border-pink-100">
                                <span class="font-bold text-slate-700 block">${nomeCombo}</span>
                                <span class="text-xs text-slate-500">${valorCombo} (${alim.combo.modo === "por_pessoa" ? "por pessoa" : "fixo"})</span>
                            </div>`);
            }
            if (alim.extras && alim.extras.length > 0) {
              partes.push(`<ul class="text-sm text-slate-600 space-y-1">`);
              alim.extras.forEach((e) => {
                const itemReal = e.id
                  ? listaAlimentos.find((a) => a.id == e.id)
                  : null;
                const nomeItem = itemReal ? itemReal.nome : e.nome;
                partes.push(`<li>${e.qtd}x ${nomeItem}</li>`);
              });
              partes.push(`</ul>`);
            }
            htmlAlimentacao = partes.join("");
          }
        }

        const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1">Cliente</h4>
                        <p><strong>Nome:</strong> ${pedidoAtual.nome}</p>
                        <p><strong>WhatsApp:</strong> <a href="https://wa.me/55${pedidoAtual.whatsapp.replace(/\D/g, "")}" target="_blank" class="text-green-600 font-bold">${pedidoAtual.whatsapp}</a></p>
                        <p><strong>Endere√ßo:</strong> ${pedidoAtual.endereco}</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1">Evento</h4>
                        <p><strong>Data:</strong> ${new Date(pedidoAtual.data_festa).toLocaleDateString("pt-BR")}</p>
                        <p><strong>Hor√°rio:</strong> ${pedidoAtual.horario}</p>
                        <p><strong>Modelo:</strong> ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas}x)</p>
                    </div>
                </div>
                <div class="border-t border-slate-100 pt-2 text-sm">
                     <p><strong>Alimenta√ß√£o:</strong></p>
                     ${htmlAlimentacao}
                </div>
                <div class="border-t border-slate-100 pt-2 text-sm grid grid-cols-2 gap-2">
                     <p><strong>Obs:</strong> ${pedidoAtual.itens_adicionais || "-"}</p>
                     <p><strong>Alergias:</strong> <span class="text-red-600 font-bold">${pedidoAtual.alergias || "-"}</span></p>
                </div>
            `;
        document.getElementById("conteudoModal").innerHTML = html;

        // --- PREENCHE FINANCEIRO ---
        const valorSalvoBase = parseFloat(pedidoAtual.valor_final) || 0;
        const valorSalvoExtra = parseFloat(pedidoAtual.valor_itens_extras) || 0;

        // Se estiver zerado, usa a calculadora baseada em ID
        if (valorSalvoBase === 0 && valorSalvoExtra === 0) {
          const sugestao = calcularSugestaoFinanceira(pedidoAtual);
          document.getElementById("fin_valor_final").value =
            sugestao.totalBase.toFixed(2);
          document.getElementById("fin_valor_extras").value =
            sugestao.totalExtras.toFixed(2);
        } else {
          document.getElementById("fin_valor_final").value =
            valorSalvoBase.toFixed(2);
          document.getElementById("fin_valor_extras").value =
            valorSalvoExtra.toFixed(2);
        }

        document.getElementById("fin_desc_extras").value =
          pedidoAtual.descricao_itens_extras || "";
        atualizarTotalVisual();

        // Bot√µes Status
        const btnAprovar = document.getElementById("btnAprovar");
        const btnConcluir = document.getElementById("btnConcluir");
        if (
          pedidoAtual.status === "aprovado" &&
          pedidoAtual.status_agenda !== "concluido"
        ) {
          btnAprovar.classList.add("hidden");
          btnConcluir.classList.remove("hidden");
        } else {
          btnAprovar.classList.remove("hidden");
          btnConcluir.classList.add("hidden");
        }

        // Reset Bot√£o M√°gico
        const btnFluxo = document.getElementById("btnFluxo");
        btnFluxo.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i> <span>Salvar, Gerar Links e Copiar</span>`;
        btnFluxo.className =
          "w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]";
        btnFluxo.disabled = false;

        document.getElementById("modalDetalhes").classList.remove("hidden");
        lucide.createIcons();
      }

      function fecharModal() {
        document.getElementById("modalDetalhes").classList.add("hidden");
      }

      function aplicarSugestaoCalculo() {
        if (!pedidoAtual) return;
        const sugestao = calcularSugestaoFinanceira(pedidoAtual);
        document.getElementById("fin_valor_final").value =
          sugestao.totalBase.toFixed(2);
        atualizarTotalVisual();
        alert("Valores recalculados usando os IDs e pre√ßos atuais do sistema!");
      }

      document
        .getElementById("fin_valor_final")
        .addEventListener("input", atualizarTotalVisual);
      document
        .getElementById("fin_valor_extras")
        .addEventListener("input", atualizarTotalVisual);

      function atualizarTotalVisual() {
        const vFinal =
          parseFloat(document.getElementById("fin_valor_final").value) || 0;
        const vExtras =
          parseFloat(document.getElementById("fin_valor_extras").value) || 0;
        document.getElementById("displayTotal").innerText = (
          vFinal + vExtras
        ).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      }

      // --- BOT√ÉO M√ÅGICO (FLUXO COMPLETO) ---
      async function executarFluxoCompleto() {
        if (!pedidoAtual) return;

        const btn = document.getElementById("btnFluxo");
        const conteudoOriginal = btn.innerHTML;

        btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Processando...`;
        btn.disabled = true;
        lucide.createIcons();

        try {
          const vFinal =
            parseFloat(document.getElementById("fin_valor_final").value) || 0;
          const vExtras =
            parseFloat(document.getElementById("fin_valor_extras").value) || 0;
          const descExtras = document.getElementById("fin_desc_extras").value;
          const vTotal = vFinal + vExtras;

          if (vTotal <= 0) throw new Error("Valor total inv√°lido.");

          // 1. Salvar
          await fetch(`/api/admin/pedidos/${pedidoAtual.id}/financeiro`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": ADMIN_TOKEN,
            },
            body: JSON.stringify({
              valor_final: vFinal,
              valor_itens_extras: vExtras,
              descricao_itens_extras: descExtras,
            }),
          });

          pedidoAtual.valor_final = vFinal;
          pedidoAtual.valor_itens_extras = vExtras;
          pedidoAtual.descricao_itens_extras = descExtras;

          // 2. Gerar Links
          const res = await fetch(
            `/api/admin/gerar-links-mp/${pedidoAtual.id}`,
            {
              method: "POST",
              headers: { "x-admin-password": ADMIN_TOKEN },
            },
          );
          const links = await res.json();

          document.getElementById("link_reserva").href = links.linkReserva;
          document.getElementById("link_integral").href = links.linkIntegral;

          // 3. Copiar
          const texto = `
Ol√°, ${pedidoAtual.nome}! ‚õ∫
Aqui est√° o resumo do seu or√ßamento para a *Cabana de Brincar*:

üìÖ Data: ${new Date(pedidoAtual.data_festa).toLocaleDateString("pt-BR")}
‚è∞ Hor√°rio: ${pedidoAtual.horario}
‚õ∫ Modelo: ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas} barracas)
üë• Convidados: ${pedidoAtual.qtd_criancas} crian√ßas

üí∞ *Resumo Financeiro:*
Valor Pacote: R$ ${vFinal.toFixed(2)}
Extras/Frete: R$ ${vExtras.toFixed(2)}
*TOTAL: R$ ${vTotal.toFixed(2)}*

---
*Op√ß√µes de Pagamento:*

1Ô∏è‚É£ **Sinal de Reserva (40%):** R$ ${(vTotal * 0.4).toFixed(2)}
üîó Link: ${links.linkReserva}
_(O restante deve ser pago at√© a data da festa)_

2Ô∏è‚É£ **√Ä Vista (5% de Desconto):** R$ ${(vTotal * 0.95).toFixed(2)}
üîó Link: ${links.linkIntegral}
---

Qualquer d√∫vida, √© s√≥ chamar! ‚ú®
`.trim();

          await navigator.clipboard.writeText(texto);

          // Sucesso
          btn.className =
            "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3";
          btn.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6"></i> <span>Sucesso! Copiado.</span>`;
          lucide.createIcons();

          setTimeout(() => {
            btn.className =
              "w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]";
            btn.innerHTML = conteudoOriginal;
            btn.disabled = false;
            lucide.createIcons();
          }, 4000);
        } catch (e) {
          console.error(e);
          alert("Erro: " + e.message);
          btn.innerHTML = conteudoOriginal;
          btn.disabled = false;
          lucide.createIcons();
        }
      }

      async function acaoPedido(acao) {
        if (!pedidoAtual) return;
        if (!confirm(`Tem certeza que deseja ${acao} este pedido?`)) return;

        let url = "";
        let method = "PUT";

        if (acao === "aprovar")
          url = `/api/admin/agenda/aprovar/${pedidoAtual.id}`;
        if (acao === "concluir")
          url = `/api/admin/agenda/concluir/${pedidoAtual.id}`;
        if (acao === "excluir") {
          url = `/api/admin/pedidos/${pedidoAtual.id}`;
          method = "DELETE";
        }

        try {
          await fetch(url, {
            method: method,
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          fecharModal();
          carregarDados();
        } catch (e) {
          alert("Erro na a√ß√£o");
        }
      }

      carregarDados();
    </script>
  </body>
</html>