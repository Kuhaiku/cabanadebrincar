<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gest√£o de Pedidos - Cabana de Brincar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: "Inter", sans-serif;
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }

    /* Anima√ß√£o suave para o modal */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-animate {
      animation: fadeIn 0.2s ease-out forwards;
    }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex text-slate-800">
  <aside class="w-64 bg-white border-r border-slate-200 flex-col hidden md:flex z-20 shadow-sm fixed h-full">
    <div class="p-6 border-b border-slate-100 flex items-center gap-3">
      <img src="/assets/logo.png" alt="Logo" class="w-8 h-8 rounded-lg" />
      <span class="font-bold text-lg text-slate-700">Admin</span>
    </div>
    <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
      <a href="/admin-gerenciador.html"
        class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">
        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
        <span class="font-medium">Dashboard</span>
      </a>
      <a href="/admin-pedidos.html"
        class="flex items-center gap-3 px-4 py-3 bg-pink-50 text-pink-600 rounded-xl transition-all shadow-sm">
        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
        <span class="font-bold">Pedidos</span>
      </a>
      <a href="/admin-agenda.html"
        class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">
        <i data-lucide="calendar" class="w-5 h-5"></i>
        <span class="font-medium">Agenda</span>
      </a>
      <a href="/admin-financeiro.html"
        class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">
        <i data-lucide="dollar-sign" class="w-5 h-5"></i>
        <span class="font-medium">Financeiro</span>
      </a>
      <div class="pt-4 mt-4 border-t border-slate-100">
        <p class="px-4 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Configura√ß√µes</p>
        <a href="/admin-cardapio.html"
          class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">
          <i data-lucide="utensils" class="w-5 h-5"></i>
          <span class="font-medium">Card√°pio</span>
        </a>
        <a href="/admin-simulador.html"
          class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-slate-50 rounded-xl transition-all">
          <i data-lucide="settings-2" class="w-5 h-5"></i>
          <span class="font-medium">Pre√ßos & Itens</span>
        </a>
      </div>
    </nav>
  </aside>

  <main class="flex-1 md:ml-64 p-4 md:p-8 overflow-x-hidden">
    <div
      class="md:hidden flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
      <div class="flex items-center gap-2">
        <img src="/assets/logo.png" alt="Logo" class="w-8 h-8 rounded" />
        <span class="font-bold text-slate-700">Admin Pedidos</span>
      </div>
      <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="p-2 text-slate-600">
        <i data-lucide="menu"></i>
      </button>
    </div>

    <header class="mb-8">
      <h1 class="text-3xl font-bold text-slate-800 mb-2">Gest√£o de Pedidos</h1>
      <p class="text-slate-500">Visualize, edite e aprove os or√ßamentos recebidos.</p>
    </header>

    <div
      class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-6 flex flex-wrap gap-2 items-center justify-between">
      <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0 hide-scrollbar">
        <button onclick="filtrar('todos')"
          class="px-4 py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors whitespace-nowrap active-filter"
          id="filter-todos">Todos</button>
        <button onclick="filtrar('pendente')"
          class="px-4 py-2 rounded-full text-sm font-medium bg-yellow-50 text-yellow-600 hover:bg-yellow-100 transition-colors whitespace-nowrap"
          id="filter-pendente">Pendentes</button>
        <button onclick="filtrar('aprovado')"
          class="px-4 py-2 rounded-full text-sm font-medium bg-green-50 text-green-600 hover:bg-green-100 transition-colors whitespace-nowrap"
          id="filter-aprovado">Aprovados</button>
        <button onclick="filtrar('finalizado')"
          class="px-4 py-2 rounded-full text-sm font-medium bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors whitespace-nowrap"
          id="filter-finalizado">Finalizados</button>
        <button onclick="filtrar('cancelado')"
          class="px-4 py-2 rounded-full text-sm font-medium bg-red-50 text-red-600 hover:bg-red-100 transition-colors whitespace-nowrap"
          id="filter-cancelado">Cancelados</button>
      </div>
      <div class="w-full md:w-auto relative">
        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
        <input type="text" id="searchInput" placeholder="Buscar cliente..." onkeyup="filtrarNome()"
          class="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-pink-500/20 focus:border-pink-500 transition-all">
      </div>
    </div>

    <div id="listaPedidos" class="grid grid-cols-1 gap-4">
    </div>
  </main>

  <div id="modalDetalhes" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="fecharDetalhes()"></div>
    <div
      class="absolute inset-y-0 right-0 w-full md:w-[600px] bg-white shadow-2xl transform transition-transform duration-300 flex flex-col modal-animate">

      <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-white z-10">
        <div>
          <h2 class="text-2xl font-bold text-slate-800" id="modalTitulo">Detalhes do Pedido</h2>
          <p class="text-sm text-slate-500" id="modalSubtitulo">ID: #000</p>
        </div>
        <button onclick="fecharDetalhes()"
          class="p-2 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-6 space-y-8 bg-white" id="conteudoModal">
      </div>

      <div class="bg-slate-50 border-t border-slate-200 p-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">

        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-slate-700 flex items-center gap-2">
            <i data-lucide="dollar-sign" class="text-green-500 w-5 h-5"></i>
            Financeiro
          </h3>
          <button onclick="aplicarSugestaoCalculo()"
            class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold hover:bg-blue-200 transition-colors flex items-center gap-1">
            <i data-lucide="calculator" class="w-3 h-3"></i> Recalcular Tudo
          </button>
        </div>

        <div class="mb-4 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
          <label class="text-xs font-bold text-slate-500 uppercase block mb-2">Taxas Fixas & Servi√ßos</label>
          <div id="areaTaxasSistema" class="grid grid-cols-2 gap-2">
            <p class="text-xs text-slate-400 col-span-2">Carregando taxas...</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Valor Pacote (R$)</label>
            <input type="number" id="fin_valor_final"
              class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 font-mono font-medium"
              onchange="atualizarTotalVisual()">
          </div>
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Outros Extras (R$)</label>
            <input type="number" id="fin_valor_extras"
              class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 font-mono font-medium"
              placeholder="0.00" onchange="atualizarTotalVisual()">
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descri√ß√£o dos Extras</label>
          <input type="text" id="fin_desc_extras"
            class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm"
            placeholder="Ex: Frete adicional bairro X...">
        </div>

        <div class="flex justify-between items-center mb-6 bg-green-50 p-3 rounded-lg border border-green-100">
          <span class="text-green-800 font-bold">Total Final:</span>
          <span id="displayTotal" class="text-xl font-bold text-green-700">R$ 0,00</span>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3">
          <button onclick="atualizarStatus('aprovado')"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors text-sm flex justify-center items-center gap-2">
            <i data-lucide="thumbs-up" class="w-4 h-4"></i> Aprovar Apenas
          </button>
          <button onclick="atualizarStatus('finalizado')"
            class="bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl transition-colors text-sm flex justify-center items-center gap-2">
            <i data-lucide="check-square" class="w-4 h-4"></i> Finalizar
          </button>
        </div>

        <button id="btnFluxo" onclick="executarFluxoCompleto()"
          class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]">
          <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400"></i>
          <span>Salvar, Gerar Links e Copiar</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_TOKEN = localStorage.getItem("cabana_admin_token");
    if (!ADMIN_TOKEN) window.location.href = "/index.html";

    let todosPedidos = [];
    let tabelaPrecos = [];
    let listaCardapios = [];
    let listaAlimentos = [];
    let taxasSistema = []; // Armazena itens de categoria 'sistema'
    let pedidoAtual = null;

    // Inicializa√ß√£o
    window.onload = () => {
      carregarDados();
      lucide.createIcons();
    };

    async function carregarDados() {
      try {
        const [resPedidos, resPrecos, resCardapios, resAlimentos, resItens] =
          await Promise.all([
            fetch("/api/admin/pedidos", { headers: { "x-admin-password": ADMIN_TOKEN } }),
            fetch("/api/admin/precos", { headers: { "x-admin-password": ADMIN_TOKEN } }),
            fetch("/api/cardapios", { headers: { "x-admin-password": ADMIN_TOKEN } }),
            fetch("/api/alimentos", { headers: { "x-admin-password": ADMIN_TOKEN } }),
            fetch("/api/itens-disponiveis") // Busca itens para os checkboxes
          ]);

        todosPedidos = await resPedidos.json();
        tabelaPrecos = await resPrecos.json();
        listaCardapios = await resCardapios.json();
        listaAlimentos = await resAlimentos.json();

        // Filtra apenas taxas de sistema
        const todosItens = await resItens.json();
        taxasSistema = todosItens.filter(i => i.categoria === 'sistema');

        filtrar("todos");
      } catch (e) {
        console.error(e);
        alert("Erro de conex√£o. Verifique o servidor.");
      }
    }

    // --- FILTROS E RENDERIZA√á√ÉO DA LISTA ---
    function filtrar(status) {
      document.querySelectorAll(".active-filter").forEach((el) => {
        el.classList.remove("bg-slate-200", "active-filter");
        el.classList.add("bg-slate-100");
      });
      const btn = document.getElementById(`filter-${status}`);
      if (btn) {
        btn.classList.remove("bg-slate-100");
        btn.classList.add("bg-slate-200", "active-filter");
      }

      const lista = document.getElementById("listaPedidos");
      lista.innerHTML = "";

      const filtrados = todosPedidos
        .filter((p) => status === "todos" || p.status === status)
        .sort((a, b) => new Date(b.data_criacao) - new Date(a.data_criacao));

      if (filtrados.length === 0) {
        lista.innerHTML = `<div class="text-center p-12 text-slate-400">Nenhum pedido encontrado.</div>`;
        return;
      }

      filtrados.forEach((p) => {
        const dataFesta = new Date(p.data_festa).toLocaleDateString("pt-BR");
        const statusColors = {
          pendente: "bg-yellow-100 text-yellow-700",
          aprovado: "bg-blue-100 text-blue-700",
          agendado: "bg-purple-100 text-purple-700",
          finalizado: "bg-green-100 text-green-700",
          cancelado: "bg-red-100 text-red-700",
        };

        const statusPagColors = {
          pendente: "bg-slate-100 text-slate-500",
          parcial: "bg-orange-100 text-orange-600",
          pago: "bg-green-100 text-green-600"
        };

        const iconMoney = p.status_pagamento === 'pago' ? 'check-circle' : (p.status_pagamento === 'parcial' ? 'pie-chart' : 'circle');

        const card = document.createElement("div");
        card.className = "bg-white p-5 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow cursor-pointer group";
        card.onclick = () => abrirDetalhes(p.id);
        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg group-hover:text-pink-600 transition-colors">${p.nome}</h3>
                    <p class="text-sm text-slate-500 flex items-center gap-1">
                        <i data-lucide="calendar" class="w-3 h-3"></i> ${dataFesta} √†s ${p.horario}
                    </p>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${statusColors[p.status] || "bg-gray-100"}">
                        ${p.status}
                    </span>
                     <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase flex items-center gap-1 ${statusPagColors[p.status_pagamento] || "bg-gray-100"}">
                        <i data-lucide="${iconMoney}" class="w-3 h-3"></i> ${p.status_pagamento || 'pendente'}
                    </span>
                </div>
            </div>
            <div class="flex items-center justify-between mt-4 pt-4 border-t border-slate-100">
                <div class="text-sm text-slate-600">
                    <span class="font-medium text-slate-800">${p.modelo_barraca}</span>
                    <span class="text-slate-400 mx-1">‚Ä¢</span>
                    ${p.qtd_barracas} un.
                </div>
                <i data-lucide="chevron-right" class="text-slate-300"></i>
            </div>
          `;
        lista.appendChild(card);
      });
      lucide.createIcons();
    }

    function filtrarNome() {
      const termo = document.getElementById("searchInput").value.toLowerCase();
      if (!termo) return filtrar("todos");

      const cards = document.querySelectorAll("#listaPedidos > div");
      cards.forEach(card => {
        const nome = card.querySelector("h3").innerText.toLowerCase();
        card.style.display = nome.includes(termo) ? "block" : "none";
      });
    }

    // --- DETALHES DO PEDIDO ---
    function abrirDetalhes(id) {
      pedidoAtual = todosPedidos.find((p) => p.id === id);
      if (!pedidoAtual) return;

      // Renderiza HTML do Topo (Cliente, Info, Itens, Comida)
      document.getElementById("modalTitulo").innerText = pedidoAtual.nome;
      document.getElementById("modalSubtitulo").innerText = `ID: #${pedidoAtual.id} ‚Ä¢ Criado em ${new Date(pedidoAtual.data_criacao).toLocaleDateString("pt-BR")}`;

      // Parse seguro
      const itensPadraoArr = parseSeguro(pedidoAtual.itens_padrao);
      const alimObj = parseSeguro(pedidoAtual.alimentacao);

      let htmlAlim = `<div class="p-4 bg-slate-50 rounded-lg text-sm text-slate-500 text-center">Nenhuma alimenta√ß√£o contratada</div>`;
      if (alimObj) {
        htmlAlim = `<div class="space-y-3">`;
        if (alimObj.combo) {
          htmlAlim += `
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                        <p class="font-bold text-orange-800 flex items-center gap-2"><i data-lucide="utensils"></i> Combo Selecionado</p>
                        <p class="text-sm text-orange-700">${alimObj.combo.titulo || "Combo Personalizado"}</p>
                    </div>`;
        }
        if (alimObj.extras && alimObj.extras.length > 0) {
          htmlAlim += `<div class="bg-white p-3 rounded-lg border border-slate-200"><p class="font-bold text-slate-700 mb-2 text-xs uppercase">Itens Avulsos</p><ul class="space-y-1">`;
          alimObj.extras.forEach(e => {
            htmlAlim += `<li class="text-sm text-slate-600 flex justify-between"><span>${e.nome}</span><span class="font-mono bg-slate-100 px-1 rounded text-xs">x${e.qtd}</span></li>`;
          });
          htmlAlim += `</ul></div>`;
        }
        htmlAlim += `</div>`;
      }

      document.getElementById("conteudoModal").innerHTML = `
            <div class="space-y-4">
                <div class="flex items-center gap-3 text-slate-700">
                    <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-pink-600">
                        <i data-lucide="user" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-bold text-lg">${pedidoAtual.nome}</p>
                        <p class="text-sm text-slate-500">${pedidoAtual.email}</p>
                        <p class="text-sm text-slate-500">${pedidoAtual.telefone}</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Evento</p>
                        <p class="font-medium text-slate-700">${new Date(pedidoAtual.data_festa).toLocaleDateString("pt-BR")}</p>
                        <p class="text-slate-500">${pedidoAtual.horario}</p>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Local</p>
                        <p class="font-medium text-slate-700 break-words">${pedidoAtual.endereco}</p>
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <div>
                <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i data-lucide="tent" class="w-4 h-4 text-pink-500"></i> Estrutura
                </h3>
                <div class="bg-white border border-slate-200 rounded-xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-700">${pedidoAtual.modelo_barraca}</span>
                        <span class="bg-pink-100 text-pink-700 text-xs font-bold px-2 py-1 rounded-full">${pedidoAtual.qtd_barracas} un</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-1">Tema: <span class="font-medium">${pedidoAtual.tema}</span></p>
                    <p class="text-sm text-slate-600 mb-3">P√∫blico: ${pedidoAtual.qtd_criancas} crian√ßas (${pedidoAtual.faixa_etaria})</p>
                    
                    <div class="bg-slate-50 p-3 rounded-lg">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Itens Inclusos</p>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            ${Array.isArray(itensPadraoArr) && itensPadraoArr.length ? itensPadraoArr.join(", ") : "Itens padr√£o do pacote"}
                        </p>
                    </div>
                </div>
            </div>

            <div>
                 <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i data-lucide="utensils-crossed" class="w-4 h-4 text-orange-500"></i> Alimenta√ß√£o
                </h3>
                ${htmlAlim}
            </div>

            ${pedidoAtual.itens_adicionais ? `
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                <p class="text-xs font-bold text-yellow-700 uppercase mb-1">Observa√ß√µes do Cliente</p>
                <p class="text-sm text-yellow-800">${pedidoAtual.itens_adicionais}</p>
            </div>` : ''}
        `;

      // --- RENDERIZAR CHECKBOXES DE TAXAS (NOVO) ---
      const divTaxas = document.getElementById("areaTaxasSistema");
      divTaxas.innerHTML = "";

      if (taxasSistema.length > 0) {
        taxasSistema.forEach(taxa => {
          const htmlId = `taxa_${taxa.id}`;
          const valorNum = parseFloat(taxa.valor);
          const valorFormatado = valorNum.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

          // Verifica se essa taxa j√° est√° na descri√ß√£o salva
          const descSalva = (pedidoAtual.descricao_itens_extras || "").toLowerCase();
          const isMarcado = descSalva.includes(taxa.descricao.toLowerCase());

          divTaxas.innerHTML += `
                    <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-100">
                        <input type="checkbox" id="${htmlId}" value="${valorNum}" data-nome="${taxa.descricao}" 
                               onchange="atualizarTotalVisual()" ${isMarcado ? "checked" : ""}
                               class="w-4 h-4 text-pink-600 rounded border-gray-300 focus:ring-pink-500 cursor-pointer">
                        <label for="${htmlId}" class="text-sm text-slate-700 cursor-pointer select-none flex-1 flex justify-between">
                            <span>${taxa.descricao}</span>
                            <span class="text-xs font-bold text-slate-500">${valorFormatado}</span>
                        </label>
                    </div>
                `;
        });
      } else {
        divTaxas.innerHTML = "<p class='text-xs text-slate-400 col-span-2 italic'>Cadastre itens com categoria 'sistema' em Pre√ßos para aparecerem aqui.</p>";
      }

      // --- PREPARA√á√ÉO DOS VALORES FINANCEIROS ---
      const valorSalvoBase = parseFloat(pedidoAtual.valor_final) || 0;
      let valorSalvoExtraTotal = parseFloat(pedidoAtual.valor_itens_extras) || 0;

      // Calcula quanto do extra salvo j√° est√° coberto pelos checkboxes marcados
      let somaTaxasDetectadas = 0;
      const checkboxes = divTaxas.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        if (cb.checked) somaTaxasDetectadas += parseFloat(cb.value);
      });

      // O campo manual exibe apenas a diferen√ßa (o que foi digitado manualmente antes)
      let valorManual = valorSalvoExtraTotal - somaTaxasDetectadas;
      // Ajuste fino para evitar -0.00001
      if (valorManual < 0.01 && valorManual > -0.01) valorManual = 0;

      document.getElementById("fin_valor_final").value = valorSalvoBase.toFixed(2);
      document.getElementById("fin_valor_extras").value = valorManual.toFixed(2);
      document.getElementById("fin_desc_extras").value = pedidoAtual.descricao_itens_extras || "";

      atualizarTotalVisual(); // Atualiza o display do Total Geral

      document.getElementById("modalDetalhes").classList.remove("hidden");
      lucide.createIcons();
    }

    function fecharDetalhes() {
      document.getElementById("modalDetalhes").classList.add("hidden");
      pedidoAtual = null;
    }

    // --- C√ÅLCULO VISUAL DO TOTAL ---
    function atualizarTotalVisual() {
      // 1. Valor Base
      const vFinal = parseFloat(document.getElementById("fin_valor_final").value) || 0;

      // 2. Soma Checkboxes
      let vTaxas = 0;
      const checkboxes = document.querySelectorAll('#areaTaxasSistema input[type="checkbox"]:checked');
      checkboxes.forEach(cb => {
        vTaxas += parseFloat(cb.value);
      });

      // 3. Soma Input Manual
      const vManual = parseFloat(document.getElementById("fin_valor_extras").value) || 0;

      const totalGeral = vFinal + vTaxas + vManual;

      document.getElementById("displayTotal").innerHTML = `
            <span class="text-xs text-slate-400 font-normal mr-2 hidden md:inline">
                (Pacote: ${vFinal.toFixed(0)} + Taxas: ${vTaxas.toFixed(0)} + Extra: ${vManual.toFixed(0)})
            </span>
            ${totalGeral.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}
        `;
    }

    // --- ATUALIZA STATUS SIMPLES ---
    async function atualizarStatus(novoStatus) {
      if (!pedidoAtual) return;
      try {
        await fetch(`/api/admin/pedidos/${pedidoAtual.id}/status`, {
          method: "PUT",
          headers: { "Content-Type": "application/json", "x-admin-password": ADMIN_TOKEN },
          body: JSON.stringify({ status: novoStatus }),
        });
        pedidoAtual.status = novoStatus;
        // Atualiza lista visualmente
        const card = document.querySelector(`#listaPedidos h3:contains('${pedidoAtual.nome}')`)?.closest('div');
        carregarDados(); // Recarrega para garantir
        fecharDetalhes();
      } catch (e) { console.error(e); }
    }

    // --- SUGEST√ÉO DE PRE√áO ---
    function aplicarSugestaoCalculo() {
      if (!pedidoAtual) return;

      // L√≥gica simples: busca pre√ßo base do modelo
      const modelo = tabelaPrecos.find(i => i.descricao === pedidoAtual.modelo_barraca);
      if (modelo) {
        const precoUnit = parseFloat(modelo.valor);
        const qtd = parseInt(pedidoAtual.qtd_barracas);
        const totalSugerido = precoUnit * qtd;

        document.getElementById("fin_valor_final").value = totalSugerido.toFixed(2);
        atualizarTotalVisual();
        alert(`Pre√ßo base recalculado: ${qtd}x ${modelo.descricao} = R$ ${totalSugerido}`);
      } else {
        alert("Modelo n√£o encontrado na tabela de pre√ßos.");
      }
    }

    // --- FLUXO COMPLETO E INTELIGENTE ---
    async function executarFluxoCompleto() {
      if (!pedidoAtual) return;

      const btn = document.getElementById("btnFluxo");
      const conteudoOriginal = btn.innerHTML;

      btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Processando...`;
      btn.disabled = true;
      lucide.createIcons();

      try {
        // 1. Captura inputs
        const vFinal = parseFloat(document.getElementById("fin_valor_final").value) || 0;
        const vManual = parseFloat(document.getElementById("fin_valor_extras").value) || 0;

        // 2. Calcula Checkboxes
        let vTaxas = 0;
        let nomesTaxas = [];
        const checkboxes = document.querySelectorAll('#areaTaxasSistema input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
          vTaxas += parseFloat(cb.value);
          nomesTaxas.push(cb.getAttribute('data-nome'));
        });

        // 3. Totais Consolidados
        const vExtrasTotal = vTaxas + vManual;
        const vTotalGeral = vFinal + vExtrasTotal;

        if (vTotalGeral <= 0) throw new Error("Valor total inv√°lido.");

        // 4. Monta Descri√ß√£o Inteligente
        let descUsuario = document.getElementById("fin_desc_extras").value.trim();
        let descFinal = descUsuario;

        if (nomesTaxas.length > 0) {
          const taxasString = nomesTaxas.join(", ");
          // Se a descri√ß√£o do usu√°rio n√£o cont√©m os nomes das taxas, adiciona
          if (!descUsuario.toLowerCase().includes(nomesTaxas[0].toLowerCase())) {
            descFinal = descUsuario ? `${taxasString} + ${descUsuario}` : taxasString;
          }
        }

        // 5. Salva no Banco (Envia a SOMA dos extras)
        await fetch(`/api/admin/pedidos/${pedidoAtual.id}/financeiro`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "x-admin-password": ADMIN_TOKEN,
          },
          body: JSON.stringify({
            valor_final: vFinal,
            valor_itens_extras: vExtrasTotal,
            descricao_itens_extras: descFinal,
          }),
        });

        // Atualiza objeto local
        pedidoAtual.valor_final = vFinal;
        pedidoAtual.valor_itens_extras = vExtrasTotal;
        pedidoAtual.descricao_itens_extras = descFinal;

        // 6. Gera Links do Mercado Pago (Backend vai calcular os 50% e 95% baseados no Total Geral)
        const res = await fetch(
          `/api/admin/gerar-links-mp/${pedidoAtual.id}`,
          {
            method: "POST",
            headers: { "x-admin-password": ADMIN_TOKEN },
          },
        );

        const links = await res.json(); // { linkReserva, reserva, linkRestante, restante, linkIntegral, integral }

        if (!links.linkReserva || !links.linkIntegral) {
          throw new Error("Falha ao receber links do servidor.");
        }

        // --- GERA TEXTO WHATSAPP ---
        const itensPadraoArr = parseSeguro(pedidoAtual.itens_padrao);
        const textoItens = Array.isArray(itensPadraoArr) && itensPadraoArr.length > 0
          ? itensPadraoArr.join(", ")
          : "Itens padr√£o do modelo";

        const alimObj = parseSeguro(pedidoAtual.alimentacao);
        let textoComida = "Nenhuma contratada";

        if (alimObj) {
          let partesComida = [];
          if (alimObj.combo) {
            let tituloCombo = alimObj.combo.titulo || "Combo";
            partesComida.push(`ü•™ *Pacote:* ${tituloCombo}`);
          }
          if (alimObj.extras && Array.isArray(alimObj.extras) && alimObj.extras.length > 0) {
            const listaExtras = alimObj.extras.map(e => `${e.qtd}x ${e.nome}`).join(", ");
            partesComida.push(`‚ûï *Extras:* ${listaExtras}`);
          }
          if (partesComida.length > 0) textoComida = partesComida.join("\n");
        }

        // Formata√ß√£o do resumo financeiro para o cliente
        const textoExtras = vExtrasTotal !== 0
          ? `\nTaxas/Extras: R$ ${vExtrasTotal.toFixed(2).replace('.', ',')} (${descFinal})`
          : '';

        const texto = `
Ol√°, ${pedidoAtual.nome}! ‚õ∫‚ú®
Aqui est√° o or√ßamento detalhado da sua *Cabana de Brincar*!

üóìÔ∏è *Sua Festa:*
Data: ${new Date(pedidoAtual.data_festa).toLocaleDateString("pt-BR")} √†s ${pedidoAtual.horario}
Endere√ßo: ${pedidoAtual.endereco}

üé™ *Estrutura:*
Modelo: ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas} unidades)
Participantes: ${pedidoAtual.qtd_criancas} crian√ßas
Tema: ${pedidoAtual.tema}

ü•£ *Alimenta√ß√£o:*
${textoComida}

üí∞ *Resumo Financeiro:*
Pacote Base: R$ ${vFinal.toFixed(2).replace('.', ',')}${textoExtras}
*Total Final:* R$ ${vTotalGeral.toFixed(2).replace('.', ',')}

---
*FORMAS DE PAGAMENTO:*
Voc√™ pode garantir sua data agora de duas formas:

1Ô∏è‚É£ **Sinal de Reserva (50%):**
Pague R$ ${links.reserva.replace('.', ',')} agora para reservar a data.
O restante (R$ ${links.restante.replace('.', ',')}) pode ser pago at√© o dia da festa.
üîó Link Sinal: ${links.linkReserva}
üîó Link Restante: ${links.linkRestante}

2Ô∏è‚É£ **Valor Total √† Vista (5% DE DESCONTO):**
Pague tudo agora com desconto e fique livre!
De: ~R$ ${vTotalGeral.toFixed(2).replace('.', ',')}~
Por: *R$ ${links.integral.replace('.', ',')}*
üîó Link Com Desconto: ${links.linkIntegral}
---

Fico no aguardo para confirmarmos! Qualquer d√∫vida √© s√≥ chamar. ü•∞
`.trim();

        // Copiar
        await navigator.clipboard.writeText(texto);

        // Sucesso
        btn.className = "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3";
        btn.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6"></i> <span>Sucesso! Copiado.</span>`;
        lucide.createIcons();

        setTimeout(() => {
          btn.className = "w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]";
          btn.innerHTML = conteudoOriginal;
          btn.disabled = false;
          lucide.createIcons();
        }, 4000);

      } catch (e) {
        console.error(e);
        alert("Erro: " + e.message);
        btn.innerHTML = conteudoOriginal;
        btn.disabled = false;
        lucide.createIcons();
      }
    }

    function parseSeguro(str) {
      if (!str) return null;
      try { return JSON.parse(str); } catch (e) { return str; }
    }
  </script>
</body>

</html>