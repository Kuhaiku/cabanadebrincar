<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pedidos | Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap");
      body {
        font-family: "Quicksand", sans-serif;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
      <header class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-4">
          <a
            href="painel.html"
            class="p-2 bg-white rounded-xl hover:bg-slate-100 transition-colors"
            ><i data-lucide="arrow-left" class="text-slate-600"></i
          ></a>
          <h1 class="text-2xl font-bold text-slate-800">
            Pedidos & Or√ßamentos
          </h1>
        </div>
        <button
          onclick="carregarDados()"
          class="bg-white text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-100 flex items-center gap-2"
        >
          <i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualizar
        </button>
      </header>

      <div class="flex gap-4 mb-6 overflow-x-auto pb-2">
        <button
          onclick="filtrar('todos')"
          class="bg-white px-4 py-2 rounded-full text-sm font-bold text-slate-600 shadow-sm hover:shadow-md border border-slate-100"
        >
          Todos
        </button>
        <button
          onclick="filtrar('pendente')"
          class="bg-yellow-100 px-4 py-2 rounded-full text-sm font-bold text-yellow-700 hover:bg-yellow-200"
        >
          Pendentes
        </button>
        <button
          onclick="filtrar('aprovado')"
          class="bg-blue-100 px-4 py-2 rounded-full text-sm font-bold text-blue-700 hover:bg-blue-200"
        >
          Aprovados
        </button>
        <button
          onclick="filtrar('concluido')"
          class="bg-green-100 px-4 py-2 rounded-full text-sm font-bold text-green-700 hover:bg-green-200"
        >
          Conclu√≠dos
        </button>
      </div>

      <div
        id="gridPedidos"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <div class="col-span-full text-center py-20 text-slate-400">
          <i
            data-lucide="loader-2"
            class="w-8 h-8 animate-spin mx-auto mb-4"
          ></i>
          Carregando pedidos...
        </div>
      </div>
    </div>

    <div
      id="modalDetalhes"
      class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto"
      >
        <div
          class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10"
        >
          <h2 class="text-xl font-bold text-slate-800">Detalhes do Pedido</h2>
          <button
            onclick="fecharModal()"
            class="p-2 hover:bg-slate-100 rounded-full"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div id="conteudoModal" class="p-6 space-y-6"></div>

        <div class="p-6 bg-slate-50 border-t border-slate-200">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700 flex items-center gap-2">
              <i data-lucide="dollar-sign" class="text-green-500 w-5 h-5"></i>
              Financeiro
            </h3>
            <button
              onclick="aplicarSugestaoCalculo()"
              class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold hover:bg-blue-200 transition-colors flex items-center gap-1"
              title="Recalcular valor base"
            >
              <i data-lucide="calculator" class="w-3 h-3"></i> Recalcular Base
            </button>
          </div>

          <div class="mb-4 bg-white p-4 rounded-xl border border-slate-200">
            <label class="text-xs font-bold text-slate-500 uppercase block mb-3"
              >Taxas Fixas & Servi√ßos</label
            >
            <div id="areaTaxasSistema" class="grid grid-cols-2 gap-3">
              <p class="text-xs text-slate-400 col-span-2">
                Carregando taxas...
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Valor Pacote</label
              >
              <div class="relative">
                <span
                  class="absolute left-3 top-2 text-slate-400 font-bold text-sm"
                  >R$</span
                >
                <input
                  type="number"
                  step="0.01"
                  id="fin_valor_final"
                  onchange="atualizarTotalVisual()"
                  class="w-full pl-10 p-2 rounded border border-slate-300 font-mono font-bold text-slate-700"
                  placeholder="0.00"
                />
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Extra Manual (Frete/Adic.)</label
              >
              <div class="relative">
                <span
                  class="absolute left-3 top-2 text-slate-400 font-bold text-sm"
                  >R$</span
                >
                <input
                  type="number"
                  step="0.01"
                  id="fin_valor_extras"
                  onchange="atualizarTotalVisual()"
                  class="w-full pl-10 p-2 rounded border border-slate-300 font-mono font-bold text-slate-700"
                  placeholder="0.00"
                />
              </div>
            </div>
            <div class="col-span-full">
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Descri√ß√£o dos Extras</label
              >
              <input
                type="text"
                id="fin_desc_extras"
                class="w-full p-2 rounded border border-slate-300 text-sm"
                placeholder="Ex: Frete especial..."
              />
            </div>
          </div>

          <div
            class="flex justify-between items-center mb-6 text-sm px-1 bg-green-50 p-3 rounded-lg border border-green-100"
          >
            <span class="text-green-800 font-bold">Total Geral:</span>
            <div class="text-right">
              <span id="displayTotal" class="text-xl font-bold text-green-700"
                >R$ 0,00</span
              >
              <p class="text-[10px] text-green-600" id="displayResumo">
                Pacote + Taxas + Extra
              </p>
            </div>
          </div>

          <button
            onclick="executarFluxoCompleto()"
            id="btnFluxo"
            class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]"
          >
            <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i>
            <span>Salvar, Gerar Links e Copiar</span>
          </button>

          <p class="text-center text-xs text-slate-400 mt-2">
            Salva no banco, gera link de 50% (Sinal), 50% (Restante) e 100% (c/
            5% OFF).
          </p>
        </div>

        <div
          class="p-6 border-t border-slate-100 flex gap-3 justify-end bg-white sticky bottom-0 items-center"
        >
          <div class="flex-1" id="areaAvisoModal"></div>
          
          <button
            onclick="acaoPedido('excluir')"
            class="px-4 py-2 text-red-500 font-bold hover:bg-red-50 rounded-lg text-sm"
          >
            Excluir
          </button>
          <button
            onclick="acaoPedido('aprovar')"
            id="btnAprovar"
            class="px-4 py-2 bg-blue-50 text-blue-700 font-bold rounded-lg hover:bg-blue-100 text-sm"
          >
            Marcar Agendado
          </button>
          <button
            onclick="acaoPedido('concluir')"
            id="btnConcluir"
            class="px-4 py-2 bg-green-50 text-green-700 font-bold rounded-lg hover:bg-green-100 text-sm hidden"
          >
            Concluir
          </button>
        </div>
      </div>
    </div>

    <script>
      const ADMIN_TOKEN = localStorage.getItem("cabana_admin_token");
      if (!ADMIN_TOKEN) window.location.href = "painel.html";

      let todosPedidos = [];
      let tabelaPrecos = [];
      let listaCardapios = [];
      let listaAlimentos = [];
      let taxasSistema = []; // Lista de itens 'sistema'
      let pedidoAtual = null;

      // --- FUN√á√ÉO DE COPIAR WHATSAPP ---
      async function copiarWhatsApp(numero, btn) {
        if (!numero) return;
        try {
          await navigator.clipboard.writeText(numero);
          const iconeOriginal = btn.innerHTML;
          btn.innerHTML =
            '<i data-lucide="check" class="w-3.5 h-3.5 text-green-600"></i>';
          lucide.createIcons();
          setTimeout(() => {
            btn.innerHTML = iconeOriginal;
            lucide.createIcons();
          }, 2000);
        } catch (err) {
          console.error("Erro ao copiar", err);
          alert("Erro ao copiar o n√∫mero.");
        }
      }

      // --- 1. CARREGAMENTO GERAL ---
      async function carregarDados() {
        try {
          const [resPedidos, resPrecos, resCardapios, resAlimentos, resItens] =
            await Promise.all([
              fetch("/api/admin/pedidos", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/admin/precos", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/cardapios", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/alimentos", {
                headers: { "x-admin-password": ADMIN_TOKEN },
              }),
              fetch("/api/itens-disponiveis"), // Busca itens para os checkboxes (categoria sistema)
            ]);

          let pedidosBrutos = await resPedidos.json();
          tabelaPrecos = await resPrecos.json();
          listaCardapios = await resCardapios.json();
          listaAlimentos = await resAlimentos.json();

          // Separa as taxas de sistema
          const todosItens = await resItens.json();
          taxasSistema = todosItens.filter((i) => i.categoria === "sistema");

          // --- L√ìGICA DE DATA: +1 DIA = CONCLU√çDO AUTOMATICAMENTE ---
          const hoje = new Date();
          hoje.setHours(0, 0, 0, 0);

          pedidosBrutos.forEach(p => {
              if (p.data_festa) {
                  let dataFestaStr = p.data_festa;
                  if (dataFestaStr.includes('T')) dataFestaStr = dataFestaStr.split('T')[0];
                  const dataFesta = new Date(dataFestaStr + 'T00:00:00');
                  
                  const msPorDia = 1000 * 60 * 60 * 24;
                  const diasPassados = (hoje.getTime() - dataFesta.getTime()) / msPorDia;
                  
                  // Se j√° passou 1 dia e n√£o est√° cancelado, for√ßa visualmente como conclu√≠do
                  if (diasPassados >= 1 && p.status !== 'cancelado') {
                      p.status = 'concluido';
                      p.status_agenda = 'concluido';
                  }
              }
          });
          
          todosPedidos = pedidosBrutos;
          filtrar("todos");
        } catch (e) {
          console.error(e);
          alert("Erro de conex√£o.");
        }
      }

      function filtrar(status) {
        const grid = document.getElementById("gridPedidos");
        let filtrados = todosPedidos;

        if (status === "pendente")
          filtrados = todosPedidos.filter(
            (p) => p.status === "pendente" || !p.status,
          );
        if (status === "aprovado")
          filtrados = todosPedidos.filter(
            (p) => p.status === "aprovado" && p.status_agenda !== "concluido",
          );
        if (status === "concluido")
          filtrados = todosPedidos.filter(
            (p) => p.status_agenda === "concluido",
          );

        if (filtrados.length === 0) {
          grid.innerHTML =
            '<div class="col-span-full text-center py-20 text-slate-400">Nenhum pedido encontrado.</div>';
          return;
        }

        grid.innerHTML = filtrados
          .map((p) => {
            let dataFormatada = "Data n√£o informada";
            if(p.data_festa) {
               let dStr = p.data_festa.includes('T') ? p.data_festa.split('T')[0] : p.data_festa;
               dataFormatada = new Date(dStr + 'T00:00:00').toLocaleDateString("pt-BR");
            }
            
            let statusColor = "bg-yellow-100 text-yellow-700";
            let statusText = "Pendente";

            if (p.status === "aprovado") {
              statusColor = "bg-blue-100 text-blue-700";
              statusText = "Agendado";
            }
            if (p.status_agenda === "concluido") {
              statusColor = "bg-green-100 text-green-700";
              statusText = "Conclu√≠do";
            }
            // Indicador de Pagamento
            const iconMoney =
              p.status_pagamento === "pago"
                ? "check-circle"
                : p.status_pagamento === "parcial"
                  ? "pie-chart"
                  : "circle";
            const colorMoney =
              p.status_pagamento === "pago"
                ? "text-green-500"
                : p.status_pagamento === "parcial"
                  ? "text-orange-500"
                  : "text-slate-300";

            return `
                <div onclick="abrirDetalhes(${p.id})" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all cursor-pointer group relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">${p.nome}</h3>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">${dataFormatada} √†s ${p.horario || '-'}</p>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="${statusColor} px-3 py-1 rounded-full text-xs font-bold">${statusText}</span>
                            <i data-lucide="${iconMoney}" class="w-4 h-4 ${colorMoney}"></i>
                        </div>
                    </div>
                    <div class="space-y-1 text-sm text-slate-600 mb-4">
                        <p class="flex items-center gap-2"><i data-lucide="tent" class="w-4 h-4 text-pink-400"></i> ${p.modelo_barraca}</p>
                        <p class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-pink-400"></i> ${p.qtd_criancas || '-'} Crian√ßas</p>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-xs text-slate-400">Ver detalhes -></span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-pink-500 transition-colors"></i>
                    </div>
                </div>
            `;
          })
          .join("");
        lucide.createIcons();
      }

      // --- UTILIT√ÅRIOS ---
      function parseSeguro(dado) {
        if (!dado) return null;
        if (typeof dado === "object") return dado;
        try {
          return JSON.parse(dado);
        } catch (e) {
          return [dado];
        }
      }

      function normalizar(texto) {
        if (!texto) return "";
        return texto
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      }

      // --- ABRIR DETALHES ---
      function abrirDetalhes(id) {
        pedidoAtual = todosPedidos.find((p) => p.id === id);
        if (!pedidoAtual) return;

        const isPegueMonte = pedidoAtual.modelo_barraca === "PEGUE E MONTE";

        // Pega o bloco financeiro inteiro (pai do bot√£o m√°gico)
        const btnFluxo = document.getElementById("btnFluxo");
        const areaFinanceira = btnFluxo
          ? btnFluxo.closest(".bg-slate-50.border-t")
          : null;

        let dataFormatadaModal = "Data n√£o informada";
        if(pedidoAtual.data_festa) {
            let dStr = pedidoAtual.data_festa.includes('T') ? pedidoAtual.data_festa.split('T')[0] : pedidoAtual.data_festa;
            dataFormatadaModal = new Date(dStr + 'T00:00:00').toLocaleDateString("pt-BR");
        }

        if (isPegueMonte) {
          // 1. RENDERIZA√á√ÉO LIMPA (S√ì PEGUE E MONTE)
          if (areaFinanceira) areaFinanceira.style.display = "none"; // Esconde financeiro

          // Puxa o nome do pacote que n√≥s armazenamos na coluna "tema"
          const nomePacote = pedidoAtual.tema || "Pacote n√£o especificado";

          const html = `
            <div class="bg-blue-50 border border-blue-100 p-5 rounded-2xl mb-4 flex items-start gap-4">
                <div class="bg-blue-100 text-blue-600 p-3 rounded-full shrink-0">
                    <i data-lucide="package-open" class="w-6 h-6"></i>
                </div>
                <div>
                    <h4 class="font-bold text-blue-800 text-lg">Reserva Pegue e Monte</h4>
                    <p class="text-sm text-blue-600 mt-1">Este formato n√£o exige c√°lculo manual. O cliente pagou e recebeu os detalhes pelo site automaticamente.</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div class="space-y-3">
                    <h4 class="font-bold text-slate-800 text-base mb-2 border-b border-slate-100 pb-2">Dados do Cliente</h4>
                    <p><strong>Nome:</strong> ${pedidoAtual.nome}</p>
                    <div class="flex items-center gap-2">
                        <strong>WhatsApp:</strong> 
                        <a href="https://wa.me/55${pedidoAtual.whatsapp.replace(/\D/g, "")}" target="_blank" class="text-green-600 font-bold hover:underline">${pedidoAtual.whatsapp}</a>
                        <button onclick="copiarWhatsApp('${pedidoAtual.whatsapp}', this)" class="text-slate-400 hover:text-green-600 transition-colors p-1 bg-slate-100 rounded-md hover:bg-green-100" title="Copiar N√∫mero">
                            <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    <p><strong>E-mail:</strong> ${pedidoAtual.email || "N√£o informado"}</p>
                    <p><strong>Endere√ßo:</strong> ${pedidoAtual.endereco || "N√£o informado"}</p>
                </div>
                
                <div class="space-y-3">
                    <h4 class="font-bold text-slate-800 text-base mb-2 border-b border-slate-100 pb-2">Detalhes da Retirada</h4>
                    <p><strong>Pacote Escolhido:</strong> <span class="font-bold text-pink-600">${nomePacote}</span></p>
                    <p><strong>Data:</strong> ${dataFormatadaModal}</p>
                    <p><strong>Hor√°rio:</strong> ${pedidoAtual.horario || "N√£o informado"}</p>
                    <p><strong>Valor:</strong> <span class="font-bold text-green-600">R$ ${parseFloat(
                      pedidoAtual.valor_final || 0,
                    )
                      .toFixed(2)
                      .replace(".", ",")}</span></p>
                </div>
            </div>
        `;
          document.getElementById("conteudoModal").innerHTML = html;
        } else {
          // 2. RENDERIZA√á√ÉO COMPLETA (FESTAS NORMAIS)
          if (areaFinanceira) areaFinanceira.style.display = "block"; // Mostra financeiro

          let htmlAlimentacao =
            '<span class="text-slate-400 italic">Nenhuma.</span>';
          const alim = parseSeguro(pedidoAtual.alimentacao);

          if (alim) {
            if (Array.isArray(alim) && alim.length > 0) {
              htmlAlimentacao = `<ul class="list-disc pl-4 text-slate-600">${alim.map((i) => `<li>${i}</li>`).join("")}</ul>`;
            } else if (alim.combo || (alim.extras && alim.extras.length > 0)) {
              let partes = [];
              if (alim.combo) {
                const titulo = alim.combo.titulo || "Combo";
                partes.push(
                  `<div class="bg-pink-50 p-2 rounded mb-2 border border-pink-100"><span class="font-bold text-slate-700 block">${titulo}</span></div>`,
                );
              }
              if (alim.extras && alim.extras.length > 0) {
                partes.push(`<ul class="text-sm text-slate-600 space-y-1">`);
                alim.extras.forEach((e) => {
                  partes.push(`<li>${e.qtd}x ${e.nome}</li>`);
                });
                partes.push(`</ul>`);
              }
              htmlAlimentacao = partes.join("");
            }
          }

          const html = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-bold text-slate-800 mb-1">Cliente</h4>
                    <p><strong>Nome:</strong> ${pedidoAtual.nome}</p>
                    <div class="flex items-center gap-2 mt-1">
                        <strong>WhatsApp:</strong> 
                        <a href="https://wa.me/55${pedidoAtual.whatsapp.replace(/\D/g, "")}" target="_blank" class="text-green-600 font-bold hover:underline">${pedidoAtual.whatsapp}</a>
                        <button onclick="copiarWhatsApp('${pedidoAtual.whatsapp}', this)" class="text-slate-400 hover:text-green-600 transition-colors p-1 bg-slate-100 rounded-md hover:bg-green-100" title="Copiar N√∫mero">
                            <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    <p class="mt-1"><strong>Endere√ßo:</strong> ${pedidoAtual.endereco}</p>
                </div>
                <div>
                    <h4 class="font-bold text-slate-800 mb-1">Evento</h4>
                    <p><strong>Data:</strong> ${dataFormatadaModal}</p>
                    <p><strong>Hor√°rio:</strong> ${pedidoAtual.horario || '-'}</p>
                    <p><strong>Modelo:</strong> ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas}x)</p>
                </div>
            </div>
            <div class="border-t border-slate-100 pt-2 text-sm mt-2">
                 <p><strong>Alimenta√ß√£o:</strong></p>
                 ${htmlAlimentacao}
            </div>
            <div class="border-t border-slate-100 pt-2 text-sm grid grid-cols-2 gap-2">
                 <p><strong>Obs:</strong> ${pedidoAtual.itens_adicionais || "-"}</p>
                 <p><strong>Alergias:</strong> <span class="text-red-600 font-bold">${pedidoAtual.alergias || "-"}</span></p>
            </div>
        `;
          document.getElementById("conteudoModal").innerHTML = html;

          // --- L√ìGICA DE FINANCEIRO (S√ì RODA PARA FESTAS COMUNS) ---
          const divTaxas = document.getElementById("areaTaxasSistema");
          if (divTaxas) {
            divTaxas.innerHTML = "";
            if (taxasSistema.length > 0) {
              taxasSistema.forEach((taxa) => {
                const htmlId = `taxa_${taxa.id}`;
                const valorFormatado = parseFloat(taxa.valor).toLocaleString(
                  "pt-BR",
                  { style: "currency", currency: "BRL" },
                );
                const descSalva = (
                  pedidoAtual.descricao_itens_extras || ""
                ).toLowerCase();
                const isMarcado = descSalva.includes(
                  taxa.descricao.toLowerCase(),
                );

                divTaxas.innerHTML += `
                        <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-100">
                            <input type="checkbox" id="${htmlId}" value="${taxa.valor}" data-nome="${taxa.descricao}" 
                                   onchange="atualizarTotalVisual()" ${isMarcado ? "checked" : ""}
                                   class="w-4 h-4 text-pink-600 rounded border-gray-300 focus:ring-pink-500 cursor-pointer">
                            <label for="${htmlId}" class="text-sm text-slate-700 cursor-pointer select-none flex-1 flex justify-between">
                                <span>${taxa.descricao}</span>
                                <span class="text-xs font-bold text-slate-500">${valorFormatado}</span>
                            </label>
                        </div>
                    `;
              });
            } else {
              divTaxas.innerHTML =
                "<p class='text-xs text-slate-400 col-span-2'>Nenhuma taxa cadastrada.</p>";
            }

            const valorSalvoBase = parseFloat(pedidoAtual.valor_final) || 0;
            let valorSalvoExtraTotal =
              parseFloat(pedidoAtual.valor_itens_extras) || 0;
            let somaTaxasDetectadas = 0;
            divTaxas
              .querySelectorAll('input[type="checkbox"]')
              .forEach((cb) => {
                if (cb.checked) somaTaxasDetectadas += parseFloat(cb.value);
              });

            let valorManual = valorSalvoExtraTotal - somaTaxasDetectadas;
            if (valorManual < 0.01 && valorManual > -0.01) valorManual = 0;

            document.getElementById("fin_valor_final").value =
              valorSalvoBase.toFixed(2);
            document.getElementById("fin_valor_extras").value =
              valorManual.toFixed(2);
            document.getElementById("fin_desc_extras").value =
              pedidoAtual.descricao_itens_extras || "";
            atualizarTotalVisual();
          }

          if (btnFluxo) {
            btnFluxo.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i> <span>Salvar, Gerar Links e Copiar</span>`;
            btnFluxo.className =
              "w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]";
            btnFluxo.disabled = false;
          }
        }

        // --- CONTROLES DA BARRA INFERIOR (Aprovar / Concluir) ---
        const btnAprovar = document.getElementById("btnAprovar");
        const btnConcluir = document.getElementById("btnConcluir");
        const areaAviso = document.getElementById("areaAvisoModal");
        
        // Limpa aviso de conclus√£o
        areaAviso.innerHTML = "";

        if (pedidoAtual.status_agenda === "concluido") {
            btnAprovar.classList.add("hidden");
            btnConcluir.classList.add("hidden");
            
            // Exibe que a festa j√° foi realizada/conclu√≠da
            areaAviso.innerHTML = `<span class="text-green-600 font-bold bg-green-50 px-3 py-1.5 rounded-lg border border-green-100 flex items-center w-fit gap-1"><i data-lucide="check-circle" class="w-4 h-4"></i> Evento Conclu√≠do</span>`;
            
        } else if (pedidoAtual.status === "aprovado") {
            btnAprovar.classList.add("hidden");
            btnConcluir.classList.remove("hidden");
        } else {
            btnAprovar.classList.remove("hidden");
            btnConcluir.classList.add("hidden");
        }

        document.getElementById("modalDetalhes").classList.remove("hidden");
        lucide.createIcons();
      }
      
      function fecharModal() {
        document.getElementById("modalDetalhes").classList.add("hidden");
      }

      function atualizarTotalVisual() {
        const vFinal =
          parseFloat(document.getElementById("fin_valor_final").value) || 0;

        // 1. Soma Checkboxes
        let vTaxas = 0;
        const checkboxes = document.querySelectorAll(
          '#areaTaxasSistema input[type="checkbox"]:checked',
        );
        checkboxes.forEach((cb) => {
          vTaxas += parseFloat(cb.value);
        });

        // 2. Soma Manual
        const vManual =
          parseFloat(document.getElementById("fin_valor_extras").value) || 0;

        const totalGeral = vFinal + vTaxas + vManual;

        document.getElementById("displayTotal").innerText =
          totalGeral.toLocaleString("pt-BR", {
            style: "currency",
            currency: "BRL",
          });
        document.getElementById("displayResumo").innerText =
          `(Pacote: ${vFinal.toFixed(0)} + Taxas: ${vTaxas.toFixed(0)} + Extra: ${vManual.toFixed(0)})`;
      }

      function aplicarSugestaoCalculo() {
        if (!pedidoAtual) return;
        // Tenta achar pre√ßo pelo nome do modelo
        const itemHardware = tabelaPrecos.find(
          (t) => t.descricao === pedidoAtual.modelo_barraca,
        );
        if (itemHardware) {
          const valUnit = parseFloat(itemHardware.valor);
          const qtd = parseInt(pedidoAtual.qtd_barracas) || 0;
          const total = valUnit * qtd;
          document.getElementById("fin_valor_final").value = total.toFixed(2);
          atualizarTotalVisual();
          alert(`Valor Base Recalculado: ${qtd} x ${valUnit} = ${total}`);
        } else {
          alert("Modelo de barraca n√£o encontrado na tabela de pre√ßos.");
        }
      }

      // --- BOT√ÉO M√ÅGICO (FLUXO COMPLETO) ---
      async function executarFluxoCompleto() {
        if (!pedidoAtual) return;

        const btn = document.getElementById("btnFluxo");
        const conteudoOriginal = btn.innerHTML;

        btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Processando...`;
        btn.disabled = true;
        lucide.createIcons();

        try {
          const vFinal =
            parseFloat(document.getElementById("fin_valor_final").value) || 0;
          const vManual =
            parseFloat(document.getElementById("fin_valor_extras").value) || 0;

          // Calcula Taxas
          let vTaxas = 0;
          let nomesTaxas = [];
          const checkboxes = document.querySelectorAll(
            '#areaTaxasSistema input[type="checkbox"]:checked',
          );
          checkboxes.forEach((cb) => {
            vTaxas += parseFloat(cb.value);
            nomesTaxas.push(cb.getAttribute("data-nome"));
          });

          // Consolida Extras (Taxas + Manual)
          const vExtrasTotal = vTaxas + vManual;
          const vTotalGeral = vFinal + vExtrasTotal;

          if (vTotalGeral <= 0) throw new Error("Valor total inv√°lido.");

          // Monta Descri√ß√£o
          let descUsuario = document.getElementById("fin_desc_extras").value;
          let descFinal = descUsuario;
          if (nomesTaxas.length > 0) {
            const taxasString = nomesTaxas.join(", ");
            if (
              !descUsuario.toLowerCase().includes(nomesTaxas[0].toLowerCase())
            ) {
              descFinal = descUsuario
                ? `${taxasString} + ${descUsuario}`
                : taxasString;
            }
          }

          // 1. Salvar no Banco
          await fetch(`/api/admin/pedidos/${pedidoAtual.id}/financeiro`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": ADMIN_TOKEN,
            },
            body: JSON.stringify({
              valor_final: vFinal,
              valor_itens_extras: vExtrasTotal, // ENVIA A SOMA
              descricao_itens_extras: descFinal,
            }),
          });

          pedidoAtual.valor_final = vFinal;
          pedidoAtual.valor_itens_extras = vExtrasTotal;
          pedidoAtual.descricao_itens_extras = descFinal;

          // 2. Gerar Links
          const res = await fetch(
            `/api/admin/gerar-links-mp/${pedidoAtual.id}`,
            {
              method: "POST",
              headers: { "x-admin-password": ADMIN_TOKEN },
            },
          );

          const links = await res.json();
          if (!links.linkReserva || !links.linkIntegral)
            throw new Error("Erro ao gerar links.");

          // --- GERA√á√ÉO DO TEXTO ---
          const itensPadraoArr = parseSeguro(pedidoAtual.itens_padrao);
          const textoItens =
            Array.isArray(itensPadraoArr) && itensPadraoArr.length > 0
              ? itensPadraoArr.join(", ")
              : "Itens padr√£o do modelo";

          const alimObj = parseSeguro(pedidoAtual.alimentacao);
          let textoComida = "Nenhuma contratada";
          if (alimObj) {
            let partes = [];
            if (alimObj.combo)
              partes.push(`ü•™ *Pacote:* ${alimObj.combo.titulo || "Combo"}`);
            if (alimObj.extras && alimObj.extras.length > 0) {
              const lista = alimObj.extras
                .map((e) => `${e.qtd}x ${e.nome}`)
                .join(", ");
              partes.push(`‚ûï *Extras:* ${lista}`);
            }
            if (partes.length > 0) textoComida = partes.join("\n");
          }

          const textoExtras =
            vExtrasTotal !== 0
              ? `\nTaxas/Extras: R$ ${vExtrasTotal.toFixed(2).replace(".", ",")} (${descFinal})`
              : "";

          let dataFormatadaTexto = "Data n√£o informada";
          if(pedidoAtual.data_festa) {
             let dStr = pedidoAtual.data_festa.includes('T') ? pedidoAtual.data_festa.split('T')[0] : pedidoAtual.data_festa;
             dataFormatadaTexto = new Date(dStr + 'T00:00:00').toLocaleDateString("pt-BR");
          }

          const texto = `
Ol√°, ${pedidoAtual.nome}! ‚õ∫‚ú®
Aqui est√° o or√ßamento detalhado da sua *Cabana de Brincar*!

üóìÔ∏è *Sua Festa:*
Data: ${dataFormatadaTexto} √†s ${pedidoAtual.horario || '-'}
Endere√ßo: ${pedidoAtual.endereco}

üé™ *Estrutura:*
Modelo: ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas} unidades)
Participantes: ${pedidoAtual.qtd_criancas || '-'} crian√ßas
Tema: ${pedidoAtual.tema}

ü•£ *Alimenta√ß√£o:*
${textoComida}

üí∞ *Resumo Financeiro:*
Pacote Base: R$ ${vFinal.toFixed(2).replace(".", ",")}${textoExtras}
*Total Final:* R$ ${vTotalGeral.toFixed(2).replace(".", ",")}

---
*FORMAS DE PAGAMENTO:*
Voc√™ pode garantir sua data agora de duas formas:

1Ô∏è‚É£ **Sinal de Reserva (50%):**
Pague R$ ${links.reserva.replace(".", ",")} agora para reservar a data.
O restante (R$ ${links.restante.replace(".", ",")}) pode ser pago at√© o dia da festa.
üîó Link Sinal: ${links.linkReserva}
üîó Link Restante: ${links.linkRestante}

2Ô∏è‚É£ **Valor Total √† Vista (5% DE DESCONTO):**
Pague tudo agora com desconto e fique livre!
De: ~R$ ${vTotalGeral.toFixed(2).replace(".", ",")}~
Por: *R$ ${links.integral.replace(".", ",")}*
üîó Link Com Desconto: ${links.linkIntegral}
---

Fico no aguardo para confirmarmos! Qualquer d√∫vida √© s√≥ chamar. ü•∞
`.trim();

          await navigator.clipboard.writeText(texto);

          // Sucesso
          btn.className =
            "w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3";
          btn.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6"></i> <span>Sucesso! Copiado.</span>`;
          lucide.createIcons();

          setTimeout(() => {
            btn.className =
              "w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-3 transform hover:scale-[1.01]";
            btn.innerHTML = conteudoOriginal;
            btn.disabled = false;
            lucide.createIcons();
          }, 4000);
        } catch (e) {
          console.error(e);
          alert("Erro: " + e.message);
          btn.innerHTML = conteudoOriginal;
          btn.disabled = false;
          lucide.createIcons();
        }
      }

      async function acaoPedido(acao) {
        if (!pedidoAtual) return;
        if (!confirm(`Tem certeza que deseja ${acao} este pedido?`)) return;

        let url = "";
        let method = "PUT";

        if (acao === "aprovar")
          url = `/api/admin/agenda/aprovar/${pedidoAtual.id}`;
        if (acao === "concluir")
          url = `/api/admin/agenda/concluir/${pedidoAtual.id}`;
        if (acao === "excluir") {
          url = `/api/admin/pedidos/${pedidoAtual.id}`;
          method = "DELETE";
        }

        try {
          await fetch(url, {
            method: method,
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          fecharModal();
          carregarDados();
        } catch (e) {
          alert("Erro na a√ß√£o");
        }
      }

      carregarDados();
    </script>
  </body>
</html>