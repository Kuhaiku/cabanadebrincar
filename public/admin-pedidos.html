<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pedidos | Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap");
      body {
        font-family: "Quicksand", sans-serif;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
      <header class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-4">
          <a
            href="painel.html"
            class="p-2 bg-white rounded-xl hover:bg-slate-100 transition-colors"
            ><i data-lucide="arrow-left" class="text-slate-600"></i
          ></a>
          <h1 class="text-2xl font-bold text-slate-800">
            Pedidos & Or√ßamentos
          </h1>
        </div>
        <button
          onclick="carregarPedidos()"
          class="bg-white text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-100 flex items-center gap-2"
        >
          <i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualizar
        </button>
      </header>

      <div class="flex gap-4 mb-6 overflow-x-auto pb-2">
        <button
          onclick="filtrar('todos')"
          class="bg-white px-4 py-2 rounded-full text-sm font-bold text-slate-600 shadow-sm hover:shadow-md border border-slate-100"
        >
          Todos
        </button>
        <button
          onclick="filtrar('pendente')"
          class="bg-yellow-100 px-4 py-2 rounded-full text-sm font-bold text-yellow-700 hover:bg-yellow-200"
        >
          Pendentes
        </button>
        <button
          onclick="filtrar('aprovado')"
          class="bg-blue-100 px-4 py-2 rounded-full text-sm font-bold text-blue-700 hover:bg-blue-200"
        >
          Aprovados
        </button>
        <button
          onclick="filtrar('concluido')"
          class="bg-green-100 px-4 py-2 rounded-full text-sm font-bold text-green-700 hover:bg-green-200"
        >
          Conclu√≠dos
        </button>
      </div>

      <div
        id="gridPedidos"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <div class="col-span-full text-center py-20 text-slate-400">
          <i
            data-lucide="loader-2"
            class="w-8 h-8 animate-spin mx-auto mb-4"
          ></i>
          Carregando pedidos...
        </div>
      </div>
    </div>

    <div
      id="modalDetalhes"
      class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto"
      >
        <div
          class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10"
        >
          <h2 class="text-xl font-bold text-slate-800">Detalhes do Pedido</h2>
          <button
            onclick="fecharModal()"
            class="p-2 hover:bg-slate-100 rounded-full"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div id="conteudoModal" class="p-6 space-y-6"></div>

        <div class="p-6 bg-slate-50 border-t border-slate-200">
          <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
            <i data-lucide="dollar-sign" class="text-green-500 w-5 h-5"></i>
            Financeiro & Pagamento
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Valor Base (Pacote)</label
              >
              <input
                type="number"
                step="0.01"
                id="fin_valor_final"
                class="w-full p-2 rounded border border-slate-300"
                placeholder="0.00"
              />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Valor Extras (Frete/Adic.)</label
              >
              <input
                type="number"
                step="0.01"
                id="fin_valor_extras"
                class="w-full p-2 rounded border border-slate-300"
                placeholder="0.00"
              />
            </div>
            <div class="col-span-full">
              <label class="text-xs font-bold text-slate-500 uppercase"
                >Descri√ß√£o dos Extras</label
              >
              <input
                type="text"
                id="fin_desc_extras"
                class="w-full p-2 rounded border border-slate-300"
                placeholder="Ex: Frete + Lembrancinhas"
              />
            </div>
          </div>

          <div class="flex gap-2">
            <button
              onclick="salvarFinanceiroEGerarLinks()"
              class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg shadow-sm transition-all flex justify-center items-center gap-2"
            >
              <i data-lucide="link" class="w-4 h-4"></i> Salvar & Gerar Links
            </button>
            <button
              onclick="copiarResumo()"
              class="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-2 rounded-lg shadow-sm transition-all flex justify-center items-center gap-2"
            >
              <i data-lucide="copy" class="w-4 h-4"></i> Copiar Resumo
            </button>
          </div>

          <div
            id="areaLinks"
            class="hidden mt-4 bg-white p-3 rounded border border-green-200 text-sm space-y-2"
          >
            <p class="font-bold text-green-700">Links Gerados:</p>
            <div
              class="flex justify-between items-center bg-slate-50 p-2 rounded"
            >
              <span
                >Sinal (40%): <strong id="val_reserva">R$ 0,00</strong></span
              >
              <a
                id="link_reserva"
                href="#"
                target="_blank"
                class="text-blue-500 hover:underline"
                >Abrir</a
              >
            </div>
            <div
              class="flex justify-between items-center bg-slate-50 p-2 rounded"
            >
              <span
                >Restante (60%):
                <strong id="val_restante">R$ 0,00</strong></span
              >
              <a
                id="link_restante"
                href="#"
                target="_blank"
                class="text-blue-500 hover:underline"
                >Abrir</a
              >
            </div>
            <div
              class="flex justify-between items-center bg-slate-50 p-2 rounded"
            >
              <span
                >Total √† Vista (5% Off):
                <strong id="val_integral">R$ 0,00</strong></span
              >
              <a
                id="link_integral"
                href="#"
                target="_blank"
                class="text-blue-500 hover:underline"
                >Abrir</a
              >
            </div>
          </div>
        </div>

        <div
          class="p-6 border-t border-slate-100 flex gap-3 justify-end bg-white sticky bottom-0"
        >
          <button
            onclick="acaoPedido('excluir')"
            class="px-4 py-2 text-red-500 font-bold hover:bg-red-50 rounded-lg"
          >
            Excluir Pedido
          </button>
          <button
            onclick="acaoPedido('aprovar')"
            id="btnAprovar"
            class="px-6 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 shadow-lg shadow-blue-200"
          >
            Confirmar Agendamento
          </button>
          <button
            onclick="acaoPedido('concluir')"
            id="btnConcluir"
            class="px-6 py-2 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 shadow-lg shadow-green-200 hidden"
          >
            Concluir Festa
          </button>
        </div>
      </div>
    </div>

    <script>
      const ADMIN_TOKEN = localStorage.getItem("cabana_admin_token");
      if (!ADMIN_TOKEN) window.location.href = "painel.html";

      let todosPedidos = [];
      let pedidoAtual = null;

      // --- CARREGAMENTO ---
      async function carregarPedidos() {
        try {
          const res = await fetch("/api/admin/pedidos", {
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          todosPedidos = await res.json();
          filtrar("todos");
        } catch (e) {
          console.error(e);
          alert("Erro ao carregar pedidos");
        }
      }

      function filtrar(status) {
        const grid = document.getElementById("gridPedidos");
        let filtrados = todosPedidos;

        if (status === "pendente")
          filtrados = todosPedidos.filter(
            (p) => p.status === "pendente" || !p.status,
          );
        if (status === "aprovado")
          filtrados = todosPedidos.filter(
            (p) => p.status === "aprovado" && p.status_agenda !== "concluido",
          );
        if (status === "concluido")
          filtrados = todosPedidos.filter(
            (p) => p.status_agenda === "concluido",
          );

        if (filtrados.length === 0) {
          grid.innerHTML =
            '<div class="col-span-full text-center py-20 text-slate-400">Nenhum pedido encontrado.</div>';
          return;
        }

        grid.innerHTML = filtrados
          .map((p) => {
            const dataFesta = new Date(p.data_festa).toLocaleDateString(
              "pt-BR",
            );
            let statusColor = "bg-yellow-100 text-yellow-700";
            let statusText = "Pendente";
            if (p.status === "aprovado") {
              statusColor = "bg-blue-100 text-blue-700";
              statusText = "Agendado";
            }
            if (p.status_agenda === "concluido") {
              statusColor = "bg-green-100 text-green-700";
              statusText = "Conclu√≠do";
            }

            return `
                <div onclick="abrirDetalhes(${p.id})" class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 hover:shadow-lg transition-all cursor-pointer group relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">${p.nome}</h3>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">${dataFesta} √†s ${p.horario}</p>
                        </div>
                        <span class="${statusColor} px-3 py-1 rounded-full text-xs font-bold">${statusText}</span>
                    </div>
                    <div class="space-y-1 text-sm text-slate-600 mb-4">
                        <p class="flex items-center gap-2"><i data-lucide="tent" class="w-4 h-4 text-pink-400"></i> ${p.modelo_barraca}</p>
                        <p class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-pink-400"></i> ${p.qtd_criancas} Crian√ßas</p>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-xs text-slate-400">Ver detalhes -></span>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 group-hover:text-pink-500 transition-colors"></i>
                    </div>
                </div>
            `;
          })
          .join("");
        lucide.createIcons();
      }

      // --- PARSE SEGURO ---
      function parseSeguro(dado) {
        if (!dado) return null;
        if (typeof dado === "object") return dado;
        try {
          return JSON.parse(dado);
        } catch (e) {
          return [dado];
        } // Retorna como array de string se falhar
      }

      // --- DETALHES & L√ìGICA ---
      function abrirDetalhes(id) {
        pedidoAtual = todosPedidos.find((p) => p.id === id);
        if (!pedidoAtual) return;

        // 1. Parser Alimenta√ß√£o
        let htmlAlimentacao =
          '<span class="text-slate-400 italic">Nenhuma.</span>';
        const alim = parseSeguro(pedidoAtual.alimentacao);

        if (alim) {
          if (Array.isArray(alim)) {
            // Antigo
            if (alim.length > 0)
              htmlAlimentacao = `<ul class="list-disc pl-4 text-slate-600">${alim.map((i) => `<li>${i}</li>`).join("")}</ul>`;
          } else if (alim.combo || (alim.extras && alim.extras.length > 0)) {
            // Novo
            let partes = [];
            if (alim.combo) {
              partes.push(`
                            <div class="bg-pink-50 p-2 rounded mb-2 border border-pink-100">
                                <span class="font-bold text-slate-700 block">${alim.combo.titulo}</span>
                                <span class="text-xs text-slate-500">R$ ${parseFloat(alim.combo.valor_unitario).toFixed(2)} (${alim.combo.modo === "por_pessoa" ? "por pessoa" : "fixo"})</span>
                            </div>`);
            }
            if (alim.extras && alim.extras.length > 0) {
              partes.push(
                `<ul class="text-sm text-slate-600 space-y-1">${alim.extras.map((e) => `<li>${e.qtd}x ${e.nome}</li>`).join("")}</ul>`,
              );
            }
            htmlAlimentacao = partes.join("");
          }
        }

        // 2. Parser Itens
        let itensBarraca = "Padr√£o";
        const itensParseados = parseSeguro(pedidoAtual.itens_padrao);
        if (Array.isArray(itensParseados))
          itensBarraca = itensParseados.join(", ");
        else if (typeof itensParseados === "string")
          itensBarraca = itensParseados;

        // 3. Monta HTML
        const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1">Cliente</h4>
                        <p><strong>Nome:</strong> ${pedidoAtual.nome}</p>
                        <p><strong>WhatsApp:</strong> <a href="https://wa.me/55${pedidoAtual.whatsapp.replace(/\D/g, "")}" target="_blank" class="text-green-600 font-bold">${pedidoAtual.whatsapp}</a></p>
                        <p><strong>Endere√ßo:</strong> ${pedidoAtual.endereco}</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-800 mb-1">Evento</h4>
                        <p><strong>Data:</strong> ${new Date(pedidoAtual.data_festa).toLocaleDateString("pt-BR")}</p>
                        <p><strong>Hor√°rio:</strong> ${pedidoAtual.horario}</p>
                        <p><strong>Modelo:</strong> ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas}x)</p>
                    </div>
                </div>
                <div class="border-t border-slate-100 pt-2 text-sm">
                     <p><strong>Alimenta√ß√£o:</strong></p>
                     ${htmlAlimentacao}
                </div>
                <div class="border-t border-slate-100 pt-2 text-sm grid grid-cols-2 gap-2">
                     <p><strong>Obs:</strong> ${pedidoAtual.itens_adicionais || "-"}</p>
                     <p><strong>Alergias:</strong> <span class="text-red-600 font-bold">${pedidoAtual.alergias || "-"}</span></p>
                </div>
            `;
        document.getElementById("conteudoModal").innerHTML = html;

        // 4. Preenche Financeiro
        document.getElementById("fin_valor_final").value =
          pedidoAtual.valor_final || "";
        document.getElementById("fin_valor_extras").value =
          pedidoAtual.valor_itens_extras || "";
        document.getElementById("fin_desc_extras").value =
          pedidoAtual.descricao_itens_extras || "";
        document.getElementById("areaLinks").classList.add("hidden"); // Esconde links antigos ao abrir

        // 5. Bot√µes
        const btnAprovar = document.getElementById("btnAprovar");
        const btnConcluir = document.getElementById("btnConcluir");
        if (pedidoAtual.status === "pendente" || !pedidoAtual.status) {
          btnAprovar.classList.remove("hidden");
          btnConcluir.classList.add("hidden");
        } else if (
          pedidoAtual.status === "aprovado" &&
          pedidoAtual.status_agenda !== "concluido"
        ) {
          btnAprovar.classList.add("hidden");
          btnConcluir.classList.remove("hidden");
        } else {
          btnAprovar.classList.add("hidden");
          btnConcluir.classList.add("hidden");
        }

        document.getElementById("modalDetalhes").classList.remove("hidden");
        lucide.createIcons();
      }

      function fecharModal() {
        document.getElementById("modalDetalhes").classList.add("hidden");
      }

      // --- L√ìGICA FINANCEIRA (SALVAR E GERAR LINKS) ---
      async function salvarFinanceiroEGerarLinks() {
        if (!pedidoAtual) return;

        const vFinal =
          parseFloat(document.getElementById("fin_valor_final").value) || 0;
        const vExtras =
          parseFloat(document.getElementById("fin_valor_extras").value) || 0;
        const descExtras = document.getElementById("fin_desc_extras").value;
        const vTotal = vFinal + vExtras;

        if (vTotal <= 0) return alert("Insira um valor final v√°lido.");

        // 1. Salva no Banco (PUT)
        try {
          await fetch(`/api/admin/pedidos/${pedidoAtual.id}/financeiro`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "x-admin-password": ADMIN_TOKEN,
            },
            body: JSON.stringify({
              valor_final: vFinal, // Salva base
              valor_itens_extras: vExtras, // Salva extras
              descricao_itens_extras: descExtras,
            }),
          });

          // Atualiza objeto local
          pedidoAtual.valor_final = vFinal;
          pedidoAtual.valor_itens_extras = vExtras;
          pedidoAtual.descricao_itens_extras = descExtras;
        } catch (e) {
          return alert("Erro ao salvar dados financeiros.");
        }

        // 2. Gera Links MP (POST)
        // OBS: A rota do backend deve somar (valor_final + valor_itens_extras) para criar o link
        // Se sua rota antiga usa s√≥ 'valor_final', precisamos garantir que ela some l√° ou mandar o total aqui.
        // Vou assumir que a rota '/api/admin/gerar-links-mp/:id' l√™ do banco.
        // Como acabamos de atualizar o banco, ela deve ler correto.

        try {
          const res = await fetch(
            `/api/admin/gerar-links-mp/${pedidoAtual.id}`,
            {
              method: "POST",
              headers: { "x-admin-password": ADMIN_TOKEN },
            },
          );
          const links = await res.json();

          // Exibe
          document.getElementById("val_reserva").innerText =
            `R$ ${links.reserva}`;
          document.getElementById("link_reserva").href = links.linkReserva;

          document.getElementById("val_restante").innerText =
            `R$ ${links.restante}`;
          document.getElementById("link_restante").href = links.linkRestante;

          document.getElementById("val_integral").innerText =
            `R$ ${links.integral}`;
          document.getElementById("link_integral").href = links.linkIntegral;

          document.getElementById("areaLinks").classList.remove("hidden");
        } catch (e) {
          alert("Erro ao gerar links do Mercado Pago.");
        }
      }

      function copiarResumo() {
        if (!pedidoAtual) return;
        const vFinal =
          parseFloat(document.getElementById("fin_valor_final").value) || 0;
        const vExtras =
          parseFloat(document.getElementById("fin_valor_extras").value) || 0;
        const vTotal = vFinal + vExtras;

        // Pega links da tela (se gerados)
        const linkReserva = document.getElementById("link_reserva").href;
        const linkIntegral = document.getElementById("link_integral").href;

        if (linkReserva === "#" || linkReserva === "")
          return alert("Gere os links primeiro!");

        const texto = `
Ol√°, ${pedidoAtual.nome}! ‚õ∫
Aqui est√° o resumo do seu or√ßamento para a *Cabana de Brincar*:

üìÖ Data: ${new Date(pedidoAtual.data_festa).toLocaleDateString("pt-BR")}
‚è∞ Hor√°rio: ${pedidoAtual.horario}
‚õ∫ Modelo: ${pedidoAtual.modelo_barraca} (${pedidoAtual.qtd_barracas} barracas)
üë• Convidados: ${pedidoAtual.qtd_criancas} crian√ßas

üí∞ *Resumo Financeiro:*
Valor Pacote: R$ ${vFinal.toFixed(2)}
Extras/Frete: R$ ${vExtras.toFixed(2)}
*TOTAL: R$ ${vTotal.toFixed(2)}*

---
*Op√ß√µes de Pagamento:*

1Ô∏è‚É£ **Sinal de Reserva (40%):** R$ ${(vTotal * 0.4).toFixed(2)}
üîó Link: ${linkReserva}
_(O restante de R$ ${(vTotal * 0.6).toFixed(2)} deve ser pago at√© a data da festa)_

2Ô∏è‚É£ **√Ä Vista (5% de Desconto):** R$ ${(vTotal * 0.95).toFixed(2)}
üîó Link: ${linkIntegral}
---

Qualquer d√∫vida, √© s√≥ chamar! ‚ú®
`.trim();

        navigator.clipboard
          .writeText(texto)
          .then(() => alert("Resumo copiado para a √°rea de transfer√™ncia!"));
      }

      // --- A√á√ïES GERAIS ---
      async function acaoPedido(acao) {
        if (!pedidoAtual) return;
        if (!confirm(`Tem certeza que deseja ${acao} este pedido?`)) return;

        let url = "";
        let method = "PUT";

        if (acao === "aprovar")
          url = `/api/admin/agenda/aprovar/${pedidoAtual.id}`;
        if (acao === "concluir")
          url = `/api/admin/agenda/concluir/${pedidoAtual.id}`;
        if (acao === "excluir") {
          url = `/api/admin/pedidos/${pedidoAtual.id}`;
          method = "DELETE";
        }

        try {
          await fetch(url, {
            method: method,
            headers: { "x-admin-password": ADMIN_TOKEN },
          });
          fecharModal();
          carregarPedidos();
        } catch (e) {
          alert("Erro na a√ß√£o");
        }
      }

      carregarPedidos();
    </script>
  </body>
</html>
