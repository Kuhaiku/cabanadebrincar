<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cabana de Brincar | Festa do Pijama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Quicksand", sans-serif;
        background: linear-gradient(
          135deg,
          #fff0f5 0%,
          #ffffff 50%,
          #f0f7ff 100%
        );
        color: #1e293b;
      }

      /* Card Estilo Vidro */
      .glass-card-light {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid white;
        box-shadow: 0 10px 30px -10px rgba(236, 72, 153, 0.2);
      }

      /* Inputs Fofos */
      input,
      select,
      textarea {
        background-color: #ffffff !important;
        border: 2px solid #e2e8f0 !important;
        color: #334155 !important;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #ec4899 !important;
        box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.15);
      }

      /* Checkbox Rosa */
      .custom-checkbox:checked {
        background-color: #ec4899;
        border-color: #ec4899;
      }

      /* Anima√ß√µes */
      @keyframes popIn {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .animate-pop {
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .btn-hover:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px -5px rgba(236, 72, 153, 0.4);
      }
    </style>
  </head>
  <body class="min-h-screen pb-20 overflow-x-hidden">
    <div
      id="btn-historico"
      class="hidden fixed bottom-6 right-6 z-50 animate-pop"
    >
      <button
        onclick="abrirHistorico()"
        class="bg-white border-2 border-pink-200 text-pink-600 font-bold py-3 px-6 rounded-full shadow-2xl hover:bg-pink-50 transition-all flex items-center gap-2 transform hover:scale-105"
      >
        <i data-lucide="history" class="w-5 h-5"></i> Meus Pedidos
      </button>
    </div>

    <header class="py-12 px-4 text-center relative">
      <div
        class="absolute top-10 left-10 w-24 h-24 bg-pink-200 rounded-full blur-3xl opacity-50 animate-pulse"
      ></div>
      <div
        class="absolute bottom-10 right-10 w-32 h-32 bg-indigo-200 rounded-full blur-3xl opacity-50 animate-pulse"
      ></div>

      <div class="relative z-10">
        <h1
          class="text-5xl md:text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-600 mb-2 tracking-tight drop-shadow-sm"
        >
          Cabana de Brincar
        </h1>
        <p class="text-xl md:text-2xl text-slate-500 font-bold">
          ‚ú® Festa do Pijama dos Sonhos ‚ú®
        </p>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 space-y-16">
      <section class="relative w-full max-w-4xl mx-auto">
        <div
          class="relative h-[300px] md:h-[500px] w-full rounded-[2.5rem] overflow-hidden shadow-2xl shadow-indigo-100 border-[6px] border-white group"
        >
          <img
            id="carouselImage"
            src=""
            alt="Carregando fotos..."
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
          />

          <div
            class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent pointer-events-none"
          ></div>

          <button
            onclick="prevImage()"
            class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-indigo-600 p-3 rounded-full shadow-lg transition-all z-20 hover:scale-110 cursor-pointer border border-white"
          >
            <i data-lucide="chevron-left" class="w-6 h-6"></i>
          </button>

          <button
            onclick="nextImage()"
            class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-indigo-600 p-3 rounded-full shadow-lg transition-all z-20 hover:scale-110 cursor-pointer border border-white"
          >
            <i data-lucide="chevron-right" class="w-6 h-6"></i>
          </button>

          <div class="absolute bottom-6 left-0 right-0 text-center z-10">
            <span
              class="bg-white/20 backdrop-blur-md border border-white/40 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm"
            >
              üì∏ Galeria de Fotos
            </span>
          </div>
        </div>
      </section>

      <section
        class="glass-card-light rounded-[2.5rem] p-6 md:p-12 relative mx-auto max-w-4xl"
      >
        <div
          class="flex items-center gap-4 mb-8 border-b-2 border-pink-100 pb-6"
        >
          <div class="bg-pink-100 p-4 rounded-2xl text-pink-500 shadow-inner">
            <i data-lucide="sparkles" class="w-8 h-8"></i>
          </div>
          <div>
            <h2 class="text-3xl font-extrabold text-slate-700">
              Vamos Planejar?
            </h2>
            <p class="text-slate-400 font-medium">
              Preencha para receber um or√ßamento m√°gico
            </p>
          </div>
        </div>

        <form id="orcamentoForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Nome da Mam√£e/Papai</label
            >
            <input
              type="text"
              id="nome"
              required
              placeholder="Seu nome completo"
              class="w-full p-4 rounded-2xl"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >WhatsApp</label
            >
            <input
              type="tel"
              id="whatsapp"
              required
              placeholder="(00) 00000-0000"
              class="w-full p-4 rounded-2xl"
            />
          </div>

          <div class="md:col-span-2 space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Endere√ßo da Festa</label
            >
            <input
              type="text"
              id="endereco"
              placeholder="Rua, n√∫mero e bairro"
              class="w-full p-4 rounded-2xl"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Data da Festa</label
            >
            <input
              type="date"
              id="data_festa"
              class="w-full p-4 rounded-2xl text-slate-600"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1">Hor√°rio</label>
            <input
              type="time"
              id="horario"
              class="w-full p-4 rounded-2xl text-slate-600"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Quantas Crian√ßas?</label
            >
            <input
              type="number"
              min="1"
              id="qtd_criancas"
              class="w-full p-4 rounded-2xl"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Faixa Et√°ria</label
            >
            <input
              type="text"
              id="faixa_etaria"
              placeholder="Ex: 5 a 8 anos"
              class="w-full p-4 rounded-2xl"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Modelo da Barraca</label
            >
            <select
              id="modelo_barraca"
              class="w-full p-4 rounded-2xl cursor-pointer text-slate-600 bg-white"
            >
              <option value="">Selecione...</option>
              <option value="Tenda Festa do Pijama">
                Tenda de Festa do Pijama
              </option>
              <option value="Barraca de Indio">Barraca de √çndio</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Quantidade de Barracas</label
            >
            <input
              type="number"
              min="1"
              id="qtd_barracas"
              class="w-full p-4 rounded-2xl"
            />
          </div>

          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1">Cores</label>
            <input
              type="text"
              id="cores"
              placeholder="Ex: Rosa e Azul"
              class="w-full p-4 rounded-2xl"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1">Tema</label>
            <input
              type="text"
              id="tema"
              placeholder="Ex: Unic√≥rnio"
              class="w-full p-4 rounded-2xl"
            />
          </div>

          <div
            class="md:col-span-2 space-y-4 p-6 bg-indigo-50/80 rounded-3xl border-2 border-indigo-100 mt-4"
          >
            <span
              class="flex items-center gap-2 text-sm font-bold text-indigo-600 uppercase tracking-wider"
            >
              <i data-lucide="list-checks" class="w-5 h-5"></i> Itens
              Dispon√≠veis
            </span>
            <div class="flex flex-wrap gap-3" id="container-itens-padrao">
              <span class="text-slate-400 text-sm animate-pulse"
                >Carregando itens...</span
              >
            </div>
          </div>

          <div
            class="md:col-span-2 space-y-4 p-6 bg-pink-50/80 rounded-3xl border-2 border-pink-100"
          >
            <span
              class="flex items-center gap-2 text-sm font-bold text-pink-600 uppercase tracking-wider"
            >
              <i data-lucide="utensils" class="w-5 h-5"></i> Alimenta√ß√£o
            </span>
            <div class="flex flex-wrap gap-3" id="container-alimentacao">
              <span class="text-slate-400 text-sm animate-pulse"
                >Carregando menu...</span
              >
            </div>
          </div>

          <div class="md:col-span-2 space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Observa√ß√µes / Extras</label
            >
            <input
              type="text"
              id="itens_adicionais"
              placeholder="Quer adicionar algo especial?"
              class="w-full p-4 rounded-2xl"
            />
          </div>

          <div class="md:col-span-2 space-y-2">
            <label class="text-sm font-bold text-slate-600 ml-1"
              >Alergias / Restri√ß√µes</label
            >
            <textarea
              id="alergias"
              rows="2"
              placeholder="Alguma crian√ßa tem alergia?"
              class="w-full p-4 rounded-2xl"
            ></textarea>
          </div>

          <div class="md:col-span-2 pt-6">
            <button
              type="submit"
              class="btn-hover w-full bg-gradient-to-r from-pink-500 to-violet-600 hover:from-pink-600 hover:to-violet-700 text-white font-bold py-5 px-8 rounded-2xl flex items-center justify-center gap-3 text-xl shadow-xl shadow-pink-200"
            >
              <i data-lucide="send" class="w-6 h-6"></i>
              Revisar e Enviar
            </button>
          </div>
        </form>
      </section>
    </main>

    <div
      id="modal-revisao"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-[2rem] w-full max-w-lg p-8 relative shadow-2xl animate-pop border-4 border-white"
      >
        <div class="text-center mb-6">
          <div
            class="bg-pink-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-pink-500"
          >
            <i data-lucide="clipboard-check" class="w-8 h-8"></i>
          </div>
          <h3 class="text-2xl font-bold text-slate-800">Confira seu Pedido</h3>
          <p class="text-slate-500 text-sm">Tudo certo para a festa?</p>
        </div>

        <div
          id="revisao-conteudo"
          class="bg-slate-50 rounded-2xl p-6 border border-slate-100 text-sm text-slate-600 space-y-3 mb-6"
        ></div>

        <div class="flex gap-3">
          <button
            onclick="
              document.getElementById('modal-revisao').classList.add('hidden')
            "
            class="flex-1 py-3 rounded-xl border-2 border-slate-200 font-bold text-slate-500 hover:bg-slate-50 transition-colors"
          >
            Voltar
          </button>
          <button
            onclick="enviarRealmente()"
            id="btn-final-enviar"
            class="flex-[2] py-3 rounded-xl bg-green-500 hover:bg-green-600 text-white font-bold shadow-lg shadow-green-200 transition-all flex justify-center items-center gap-2"
          >
            Confirmar <i data-lucide="check" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>

    <div
      id="modal-sucesso"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-white/95 backdrop-blur-xl"
    >
      <div class="text-center animate-pop max-w-md p-6">
        <div
          class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm"
        >
          <i data-lucide="sparkles" class="w-12 h-12 text-green-500"></i>
        </div>
        <h2 class="text-4xl font-extrabold text-slate-800 mb-3">
          Pedido Enviado!
        </h2>
        <p class="text-lg text-slate-500 mb-8 font-medium">
          Recebemos sua solicita√ß√£o m√°gica. ‚ú®<br />Em breve entraremos em
          contato.
        </p>
        <button
          onclick="location.reload()"
          class="bg-indigo-600 text-white px-10 py-4 rounded-full font-bold hover:bg-indigo-700 transition-all shadow-xl hover:-translate-y-1"
        >
          Voltar ao In√≠cio
        </button>
      </div>
    </div>

    <div
      id="modal-historico"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
    >
      <div
        class="bg-white rounded-[2rem] w-full max-w-lg p-6 relative shadow-2xl animate-pop max-h-[80vh] overflow-y-auto"
      >
        <div
          class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"
        >
          <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="history" class="text-pink-500"></i> Meus Pedidos
          </h3>
          <button
            onclick="
              document.getElementById('modal-historico').classList.add('hidden')
            "
            class="bg-slate-100 p-2 rounded-full hover:bg-slate-200"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <div id="lista-historico" class="space-y-4"></div>
      </div>
    </div>

    <footer
      class="py-12 text-center text-slate-400 font-medium text-sm bg-white border-t border-slate-100 mt-20"
    >
      <p>&copy; 2023 Cabana de Brincar. Feito com amor.</p>
      <div class="flex justify-center gap-4 mt-4">
        <a
          href="https://www.instagram.com/cabanadebrincar_festadopijama/"
          target="_blank"
          class="bg-pink-50 p-3 rounded-full text-pink-500 hover:bg-pink-100 transition-colors"
          ><i data-lucide="instagram" class="w-5 h-5"></i
        ></a>
      </div>
    </footer>

    <script>
      lucide.createIcons();
      let formDataCache = null;

      document.addEventListener("DOMContentLoaded", () => {
        const hist = JSON.parse(
          localStorage.getItem("historicoPedidosCabana") || "[]",
        );
        if (hist.length > 0)
          document.getElementById("btn-historico").classList.remove("hidden");
        carregarItensDinamicos();
        loadPhotos();
      });

      // --- CARREGAR ITENS DO SERVIDOR ---
      async function carregarItensDinamicos() {
        try {
          const res = await fetch("/api/itens-disponiveis");
          const itens = await res.json();

          const cp = document.getElementById("container-itens-padrao");
          const ca = document.getElementById("container-alimentacao");
          cp.innerHTML = "";
          ca.innerHTML = "";

          if (itens.length === 0) {
            cp.innerHTML =
              '<span class="text-slate-400">Sem itens cadastrados.</span>';
          }

          itens.forEach((item) => {
            const html = `
                        <label class="flex items-center gap-3 bg-white px-4 py-3 rounded-xl border border-indigo-100 cursor-pointer hover:border-pink-300 transition-all group shadow-sm">
                            <div class="relative flex items-center">
                                <input type="checkbox" value="${item.descricao}" class="chk-${item.categoria === "alimentacao" ? "alim" : "item"} custom-checkbox w-6 h-6 rounded-lg border-2 border-slate-300 text-pink-500 focus:ring-pink-500 transition-all">
                            </div>
                            <span class="text-slate-600 font-bold group-hover:text-pink-600 transition-colors text-sm">${item.descricao}</span>
                        </label>`;

            if (item.categoria === "alimentacao") ca.innerHTML += html;
            else cp.innerHTML += html;
          });
        } catch (e) {
          console.error("Erro itens");
        }
      }

      // --- CARROSSEL ---
      let images = [];
      let imgIdx = 0;
      const imgEl = document.getElementById("carouselImage");
      async function loadPhotos() {
        try {
          const r = await fetch("/api/fotos");
          const d = await r.json();
          if (d.length > 0) {
            images = d;
            imgEl.src = images[0];
          } else
            imgEl.src =
              "https://images.unsplash.com/photo-1555580034-07760a2e19b2?q=80&w=1000";
        } catch (e) {
          console.error(e);
        }
      }
      function nextImage() {
        if (!images.length) return;
        imgIdx = (imgIdx + 1) % images.length;
        imgEl.src = images[imgIdx];
      }
      function prevImage() {
        if (!images.length) return;
        imgIdx = (imgIdx - 1 + images.length) % images.length;
        imgEl.src = images[imgIdx];
      }
      setInterval(nextImage, 5000);

      // --- FORMUL√ÅRIO E REVIS√ÉO ---
      document
        .getElementById("orcamentoForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const padrao = Array.from(
            document.querySelectorAll(".chk-item:checked"),
          ).map((el) => el.value);
          const alim = Array.from(
            document.querySelectorAll(".chk-alim:checked"),
          ).map((el) => el.value);

          formDataCache = {
            nome: document.getElementById("nome").value,
            whatsapp: document.getElementById("whatsapp").value,
            endereco: document.getElementById("endereco").value,
            qtd_criancas: document.getElementById("qtd_criancas").value,
            faixa_etaria: document.getElementById("faixa_etaria").value,
            modelo_barraca: document.getElementById("modelo_barraca").value,
            qtd_barracas: document.getElementById("qtd_barracas").value,
            cores: document.getElementById("cores").value,
            tema: document.getElementById("tema").value,
            itens_padrao: padrao,
            itens_adicionais: document.getElementById("itens_adicionais").value,
            data_festa: document.getElementById("data_festa").value,
            horario: document.getElementById("horario").value,
            alimentacao: alim,
            alergias: document.getElementById("alergias").value,
          };

          const dataFesta = formDataCache.data_festa
            ? new Date(formDataCache.data_festa).toLocaleDateString("pt-BR", {
                timeZone: "UTC",
              })
            : "-";

          document.getElementById("revisao-conteudo").innerHTML = `
                <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-3">
                    <div><span class="block text-xs font-bold text-slate-400 uppercase">Nome</span> ${formDataCache.nome}</div>
                    <div><span class="block text-xs font-bold text-slate-400 uppercase">WhatsApp</span> ${formDataCache.whatsapp}</div>
                </div>
                <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-3">
                    <div><span class="block text-xs font-bold text-slate-400 uppercase">Data Festa</span> ${dataFesta}</div>
                    <div><span class="block text-xs font-bold text-slate-400 uppercase">Hor√°rio</span> ${formDataCache.horario}</div>
                </div>
                <div class="py-2">
                    <p class="font-bold text-indigo-600 mb-1">${formDataCache.qtd_barracas}x ${formDataCache.modelo_barraca}</p>
                    <p class="text-xs text-slate-500">Itens: ${padrao.join(", ") || "Nenhum"}</p>
                    <p class="text-xs text-slate-500">Comida: ${alim.join(", ") || "Nenhuma"}</p>
                </div>`;

          document.getElementById("modal-revisao").classList.remove("hidden");
        });

      async function enviarRealmente() {
        const btn = document.getElementById("btn-final-enviar");
        btn.innerHTML =
          '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Enviando...';
        btn.disabled = true;
        lucide.createIcons();

        try {
          const res = await fetch("/api/orcamento", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formDataCache),
          });
          if (res.ok) {
            let hist = JSON.parse(
              localStorage.getItem("historicoPedidosCabana") || "[]",
            );
            hist.unshift({
              ...formDataCache,
              data_pedido_local: new Date().toISOString(),
            });
            localStorage.setItem(
              "historicoPedidosCabana",
              JSON.stringify(hist),
            );
            document.getElementById("modal-revisao").classList.add("hidden");
            document.getElementById("modal-sucesso").classList.remove("hidden");
          } else alert("Erro no servidor");
        } catch (e) {
          alert("Erro de conex√£o");
        } finally {
          btn.innerHTML = "Confirmar";
          btn.disabled = false;
        }
      }

      function abrirHistorico() {
        const hist = JSON.parse(
          localStorage.getItem("historicoPedidosCabana") || "[]",
        );
        const lista = document.getElementById("lista-historico");
        lista.innerHTML = "";

        if (hist.length === 0)
          lista.innerHTML =
            '<p class="text-center text-slate-400">Sem hist√≥rico.</p>';

        hist.forEach((p) => {
          const data = new Date(p.data_pedido_local).toLocaleDateString(
            "pt-BR",
          );
          const dataFesta = p.data_festa
            ? new Date(p.data_festa).toLocaleDateString("pt-BR", {
                timeZone: "UTC",
              })
            : "-";

          // Corre√ß√£o Arrays
          const itens = Array.isArray(p.itens_padrao) ? p.itens_padrao : [];
          const alim = Array.isArray(p.alimentacao) ? p.alimentacao : [];

          lista.innerHTML += `
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex justify-between mb-2 border-b border-slate-200 pb-2">
                            <span class="text-xs font-bold text-slate-400">PEDIDO: ${data.substring(0, 5)}</span>
                            <span class="text-xs font-bold text-indigo-500">FESTA: ${dataFesta}</span>
                        </div>
                        <p class="font-bold text-slate-700">${p.modelo_barraca}</p>
                        <p class="text-xs text-slate-500 mt-1">‚úÖ ${itens.join(", ") || "-"}</p>
                        <p class="text-xs text-slate-500">üçΩÔ∏è ${alim.join(", ") || "-"}</p>
                    </div>`;
        });
        document.getElementById("modal-historico").classList.remove("hidden");
      }
    </script>
  </body>
</html>
