<!doctype html>
<html lang="pt-br" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Cabana de Brincar | Monte Sua Festa</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Nunito", "sans-serif"],
              display: ["Fredoka", "sans-serif"],
            },
            colors: {
              brand: {
                pink: "#FF6B95",
                dark: "#2D2A4A",
                soft: "#FFF5F8",
                accent: "#FFD9E3",
                purple: "#8B5CF6",
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        -webkit-tap-highlight-color: transparent;
      }
      .clean-input {
        width: 100%;
        background-color: #f8fafc;
        border: 2px solid #f1f5f9;
        border-radius: 1rem;
        padding: 0.8rem 1rem;
        font-weight: 600;
        color: #475569;
        transition: all 0.2s;
        outline: none;
      }
      .clean-input:focus {
        background-color: #ffffff;
        border-color: #ff6b95;
        box-shadow: 0 0 0 4px rgba(255, 107, 149, 0.1);
      }
      .clean-input.error {
        border-color: #ef4444;
        background-color: #fff1f2;
        animation: shake 0.3s ease-in-out;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-2px);
        }
        75% {
          transform: translateX(2px);
        }
      }
      .custom-checkbox {
        appearance: none;
        background-color: #fff;
        border: 2px solid #cbd5e1;
        border-radius: 0.5rem;
        display: inline-block;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
      }
      .custom-checkbox:checked {
        background-color: #ff6b95;
        border-color: #ff6b95;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
      }
      .item-card:has(input:checked) {
        border-color: #ff6b95;
        background-color: #fff5f8;
      }
      @keyframes zoomIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-zoom {
        animation: zoomIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
    </style>
  </head>
  <body class="font-sans text-slate-600 bg-white antialiased pb-20">
    <header
      class="py-3 bg-white border-b border-slate-50 sticky top-0 z-[60] shadow-sm lg:shadow-none lg:static"
    >
      <div class="container mx-auto px-6 flex items-center justify-between">
        <a
          href="index.html"
          class="flex items-center gap-3 group hover:opacity-90 transition-opacity"
        >
          <img
            src="assets/logo.png"
            alt="Logo Cabana"
            class="h-10 w-auto object-contain group-hover:scale-105 transition-transform"
          />
          <div
            class="text-xl font-display font-bold text-brand-pink tracking-wide leading-tight"
          >
            Cabana<span class="text-brand-dark">.Brincar</span>
          </div>
        </a>
        <div class="flex items-center gap-4">
          <a
            href="index.html"
            class="flex items-center gap-2 bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-200 hover:text-brand-dark transition-colors"
          >
            <i data-lucide="arrow-left" class="w-4 h-4"></i
            ><span class="hidden sm:inline">Voltar</span>
          </a>
        </div>
      </div>
    </header>

    <main class="container mx-auto lg:px-4 lg:py-8">
      <form
        id="orcamentoForm"
        class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start"
        novalidate
      >
        <div
          id="visualizador-wrapper"
          class="lg:col-span-5 sticky top-[60px] lg:top-24 z-50 bg-white/95 backdrop-blur-xl lg:bg-transparent lg:backdrop-blur-none border-b border-slate-100 lg:border-0 shadow-sm lg:shadow-none transition-all duration-300"
        >
          <div
            onclick="abrirZoom()"
            class="relative mx-auto w-full p-2 lg:p-8 lg:bg-brand-soft lg:rounded-[2.5rem] lg:border lg:border-brand-accent/30 flex flex-col items-center justify-center cursor-zoom-in group select-none"
          >
            <div
              id="canvas-loader"
              class="absolute inset-0 flex items-center justify-center bg-white/50 z-10 hidden rounded-[2.5rem]"
            >
              <div class="flex flex-col items-center gap-2">
                <i
                  data-lucide="loader-2"
                  class="animate-spin text-brand-pink w-8 h-8"
                ></i>
                <span class="text-xs font-bold text-slate-500"
                  >Montando...</span
                >
              </div>
            </div>
            <canvas
              id="simuladorCanvas"
              width="1080"
              height="1080"
              class="h-48 sm:h-64 lg:h-[500px] w-auto object-contain drop-shadow-xl rounded-xl lg:rounded-2xl bg-white/50 lg:bg-white transition-transform group-hover:scale-[1.02] duration-500"
            ></canvas>
          </div>
          <p
            class="lg:hidden text-center text-[10px] text-slate-400 font-bold uppercase pb-3 tracking-wide pt-1"
          >
            üëÜ Sua cabana personalizada
          </p>
        </div>

        <div class="lg:col-span-7 space-y-8 px-4 lg:px-0 mt-2 lg:mt-0">
          <div class="text-center lg:text-left mb-4">
            <h1
              class="font-display text-2xl lg:text-4xl font-bold text-brand-dark"
            >
              Vamos Criar!
            </h1>
            <p class="text-slate-500 text-sm">
              Preencha os dados para montar sua festa dos sonhos.
            </p>
          </div>

          <section
            class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-20 h-20 bg-brand-soft rounded-bl-[2rem] -mr-4 -mt-4 z-0"
            ></div>
            <h2
              class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2 relative z-10"
            >
              <span
                class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200"
                >1</span
              >
              Escolha o Estilo
            </h2>
            <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block pl-1"
                  >Modelo da Barraca *</label
                >
                <div class="relative">
                  <select
                    id="modelo_barraca"
                    onchange="aoMudarModelo()"
                    class="clean-input appearance-none cursor-pointer bg-white"
                    required
                  >
                    <option value="">Selecione...</option>
                  </select>
                  <i
                    data-lucide="chevron-down"
                    class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"
                  ></i>
                </div>
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Tema Desejado *</label
                ><input
                  type="text"
                  id="tema"
                  placeholder="Ex: Harry Potter"
                  class="clean-input"
                  required
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Cores de Prefer√™ncia *</label
                ><input
                  type="text"
                  id="cores"
                  placeholder="Ex: Azul e Prata"
                  class="clean-input"
                  required
                />
              </div>
            </div>
          </section>

          <section
            class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-20 h-20 bg-brand-soft rounded-bl-[2rem] -mr-4 -mt-4 z-0"
            ></div>
            <h2
              class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2 relative z-10"
            >
              <span
                class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200"
                >2</span
              >
              Itens da Cabana
            </h2>
            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-3 relative z-10"
              id="container-personalizacao"
            >
              <span class="text-xs text-slate-300 italic"
                >Carregando itens...</span
              >
            </div>
          </section>

          <section
            class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-20 h-20 bg-brand-soft rounded-bl-[2rem] -mr-4 -mt-4 z-0"
            ></div>
            <h2
              class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2 relative z-10"
            >
              <span
                class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200"
                >3</span
              >
              Alimenta√ß√£o
            </h2>
            <div
              class="grid grid-cols-1 sm:grid-cols-2 gap-2 relative z-10"
              id="container-alimentacao"
            >
              <span class="text-xs text-slate-300 italic"
                >Carregando menu...</span
              >
            </div>
          </section>

          <section
            class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden"
          >
            <h2
              class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2"
            >
              <span
                class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200"
                >4</span
              >
              Dados Finais
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Nome Completo *</label
                >
                <input
                  type="text"
                  id="nome"
                  required
                  placeholder="Seu nome"
                  class="clean-input"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >WhatsApp *</label
                >
                <input
                  type="tel"
                  id="whatsapp"
                  required
                  placeholder="(DDD) 99999-9999"
                  class="clean-input"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-brand-pink uppercase mb-1 ml-1"
                  >E-mail *</label
                >
                <input
                  type="email"
                  id="email"
                  required
                  placeholder="Para confirma√ß√£o"
                  class="clean-input border-brand-pink/20 focus:border-brand-pink"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Endere√ßo da Festa *</label
                >
                <input
                  type="text"
                  id="endereco"
                  required
                  placeholder="Rua, N√∫mero e Bairro"
                  class="clean-input"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Data da Festa *</label
                >
                <input
                  type="date"
                  id="data_festa"
                  required
                  class="clean-input text-slate-600"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Hor√°rio *</label
                >
                <input
                  type="time"
                  id="horario"
                  required
                  class="clean-input text-slate-600"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Qtd. Pessoas *</label
                >
                <input
                  type="number"
                  id="qtd_criancas"
                  required
                  min="1"
                  placeholder="Ex: 3"
                  class="clean-input"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Faixa Et√°ria *</label
                >
                <input
                  type="text"
                  id="faixa_etaria"
                  required
                  placeholder="Ex: 10 anos"
                  class="clean-input"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Qtd. Barracas *</label
                >
                <input
                  type="number"
                  id="qtd_barracas"
                  required
                  min="1"
                  placeholder="Ex: 1"
                  class="clean-input"
                />
              </div>
            </div>
            <div class="space-y-4 mt-4">
              <div>
                <label
                  class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1"
                  >Observa√ß√µes / Extras *</label
                >
                <textarea
                  id="itens_adicionais"
                  rows="2"
                  class="clean-input resize-none"
                  placeholder="Quer adicionar algo especial?"
                  required
                ></textarea>
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold text-brand-pink uppercase mb-1 ml-1"
                  >Alergias / Restri√ß√µes *</label
                >
                <textarea
                  id="alergias"
                  rows="2"
                  class="clean-input resize-none border-brand-pink/30 bg-brand-soft/20"
                  placeholder="Caso n√£o tenha, escreva 'N√£o'"
                  required
                ></textarea>
              </div>
            </div>
          </section>

          <div class="pt-6 pb-24">
            <div
              id="aviso-erro"
              class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm font-bold text-center animate-pulse"
            >
              <i data-lucide="alert-triangle" class="inline w-4 h-4 mr-1"></i>
              Ops! Faltam preencher:
              <span id="campos-faltantes" class="font-normal"></span>
            </div>
            <button
              type="submit"
              id="btn-submit"
              class="w-full bg-brand-dark text-white font-display font-bold text-xl py-5 rounded-2xl shadow-xl shadow-slate-300 hover:bg-slate-800 hover:-translate-y-1 transition-all flex items-center justify-center gap-3 relative overflow-hidden group"
            >
              <span class="relative z-10 flex items-center gap-3">
                <i
                  data-lucide="send"
                  class="w-6 h-6 text-brand-pink group-hover:text-white transition-colors"
                ></i>
                Solicitar Or√ßamento Gr√°tis
              </span>
              <div
                class="absolute inset-0 bg-slate-700 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left z-0"
              ></div>
            </button>
            <p
              class="text-center text-xs text-slate-400 mt-4 flex items-center justify-center gap-1"
            >
              <i data-lucide="lock" class="w-3 h-3"></i> Seus dados est√£o 100%
              seguros.
            </p>
          </div>
        </div>
      </form>
    </main>

    <div
      id="modal-sucesso"
      class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-white/95 backdrop-blur-xl"
    >
      <div class="text-center max-w-sm animate-zoom">
        <div
          class="w-24 h-24 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm animate-bounce"
        >
          <i data-lucide="check" class="w-10 h-10"></i>
        </div>
        <h2 class="font-display text-3xl font-bold text-brand-dark mb-2">
          Pedido Enviado!
        </h2>
        <p class="text-slate-500 mb-8 leading-relaxed">
          Recebemos sua configura√ß√£o m√°gica.<br />Logo entraremos em contato.
        </p>
        <button
          onclick="location.reload()"
          class="bg-brand-pink text-white font-bold py-4 px-12 rounded-full shadow-xl hover:bg-pink-600 transition-colors"
        >
          Voltar ao In√≠cio
        </button>
      </div>
    </div>

    <div
      id="modal-zoom"
      class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-brand-dark/90 backdrop-blur-md p-4 transition-opacity duration-300"
      onclick="fecharZoom()"
    >
      <div
        class="relative max-w-4xl w-full transform transition-all scale-100"
        onclick="event.stopPropagation()"
      >
        <button
          onclick="fecharZoom()"
          class="absolute -top-12 right-0 text-white hover:text-brand-pink transition-colors p-2"
        >
          <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <img
          id="img-zoom-preview"
          src=""
          class="w-full h-auto max-h-[85vh] object-contain rounded-2xl shadow-2xl border-4 border-white/20 bg-white"
        />
        <p
          class="text-center text-white/50 text-sm mt-4 font-bold uppercase tracking-widest"
        >
          Sua Cabana Personalizada
        </p>
      </div>
    </div>

    <script>
      lucide.createIcons();
      const canvas = document.getElementById("simuladorCanvas");
      const ctx = canvas.getContext("2d");

      let ativosAtuais = [];
      let imagensCarregadas = {};

      async function carregarImagem(url) {
        if (imagensCarregadas[url]) return imagensCarregadas[url];
        return new Promise((resolve) => {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.src = url;
          img.onload = () => {
            imagensCarregadas[url] = img;
            resolve(img);
          };
          img.onerror = () => resolve(null);
        });
      }

      async function aoMudarModelo() {
        const select = document.getElementById("modelo_barraca");
        const modeloNome = select.value;
        if (!modeloNome) return;
        document.getElementById("canvas-loader").classList.remove("hidden");
        try {
          const res = await fetch(
            `/api/simulador/ativos/${encodeURIComponent(modeloNome)}`,
          );
          ativosAtuais = await res.json();
          const promises = ativosAtuais.map((a) =>
            carregarImagem(a.url_cloudinary),
          );
          await Promise.all(promises);
        } catch (e) {
          console.error("Erro ao carregar ativos:", e);
        } finally {
          document.getElementById("canvas-loader").classList.add("hidden");
          atualizarSimulador();
        }
      }

      // --- LOGICA IGUAL AO ADMIN (Base < Luz < Itens) ---
      async function atualizarSimulador() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (ativosAtuais.length === 0) return;

        // 1. Pega os IDs dos itens marcados
        const checkboxes = document.querySelectorAll(".chk-padrao:checked");
        // AQUI ESTAVA O ERRO NO SERVER: cb.dataset.id vinha vazio!
        const idsSelecionados = Array.from(checkboxes).map((cb) =>
          parseInt(cb.dataset.id),
        );

        // 2. Detecta se tem luz pelo nome do item
        const nomesSelecionados = Array.from(checkboxes).map((cb) =>
          cb.value.toLowerCase(),
        );
        const temLuz = nomesSelecionados.some(
          (n) => n.includes("luz") || n.includes("led") || n.includes("fio"),
        );

        let camadas = [];

        // Camada 0: Base
        const base = ativosAtuais.find((a) => a.categoria_ativo === "base");
        if (base) camadas.push(base);

        // Camada 1: Luz (Se detectada e existir imagem)
        if (temLuz) {
          const luz = ativosAtuais.find(
            (a) => a.categoria_ativo === "base_luz",
          );
          if (luz) camadas.push(luz);
        }

        // Camada 2: Itens (Almofadas, Mesas, etc)
        const itens = ativosAtuais.filter(
          (a) =>
            a.categoria_ativo === "item" && idsSelecionados.includes(a.item_id),
        );

        // Ordena pelo Z-Index do Painel
        itens.sort((a, b) => a.camada_z - b.camada_z);
        camadas = [...camadas, ...itens];

        // Desenha
        for (const c of camadas) {
          const img = await carregarImagem(c.url_cloudinary);
          if (img) ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
      }

      async function carregarDadosAPI() {
        try {
          const res = await fetch("/api/itens-disponiveis");
          const itens = await res.json();

          const selModelo = document.getElementById("modelo_barraca");
          const divPersonalizacao = document.getElementById(
            "container-personalizacao",
          );
          const divAlimentacao = document.getElementById(
            "container-alimentacao",
          );
          selModelo.innerHTML = '<option value="">Selecione...</option>';
          divPersonalizacao.innerHTML = "";
          divAlimentacao.innerHTML = "";

          const tendas = itens.filter((i) => i.categoria === "tendas");
          if (tendas.length > 0)
            tendas.forEach((t) => {
              const opt = document.createElement("option");
              opt.value = t.descricao;
              opt.textContent = t.descricao;
              selModelo.appendChild(opt);
            });

          itens
            .filter((i) => i.categoria === "padrao")
            .forEach((item) => {
              // AQUI O DATA-ID √â VITAL PARA O FUNCIONAMENTO
              divPersonalizacao.innerHTML += `
                    <label class="item-card flex items-center gap-3 cursor-pointer bg-slate-50 p-3 rounded-xl border border-slate-100 hover:border-brand-pink/30 transition-colors">
                        <input type="checkbox" value="${item.descricao}" data-id="${item.id}" checked onchange="atualizarSimulador()" class="chk-padrao custom-checkbox w-5 h-5 text-brand-pink">
                        <span class="text-sm font-bold text-slate-600">${item.descricao}</span>
                    </label>`;
            });

          itens
            .filter((i) => i.categoria === "alimentacao")
            .forEach((item) => {
              divAlimentacao.innerHTML += `<label class="item-card flex items-center gap-3 cursor-pointer bg-slate-50 p-3 rounded-xl border border-slate-100 hover:border-brand-pink/30 transition-colors"><input type="checkbox" value="${item.descricao}" class="chk-alim custom-checkbox w-5 h-5 text-brand-pink"><span class="text-sm font-bold text-slate-600">${item.descricao}</span></label>`;
            });

          if (selModelo.value) aoMudarModelo();
        } catch (e) {
          console.error("Erro API", e);
        }
      }

      function abrirZoom() {
        const modal = document.getElementById("modal-zoom");
        const img = document.getElementById("img-zoom-preview");
        img.src = canvas.toDataURL("image/png");
        modal.classList.remove("hidden");
        modal.classList.add("animate-fade-in");
        document.body.style.overflow = "hidden";
      }
      function fecharZoom() {
        document.getElementById("modal-zoom").classList.add("hidden");
        document.body.style.overflow = "";
      }
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") fecharZoom();
      });

      const camposObrigatorios = [
        { id: "modelo_barraca", nome: "Modelo" },
        { id: "tema", nome: "Tema" },
        { id: "cores", nome: "Cores" },
        { id: "nome", nome: "Nome" },
        { id: "whatsapp", nome: "WhatsApp" },
        { id: "email", nome: "E-mail" },
        { id: "endereco", nome: "Endere√ßo" },
        { id: "data_festa", nome: "Data" },
        { id: "horario", nome: "Hor√°rio" },
        { id: "qtd_criancas", nome: "Pessoas" },
        { id: "faixa_etaria", nome: "Idade" },
        { id: "qtd_barracas", nome: "Qtd" },
        { id: "itens_adicionais", nome: "Obs" },
        { id: "alergias", nome: "Alergias" },
      ];
      function validarTodoFormulario() {
        let faltantes = [];
        camposObrigatorios.forEach((campo) => {
          const el = document.getElementById(campo.id);
          if (!el.value.trim()) {
            faltantes.push(campo.nome);
            el.classList.add("error");
          } else {
            el.classList.remove("error");
          }
        });
        const aviso = document.getElementById("aviso-erro");
        if (faltantes.length > 0) {
          aviso.classList.remove("hidden");
          document.getElementById("campos-faltantes").innerText =
            faltantes.join(", ");
          return false;
        } else {
          aviso.classList.add("hidden");
          return true;
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        camposObrigatorios.forEach((campo) => {
          const el = document.getElementById(campo.id);
          if (el) {
            el.addEventListener("blur", () => {
              if (!el.value.trim()) el.classList.add("error");
            });
            el.addEventListener("input", () => {
              if (el.value.trim()) el.classList.remove("error");
            });
          }
        });
        carregarDadosAPI();
      });
      document
        .getElementById("orcamentoForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (!validarTodoFormulario()) {
            document
              .getElementById("aviso-erro")
              .scrollIntoView({ behavior: "smooth", block: "center" });
            return;
          }
          const btn = document.getElementById("btn-submit");
          const textoOriginal = btn.innerHTML;
          btn.innerHTML = "Enviando...";
          btn.disabled = true;
          const itensPadrao = [];
          document
            .querySelectorAll(".chk-padrao:checked")
            .forEach((el) => itensPadrao.push(el.value));
          const alimentacao = [];
          document
            .querySelectorAll(".chk-alim:checked")
            .forEach((el) => alimentacao.push(el.value));
          const formData = {
            nome: document.getElementById("nome").value,
            whatsapp: document.getElementById("whatsapp").value,
            email: document.getElementById("email").value,
            endereco: document.getElementById("endereco").value,
            qtd_criancas: document.getElementById("qtd_criancas").value,
            faixa_etaria: document.getElementById("faixa_etaria").value,
            modelo_barraca: document.getElementById("modelo_barraca").value,
            qtd_barracas: document.getElementById("qtd_barracas").value,
            cores: document.getElementById("cores").value,
            tema: document.getElementById("tema").value,
            itens_padrao: itensPadrao,
            itens_adicionais: document.getElementById("itens_adicionais").value,
            data_festa: document.getElementById("data_festa").value,
            horario: document.getElementById("horario").value,
            alimentacao: alimentacao,
            alergias: document.getElementById("alergias").value,
          };
          try {
            const res = await fetch("/api/orcamento", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });
            if (res.ok) {
              document
                .getElementById("modal-sucesso")
                .classList.remove("hidden");
            } else {
              alert("Erro ao enviar.");
              btn.disabled = false;
              btn.innerHTML = textoOriginal;
            }
          } catch (err) {
            alert("Erro de conex√£o.");
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
          }
        });
    </script>
  </body>
</html>
