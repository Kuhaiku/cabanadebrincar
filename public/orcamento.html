<!doctype html>
<html lang="pt-br" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Cabana de Brincar | Monte Sua Festa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Nunito', 'sans-serif'],
              display: ['Fredoka', 'sans-serif'],
            },
            colors: {
              brand: {
                pink: '#FF6B95',
                dark: '#2D2A4A',
                soft: '#FFF5F8',
                accent: '#FFD9E3',
                purple: '#8B5CF6'
              }
            }
          }
        }
      }
    </script>
    <style>
      body { -webkit-tap-highlight-color: transparent; }
      
      .clean-input {
        width: 100%; background-color: #F8FAFC; border: 2px solid #F1F5F9; border-radius: 1rem; padding: 0.8rem 1rem; font-weight: 600; color: #475569; transition: all 0.2s; outline: none;
      }
      .clean-input:focus { background-color: #FFFFFF; border-color: #FF6B95; box-shadow: 0 0 0 4px rgba(255, 107, 149, 0.1); }
      
      /* Estilo Suave de Erro */
      .clean-input.error { 
          border-color: #ef4444; 
          background-color: #fff1f2; 
          animation: shake 0.3s ease-in-out;
      }

      @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-2px); }
          75% { transform: translateX(2px); }
      }

      .custom-checkbox {
        appearance: none; background-color: #fff; border: 2px solid #cbd5e1; border-radius: 0.5rem; display: inline-block; position: relative; cursor: pointer; transition: all 0.2s;
      }
      .custom-checkbox:checked {
        background-color: #FF6B95; border-color: #FF6B95; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
      }
      .item-card:has(input:checked) { border-color: #FF6B95; background-color: #FFF5F8; }
      
      @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
      .animate-zoom { animation: zoomIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
  </head>
  <body class="font-sans text-slate-600 bg-white antialiased pb-20">

    <header class="py-3 bg-white border-b border-slate-50 sticky top-0 z-[60] shadow-sm lg:shadow-none lg:static">
      <div class="container mx-auto px-6 flex items-center justify-between">
         <a href="index.html" class="flex items-center gap-3 group hover:opacity-90 transition-opacity">
            <img src="assets/logo.png" alt="Logo Cabana" class="h-10 w-auto object-contain group-hover:scale-105 transition-transform">
            <div class="text-xl font-display font-bold text-brand-pink tracking-wide leading-tight">
               Cabana<span class="text-brand-dark">.Brincar</span>
            </div>
         </a>
         <div class="flex items-center gap-4">
             <a href="index.html" class="flex items-center gap-2 bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-slate-200 hover:text-brand-dark transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i><span class="hidden sm:inline">Voltar</span>
             </a>
         </div>
      </div>
    </header>

    <main class="container mx-auto lg:px-4 lg:py-8">
      <form id="orcamentoForm" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start" novalidate>
        
        <div id="visualizador-wrapper" class="lg:col-span-5 sticky top-[60px] lg:top-24 z-50 bg-white/95 backdrop-blur-xl lg:bg-transparent lg:backdrop-blur-none border-b border-slate-100 lg:border-0 shadow-sm lg:shadow-none transition-all duration-300">
            <div onclick="abrirZoom()" class="relative mx-auto w-full p-2 lg:p-8 lg:bg-brand-soft lg:rounded-[2.5rem] lg:border lg:border-brand-accent/30 flex flex-col items-center justify-center cursor-zoom-in group select-none">
                <canvas id="simuladorCanvas" width="1080" height="1080" class="h-48 sm:h-64 lg:h-[500px] w-auto object-contain drop-shadow-xl rounded-xl lg:rounded-2xl bg-white/50 lg:bg-white transition-transform group-hover:scale-[1.02] duration-500"></canvas>
            </div>
            <p class="lg:hidden text-center text-[10px] text-slate-400 font-bold uppercase pb-3 tracking-wide pt-1">üëÜ Sua cabana personalizada</p>
        </div>

        <div class="lg:col-span-7 space-y-8 px-4 lg:px-0 mt-2 lg:mt-0">
            
            <div class="text-center lg:text-left mb-4">
                <h1 class="font-display text-2xl lg:text-4xl font-bold text-brand-dark">Vamos Criar!</h1>
                <p class="text-slate-500 text-sm">Preencha os dados para montar sua festa dos sonhos.</p>
            </div>

            <section class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-brand-soft rounded-bl-[2rem] -mr-4 -mt-4 z-0"></div>
                <h2 class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2 relative z-10">
                    <span class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200">1</span> Escolha o Estilo
                </h2>
                <div class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block pl-1">Modelo da Barraca *</label>
                        <div class="relative">
                            <select id="modelo_barraca" onchange="atualizarSimulador()" class="clean-input appearance-none cursor-pointer bg-white" required>
                                <option value="">Selecione...</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Tema Desejado *</label><input type="text" id="tema" placeholder="Ex: Harry Potter" class="clean-input" required></div>
                    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Cores de Prefer√™ncia *</label><input type="text" id="cores" placeholder="Ex: Azul e Prata" class="clean-input" required></div>
                </div>
            </section>

            <section class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-brand-soft rounded-bl-[2rem] -mr-4 -mt-4 z-0"></div>
                <h2 class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2 relative z-10">
                    <span class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200">2</span> Itens da Cabana
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 relative z-10" id="container-personalizacao"><span class="text-xs text-slate-300 italic">Carregando itens...</span></div>
            </section>

            <section class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-brand-soft rounded-bl-[2rem] -mr-4 -mt-4 z-0"></div>
                <h2 class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2 relative z-10">
                    <span class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200">3</span> Alimenta√ß√£o
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 relative z-10" id="container-alimentacao"><span class="text-xs text-slate-300 italic">Carregando menu...</span></div>
            </section>

            <section class="bg-white p-5 lg:p-8 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
                <h2 class="font-display text-lg font-bold text-brand-dark mb-4 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-full bg-brand-pink text-white flex items-center justify-center text-xs shadow-md shadow-pink-200">4</span> Dados Finais
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nome Completo *</label>
                        <input type="text" id="nome" required placeholder="Seu nome" class="clean-input">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">WhatsApp *</label>
                        <input type="tel" id="whatsapp" required placeholder="(DDD) 99999-9999" class="clean-input">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-brand-pink uppercase mb-1 ml-1">E-mail *</label>
                        <input type="email" id="email" required placeholder="Para confirma√ß√£o" class="clean-input border-brand-pink/20 focus:border-brand-pink">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Endere√ßo da Festa *</label>
                        <input type="text" id="endereco" required placeholder="Rua, N√∫mero e Bairro" class="clean-input">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Data da Festa *</label>
                        <input type="date" id="data_festa" required class="clean-input text-slate-600">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Hor√°rio *</label>
                        <input type="time" id="horario" required class="clean-input text-slate-600">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Qtd. Pessoas *</label>
                        <input type="number" id="qtd_criancas" required min="1" placeholder="Ex: 3" class="clean-input">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Faixa Et√°ria *</label>
                        <input type="text" id="faixa_etaria" required placeholder="Ex: 10 anos" class="clean-input">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Qtd. Barracas *</label>
                        <input type="number" id="qtd_barracas" required min="1" placeholder="Ex: 1" class="clean-input">
                    </div>
                </div>

                <div class="space-y-4 mt-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Observa√ß√µes / Extras *</label>
                        <textarea id="itens_adicionais" rows="2" class="clean-input resize-none" placeholder="Quer adicionar algo especial?" required></textarea>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-brand-pink uppercase mb-1 ml-1">Alergias / Restri√ß√µes *</label>
                        <textarea id="alergias" rows="2" class="clean-input resize-none border-brand-pink/30 bg-brand-soft/20" placeholder="Caso n√£o tenha, escreva 'N√£o'" required></textarea>
                    </div>
                </div>
            </section>

            <div class="pt-6 pb-24">
                <div id="aviso-erro" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm font-bold text-center animate-pulse">
                    <i data-lucide="alert-triangle" class="inline w-4 h-4 mr-1"></i>
                    Ops! Faltam preencher: <span id="campos-faltantes" class="font-normal"></span>
                </div>

                <button type="submit" id="btn-submit" class="w-full bg-brand-dark text-white font-display font-bold text-xl py-5 rounded-2xl shadow-xl shadow-slate-300 hover:bg-slate-800 hover:-translate-y-1 transition-all flex items-center justify-center gap-3 relative overflow-hidden group">
                    <span class="relative z-10 flex items-center gap-3">
                        <i data-lucide="send" class="w-6 h-6 text-brand-pink group-hover:text-white transition-colors"></i> Solicitar Or√ßamento Gr√°tis
                    </span>
                    <div class="absolute inset-0 bg-slate-700 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left z-0"></div>
                </button>
                
                <p class="text-center text-xs text-slate-400 mt-4 flex items-center justify-center gap-1">
                    <i data-lucide="lock" class="w-3 h-3"></i> Seus dados est√£o 100% seguros.
                </p>
            </div>
        </div>
      </form>
    </main>

    <div id="modal-sucesso" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-white/95 backdrop-blur-xl">
        <div class="text-center max-w-sm animate-zoom">
            <div class="w-24 h-24 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm animate-bounce">
                <i data-lucide="check" class="w-10 h-10"></i>
            </div>
            <h2 class="font-display text-3xl font-bold text-brand-dark mb-2">Pedido Enviado!</h2>
            <p class="text-slate-500 mb-8 leading-relaxed">Recebemos sua configura√ß√£o m√°gica.<br>Logo entraremos em contato.</p>
            <button onclick="location.reload()" class="bg-brand-pink text-white font-bold py-4 px-12 rounded-full shadow-xl hover:bg-pink-600 transition-colors">Voltar ao In√≠cio</button>
        </div>
    </div>

    <script>
      lucide.createIcons();
      const canvas = document.getElementById("simuladorCanvas");
      const ctx = canvas.getContext("2d");
      const mapaVisualizacao = { "Mesa de Caf√©": "mesa", "Kit Almofadas": "almofadas", "Colchonete": "colchonete", "Luzinhas LED": "luz" };

      // --- CONFIGURA√á√ÉO DE CAMPOS OBRIGAT√ìRIOS ---
      // Todos os campos que n√£o podem ficar vazios
      const camposObrigatorios = [
          { id: 'modelo_barraca', nome: 'Modelo da Barraca' },
          { id: 'tema', nome: 'Tema' },
          { id: 'cores', nome: 'Cores' },
          { id: 'nome', nome: 'Nome Completo' },
          { id: 'whatsapp', nome: 'WhatsApp' },
          { id: 'email', nome: 'E-mail' },
          { id: 'endereco', nome: 'Endere√ßo' },
          { id: 'data_festa', nome: 'Data' },
          { id: 'horario', nome: 'Hor√°rio' },
          { id: 'qtd_criancas', nome: 'Qtd. Pessoas' },
          { id: 'faixa_etaria', nome: 'Faixa Et√°ria' },
          { id: 'qtd_barracas', nome: 'Qtd. Barracas' },
          { id: 'itens_adicionais', nome: 'Observa√ß√µes' },
          { id: 'alergias', nome: 'Alergias' }
      ];

      // --- L√ìGICA DE VALIDA√á√ÉO INTELIGENTE ---
      
      // 1. Valida um campo espec√≠fico (chamado quando sai do campo ou digita)
      function validarCampo(input) {
          if (!input.value.trim()) {
              // S√≥ mostra erro se for evento de 'blur' (sair do campo)
              // Se estiver digitando (input), n√£o adiciona erro, mas se j√° tiver, mant√©m
              return false;
          } else {
              // Se preencheu, remove o erro imediatamente
              input.classList.remove('error');
              return true;
          }
      }

      // 2. Valida TUDO (chamado ao clicar em Enviar)
      function validarTodoFormulario() {
          let faltantes = [];
          
          camposObrigatorios.forEach(campo => {
              const el = document.getElementById(campo.id);
              if (!el.value.trim()) {
                  faltantes.push(campo.nome);
                  el.classList.add('error'); // Marca vermelho
              } else {
                  el.classList.remove('error');
              }
          });

          const aviso = document.getElementById('aviso-erro');
          const spanCampos = document.getElementById('campos-faltantes');

          if (faltantes.length > 0) {
              aviso.classList.remove('hidden');
              spanCampos.innerText = faltantes.join(', ');
              return false; // Formul√°rio inv√°lido
          } else {
              aviso.classList.add('hidden');
              return true; // Tudo certo
          }
      }

      // --- EVENT LISTENER (UX) ---
      document.addEventListener("DOMContentLoaded", () => {
          camposObrigatorios.forEach(campo => {
              const el = document.getElementById(campo.id);
              if(el) {
                  // Quando sai do campo: Se estiver vazio, marca erro (sutil)
                  el.addEventListener('blur', () => {
                      if(!el.value.trim()) el.classList.add('error');
                  });

                  // Enquanto digita: Remove o erro assim que come√ßar a escrever
                  el.addEventListener('input', () => {
                      if(el.value.trim()) el.classList.remove('error');
                  });
              }
          });
      });

      // --- ENVIO DO FORMUL√ÅRIO ---
      document.getElementById("orcamentoForm").addEventListener("submit", async (e) => {
          e.preventDefault(); // SEMPRE PREVINE O RELOAD
          
          // Verifica tudo antes de prosseguir
          if (!validarTodoFormulario()) {
              // Se falhar, rola at√© o aviso de erro
              document.getElementById('aviso-erro').scrollIntoView({ behavior: 'smooth', block: 'center' });
              return; 
          }

          const btn = document.getElementById('btn-submit');
          const textoOriginal = btn.innerHTML;
          btn.innerHTML = "Enviando..."; btn.disabled = true;

          const itensPadrao = []; document.querySelectorAll('.chk-padrao:checked').forEach(el => itensPadrao.push(el.value));
          const alimentacao = []; document.querySelectorAll('.chk-alim:checked').forEach(el => alimentacao.push(el.value));

          const formData = {
              nome: document.getElementById('nome').value,
              whatsapp: document.getElementById('whatsapp').value,
              email: document.getElementById('email').value,
              endereco: document.getElementById('endereco').value,
              qtd_criancas: document.getElementById('qtd_criancas').value,
              faixa_etaria: document.getElementById('faixa_etaria').value,
              modelo_barraca: document.getElementById('modelo_barraca').value,
              qtd_barracas: document.getElementById('qtd_barracas').value,
              cores: document.getElementById('cores').value,
              tema: document.getElementById('tema').value,
              itens_padrao: itensPadrao,
              itens_adicionais: document.getElementById('itens_adicionais').value,
              data_festa: document.getElementById('data_festa').value,
              horario: document.getElementById('horario').value,
              alimentacao: alimentacao,
              alergias: document.getElementById('alergias').value
          };

          try {
              const res = await fetch("/api/orcamento", {
                  method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(formData)
              });
              if(res.ok) {
                  document.getElementById("modal-sucesso").classList.remove("hidden");
              } else {
                  alert("Erro no servidor ao enviar pedido.");
                  btn.disabled = false;
                  btn.innerHTML = textoOriginal;
              }
          } catch(err) { 
              alert("Erro de conex√£o. Verifique sua internet.");
              btn.disabled = false;
              btn.innerHTML = textoOriginal;
          }
      });

      // --- SIMULADOR E API ---
      function obterSufixoArquivo(nomeSelect) {
          if (!nomeSelect) return 'indio';
          const nome = nomeSelect.toLowerCase();
          if (nome.includes('pijama') || nome.includes('tenda')) return 'pijama';
          if (nome.includes('indio') || nome.includes('tipi')) return 'indio';
          return 'indio';
      }
      function getAssetPath(modeloNome, item, estado) {
         const tipo = obterSufixoArquivo(modeloNome); 
         if (item === 'base') return estado === 'com_luz' ? `/assets/base_${tipo}_luz.png` : `/assets/base_${tipo}.png`;
         return `/assets/item_${item}_${tipo}.png`;
      }
      function carregarImagem(src) {
          return new Promise((resolve) => {
              const img = new Image(); img.src = src;
              img.onload = () => resolve(img); img.onerror = () => resolve(null);
          });
      }
      async function atualizarSimulador() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const checkedValues = Array.from(document.querySelectorAll('#container-personalizacao input:checked')).map(input => input.value);
          const chavesAtivas = checkedValues.map(val => mapaVisualizacao[val]).filter(v => v);
          const selectModelo = document.getElementById('modelo_barraca');
          const modeloNome = selectModelo.options[selectModelo.selectedIndex]?.text || '';
          const camadas = [];
          camadas.push(getAssetPath(modeloNome, 'base', chavesAtivas.includes('luz') ? 'com_luz' : 'sem_luz'));
          if(chavesAtivas.includes('colchonete')) camadas.push(getAssetPath(modeloNome, 'colchonete'));
          if(chavesAtivas.includes('almofadas')) camadas.push(getAssetPath(modeloNome, 'almofadas'));
          if(chavesAtivas.includes('mesa')) camadas.push(getAssetPath(modeloNome, 'mesa'));
          const imagens = await Promise.all(camadas.map(src => carregarImagem(src)));
          imagens.forEach(img => { if(img) ctx.drawImage(img, 0, 0, 1080, 1080); });
      }

      async function carregarDadosAPI() {
          try {
              const res = await fetch("/api/itens-disponiveis");
              const itens = await res.json();
              const selModelo = document.getElementById("modelo_barraca");
              const divPersonalizacao = document.getElementById("container-personalizacao");
              const divAlimentacao = document.getElementById("container-alimentacao");
              selModelo.innerHTML = '<option value="">Selecione...</option>'; 
              divPersonalizacao.innerHTML = ''; divAlimentacao.innerHTML = '';
              
              const tendas = itens.filter(i => i.categoria === 'tendas');
              if(tendas.length > 0) tendas.forEach(t => { const opt = document.createElement("option"); opt.value = t.descricao; opt.textContent = t.descricao; selModelo.appendChild(opt); });
              else selModelo.innerHTML += '<option value="Cabana Padr√£o">Cabana Padr√£o</option>';

              itens.filter(i => i.categoria === 'padrao').forEach(item => {
                  divPersonalizacao.innerHTML += `<label class="item-card flex items-center gap-3 cursor-pointer bg-slate-50 p-3 rounded-xl border border-slate-100 hover:border-brand-pink/30 transition-colors"><input type="checkbox" value="${item.descricao}" checked onchange="atualizarSimulador()" class="chk-padrao custom-checkbox w-5 h-5 text-brand-pink"><span class="text-sm font-bold text-slate-600">${item.descricao}</span></label>`;
              });
              itens.filter(i => i.categoria === 'alimentacao').forEach(item => {
                  divAlimentacao.innerHTML += `<label class="item-card flex items-center gap-3 cursor-pointer bg-slate-50 p-3 rounded-xl border border-slate-100 hover:border-brand-pink/30 transition-colors"><input type="checkbox" value="${item.descricao}" class="chk-alim custom-checkbox w-5 h-5 text-brand-pink"><span class="text-sm font-bold text-slate-600">${item.descricao}</span></label>`;
              });
              atualizarSimulador();
          } catch(e) { console.error("Erro API", e); }
      }
      window.addEventListener('load', carregarDadosAPI);
    </script>
  </body>
</html>