<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Semeador Visual de Depoimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="bg-slate-50 min-h-screen p-6 pb-32">
    <div class="max-w-5xl mx-auto space-y-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-slate-800">
            <a
              href="painel.html"
              class="text-slate-400 hover:text-pink-500 transition-colors"
              ><i data-lucide="arrow-left"></i></a
              >üå± Semeador Visual
          </h1>

          <p class="text-slate-500">
            Cole seu CSV, anexe as fotos e popule o banco.
          </p>
        </div>
        <div
          class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-xs font-mono border border-blue-200"
        >
          Formato CSV: Nome,Texto,Nota (1-5)
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
        <label class="block text-sm font-bold text-slate-700 mb-2"
          >1. Cole o CSV aqui:</label
        >
        <textarea
          id="csvInput"
          rows="5"
          class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none"
          placeholder="Exemplo:&#10;Maria Silva,Amei a festa!,5&#10;Jo√£o Souza,Muito bom.,4"
        ></textarea>
        <button
          onclick="gerarCards()"
          class="mt-4 bg-slate-800 text-white font-bold py-3 px-6 rounded-xl hover:bg-slate-700 transition-colors flex items-center gap-2"
        >
          <i data-lucide="layers"></i> 2. Gerar Cards de Edi√ß√£o
        </button>
      </div>

      <div id="lista-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <script>
      lucide.createIcons();
      const ADMIN_TOKEN = "Raposo88125442@@";

      function gerarCards() {
        const input = document.getElementById("csvInput").value.trim();
        const container = document.getElementById("lista-cards");
        container.innerHTML = ""; // Limpa anterior

        if (!input) return alert("Cole algum texto CSV primeiro.");

        const linhas = input.split("\n");

        linhas.forEach((linha, index) => {
          if (!linha.trim()) return;

          // Parser simples de CSV (considerando v√≠rgula como separador)
          // Se o texto tiver v√≠rgula, o ideal √© usar aspas no CSV, mas aqui vamos simplificar:
          // Divide apenas nas 2 primeiras v√≠rgulas para garantir Nome e Nota, o resto √© Texto.
          const partes = linha.split(",");
          if (partes.length < 2) return;

          const nome = partes[0].trim();
          // A nota √© o √∫ltimo elemento se for n√∫mero, sen√£o assume 5
          let nota = 5;
          let texto = "";

          const ultimo = partes[partes.length - 1].trim();
          if (!isNaN(ultimo) && ultimo.length === 1) {
            nota = parseInt(ultimo);
            texto = partes.slice(1, -1).join(",").trim().replace(/^"|"$/g, ""); // Remove aspas extras
          } else {
            texto = partes.slice(1).join(",").trim().replace(/^"|"$/g, "");
          }

          // Cria o HTML do Card
          const card = document.createElement("div");
          card.className =
            "bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow";
          card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-slate-100 rounded-full w-8 h-8 flex items-center justify-center font-bold text-slate-500 text-xs">#${index + 1}</div>
                        <input type="number" id="nota-${index}" value="${nota}" min="1" max="5" class="w-16 text-center border rounded p-1 text-sm font-bold text-yellow-500">
                    </div>

                    <div class="space-y-3 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome do Cliente</label>
                            <input type="text" id="nome-${index}" value="${nome}" class="w-full font-bold text-slate-800 border-b border-slate-200 focus:border-blue-500 outline-none pb-1 bg-transparent">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Depoimento</label>
                            <textarea id="texto-${index}" rows="3" class="w-full text-sm text-slate-600 border rounded p-2 focus:border-blue-500 outline-none resize-none">${texto}</textarea>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2">
                            <i data-lucide="image"></i> Anexar Fotos (M√°x 5)
                        </label>
                        <input type="file" id="fotos-${index}" multiple accept="image/*" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-pink/10 file:text-brand-pink hover:file:bg-brand-pink/20 cursor-pointer"/>
                    </div>

                    <button onclick="enviarCard(${index})" id="btn-${index}" class="w-full bg-brand-pink bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="upload-cloud"></i> Salvar no Banco
                    </button>
                `;
          container.appendChild(card);
        });
        lucide.createIcons();
      }

      async function enviarCard(idx) {
        const btn = document.getElementById(`btn-${idx}`);
        const nome = document.getElementById(`nome-${idx}`).value;
        const texto = document.getElementById(`texto-${idx}`).value;
        const nota = document.getElementById(`nota-${idx}`).value;
        const inputFotos = document.getElementById(`fotos-${idx}`);

        if (inputFotos.files.length === 0) {
          if (!confirm("‚ö†Ô∏è Enviar sem fotos?")) return;
        }

        btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> Enviando...`;
        btn.disabled = true;
        lucide.createIcons();

        const formData = new FormData();
        formData.append("nome", nome);
        formData.append("texto", texto);
        formData.append("nota", nota);

        // Adiciona m√∫ltiplas fotos
        for (let i = 0; i < inputFotos.files.length; i++) {
          formData.append("fotos", inputFotos.files[i]);
        }

        try {
          const res = await fetch("/api/admin/seed-review", {
            method: "POST",
            headers: { "x-admin-password": ADMIN_TOKEN },
            body: formData,
          });

          const data = await res.json();

          if (data.success) {
            btn.className =
              "w-full bg-slate-100 text-slate-400 font-bold py-3 rounded-xl flex items-center justify-center gap-2 cursor-not-allowed";
            btn.innerHTML = `<i data-lucide="check"></i> Salvo!`;
            // Opcional: Remover o card da tela para limpar a vis√£o
            // btn.closest('.bg-white').style.opacity = '0.5';
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          console.error(error);
          alert("Erro: " + error.message);
          btn.innerHTML = "Tentar Novamente";
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
